{"version":3,"file":"edit.js","sources":["uni_modules/uni-im/pages/group/notice/edit.vue"],"sourcesContent":["<template>\n\t<view class=\"group-notice-edit\">\n\t\t<text v-if=\"isWidescreen\" class=\"navigator\">\n\t\t\t{{where._id ? '编辑' : '新建'}}公告\n\t\t</text>\n\t\t<uni-im-editor class=\"editor\" ref=\"group-notice-editor\" @input=\"onEditorInput\" :enter-send=\"false\"></uni-im-editor>\n\t\t<view class=\"btns-box\">\n\t\t\t<!-- 取消 更新 发布 删除 -->\n\t\t\t<button class=\"btn\" @click=\"navigateBack\" type=\"default\">取消</button>\n\t\t\t<button class=\"btn\" @click=\"comfrom\" type=\"primary\" :disabled=\"! (where._id ? isUpdate : inputContent)\">{{where._id ? '更新' : '发布' }}</button>\n\t\t</view>\n\t</view>\n</template>\n\n<script>\nimport uniIm from '@/uni_modules/uni-im/sdk/index.js';\n\tconst dbJQL = uniCloud.databaseForJQL()\n\texport default {\n\t\tdata() {\n\t\t\treturn {\n\t\t\t\twhere: {\n\t\t\t\t\tgroup_id: ''\n\t\t\t\t},\n\t\t\t\timgSrcMap:{},\n\t\t\t\t// 文本框原始内容\n\t\t\t\tinputContent: '',\n\t\t\t\torginContent: '',\n\t\t\t}\n\t\t},\n\t\tcomputed: {\n\t\t\t...uniIm.mapState(['isWidescreen']),\n\t\t\tisUpdate(){\n\t\t\t\treturn this.inputContent != '' && JSON.stringify(this.inputContent) != JSON.stringify(this.orginContent)\n\t\t\t}\n\t\t},\n\t\tonLoad(param) {\n\t\t\tthis.$nextTick(() => {\n\t\t\t\tthis.load(param)\n\t\t\t})\n\t\t},\n\t\tmethods: {\n\t\t\tasync load(param,eventChannel) {\n\t\t\t\tthis.orginContent = ''\n\t\t\t\tthis.imgSrcMap = {}\n\t\t\t\tthis.inputContent = ''\n\t\t\t\t// console.log('eventChannel',eventChannel)\n\t\t\t\t\n\t\t\t\tif(this.isWidescreen) {\n\t\t\t\t\tthis.getOpenerEventChannel = ()=>{\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\temit: (name, data)=>{\n\t\t\t\t\t\t\t\teventChannel[name](data)\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tObject.assign(this.where, param)\n\t\t\t\t// console.log('where', this.where)\n\t\t\t\tif (this.where._id) {\n\t\t\t\t\tconst res = await dbJQL.collection('uni-im-group-notice').where(this.where).get()\n\t\t\t\t\t// console.log('res', res)\n\t\t\t\t\tconst content = res.data[0]?.content.body\n\t\t\t\t\tif(Array.isArray(content)){\n\t\t\t\t\t\tfor(let i = 0; i < content.length; i++){\n\t\t\t\t\t\t  if(content[i].name === \"img\" && content[i]?.attrs?.src.indexOf('qiniu://') === 0  ){\n\t\t\t\t\t\t    const src = await uniIm.utils.getTempFileURL(content[i].attrs.src)\n\t\t\t\t\t\t    this.imgSrcMap[src] = content[i].attrs.src\n\t\t\t\t\t\t    content[i].attrs.src = src\n\t\t\t\t\t\t  }\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t// console.error('6666666', this.$refs['group-notice-editor'])\n\t\t\t\t\t// console.log('content', content)\n\t\t\t\t\tthis.$refs['group-notice-editor'].callRmd('$setContent',content)\n\t\t\t\t}\n\t\t\t},\n\t\t\tasync comfrom() {\n\t\t\t\t// 确认发布\n\t\t\t\tuni.showLoading({mask: true})\n\t\t\t\tconst content = await\tthis.getNoticeContent()\n\t\t\t\tconst eventChannel = this.getOpenerEventChannel?.()\n\t\t\t\t// console.log('content',content)\n\t\t\t\tconst noticeCollection = dbJQL.collection('uni-im-group-notice')\n\t\t\t\ttry {\n\t\t\t\t\tif (this.where._id) {\n\t\t\t\t\t\t// 更新\n\t\t\t\t\t\tconst res = await noticeCollection.where(this.where).update({\n\t\t\t\t\t\t\tcontent\n\t\t\t\t\t\t})\n\t\t\t\t\t\tconsole.log('res', res,eventChannel)\n\t\t\t\t\t\teventChannel.emit('update', {\n\t\t\t\t\t\t\t_id: this.where._id,\n\t\t\t\t\t\t\tcontent\n\t\t\t\t\t\t})\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// 发布\n\t\t\t\t\t\tconst res = await noticeCollection.add({\n\t\t\t\t\t\t\tcontent,\n\t\t\t\t\t\t\tgroup_id: this.where.group_id,\n\t\t\t\t\t\t})\n\t\t\t\t\t\tconsole.log('res', res)\n\t\t\t\t\t\teventChannel.emit('add', {\n\t\t\t\t\t\t\t_id: res.id,\n\t\t\t\t\t\t\tcontent,\n\t\t\t\t\t\t\tgroup_id: this.where.group_id,\n\t\t\t\t\t\t\tuser_id: uniIm.currentUser._id,\n\t\t\t\t\t\t\tcreate_time: Date.now()\n\t\t\t\t\t\t})\n\t\t\t\t\t}\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconsole.error('e', e)\n\t\t\t\t\tuni.showToast({\n\t\t\t\t\t\ttitle: '操作失败',\n\t\t\t\t\t\ticon: 'none'\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t\tuni.hideLoading()\n\t\t\t\tthis.navigateBack()\n\t\t\t},\n\t\t\tnavigateBack() {\n\t\t\t\tif (this.isWidescreen) {\n\t\t\t\t\tthis.$emit('back')\n\t\t\t\t} else {\n\t\t\t\t\tuni.navigateBack()\n\t\t\t\t}\n\t\t\t},\n\t\t\tasync getNoticeContent() {\n\t\t\t  let msg = {\n\t\t\t    \"from_uid\": \"system\",\n\t\t\t    \"type\": \"text\",\n\t\t\t    \"body\": this.inputContent\n\t\t\t  }\n\t\t\t  if (typeof this.inputContent == 'object'){\n\t\t\t    msg = {\n\t\t\t      \"type\":\"rich-text\",\n\t\t\t      body: await this.inputContent.getHtmlArray().uploadImg()\n\t\t\t    }\n\t\t\t  }else{\n\t\t\t    // 把this.inputContent中的&nbsp;变成空格，再把头尾的空格去掉\n\t\t\t    this.inputContent = this.inputContent.replace(/&nbsp;/g, ' ').trim()\n\t\t\t  }\n\t\t\t  // console.log('msg',msg)\n\t\t\t\treturn msg\n\t\t\t},\n\t\t\tonEditorInput(e){\n\t\t\t  this.inputContent = e.value\n\t\t\t\tif(this.orginContent === ''){\n\t\t\t\t\tthis.orginContent = e.value\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n</script>\n\n<style lang=\"scss\">\n@import \"@/uni_modules/uni-im/common/baseStyle.scss\";\n.group-notice-edit {\n\tbackground-color: #FFF;\n\twidth: 100%;\n\toverflow: hidden;\n\t.navigator {\n\t\tpadding-top: 10px;\n\t\tfont-size: 16px;\n\t\ttext-align: center;\n\t}\n\t.editor {\n\t\tborder: 1px solid #eee;\n\t\tmargin: 10px;\n\t\tpadding: 10px;\n\t\t::v-deep {\n\t\t\t.uni-im-editor {\n\t\t\t\tmax-height: unset;\n\t\t\t\theight: 400px;\n\t\t\t\t-webkit-user-modify: read-write;\n\t\t\t}\n\t\t\timg {\n\t\t\t  max-width: 100% !important;\n\t\t\t}\n\t\t}\n\t}\n\t.btns-box {\n\t\tflex-direction: row;\n\t\tjustify-content: flex-end;\n\t\t.btn {\n\t\t\tmargin: 10px;\n\t\t\twidth: 100px;\n\t\t\tfont-size: 12px;\n\t\t}\n\t}\n}\n</style>"],"names":["uniCloud","uniIm","uni"],"mappings":"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"}