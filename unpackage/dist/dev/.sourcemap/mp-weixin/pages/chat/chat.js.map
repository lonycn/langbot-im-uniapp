{"version":3,"file":"chat.js","sources":["pages/chat/chat.vue","pages/chat/chat.vue?type=page"],"sourcesContent":["<template>\n\t<view class=\"chat-page\">\n\t\t<view class=\"chat-header\">\n\t\t\t<view class=\"title-area\">\n\t\t\t\t<text class=\"title\">LangBot 会话</text>\n\t\t\t\t<text class=\"subtitle\">会话ID：{{ convId }}</text>\n\t\t\t</view>\n\t\t\t<view class=\"status-area\">\n\t\t\t\t<text class=\"status-dot\" :class=\"connectionStatus\"></text>\n\t\t\t\t<text class=\"status-text\">{{ statusLabel }}</text>\n\t\t\t\t<button class=\"settings-btn\" size=\"mini\" @click=\"toggleSettings\">{{ settingsVisible ? '收起' : '设置' }}</button>\n\t\t\t</view>\n\t\t</view>\n\n\t\t<view v-if=\"settingsVisible\" class=\"settings-panel\">\n\t\t\t<view class=\"settings-row\">\n\t\t\t\t<text class=\"settings-label\">WS 地址</text>\n\t\t\t\t<input class=\"settings-input\" v-model=\"wsUrlInput\" placeholder=\"ws://127.0.0.1:8765\" />\n\t\t\t</view>\n\t\t\t<view class=\"settings-row\">\n\t\t\t\t<text class=\"settings-label\">HTTP 地址</text>\n\t\t\t\t<input class=\"settings-input\" v-model=\"httpUrlInput\" placeholder=\"http://127.0.0.1:8080\" />\n\t\t\t</view>\n\t\t\t<view class=\"settings-actions\">\n\t\t\t\t<button type=\"primary\" @click=\"applySettings\">保存并重连</button>\n\t\t\t</view>\n\t\t</view>\n\n\t\t<scroll-view scroll-y class=\"chat-body\" :scroll-with-animation=\"true\" :scroll-into-view=\"scrollAnchor\">\n\t\t\t<view class=\"message-list\">\n\t\t\t\t<view v-for=\"(msg, index) in messages\" :key=\"msg.id || index\" :id=\"`msg-${index}`\" class=\"message-row\" :class=\"msg.from\">\n\t\t\t\t\t<view v-if=\"msg.from === 'system'\" class=\"system-tip\">{{ msg.text }}</view>\n\t\t\t\t\t<MsgText v-else-if=\"msg.msg_type === 'text'\" :text=\"msg.text\" :from=\"msg.from\" />\n\t\t\t\t\t<MsgCard\n\t\t\t\t\t\tv-else-if=\"msg.msg_type === 'card'\"\n\t\t\t\t\t\t:card=\"msg.card\"\n\t\t\t\t\t\t:from=\"msg.from\"\n\t\t\t\t\t\t@action=\"handleCardAction\"\n\t\t\t\t\t\t@media=\"handleCardMediaEvent\"\n\t\t\t\t\t/>\n\t\t\t\t\t<MsgImage v-else-if=\"msg.msg_type === 'image'\" :image=\"msg.image\" :from=\"msg.from\" />\n\t\t\t\t\t<MsgAudio v-else-if=\"msg.msg_type === 'audio'\" :audio=\"msg.audio\" :from=\"msg.from\" />\n\t\t\t\t\t<MsgVideo v-else-if=\"msg.msg_type === 'video'\" :video=\"msg.video\" :from=\"msg.from\" />\n\t\t\t\t\t<MsgFile v-else-if=\"msg.msg_type === 'file'\" :file=\"msg.file\" :from=\"msg.from\" @open=\"handleFileOpen\" />\n\t\t\t\t\t<MsgWidget\n\t\t\t\t\t\tv-else-if=\"msg.msg_type === 'widget'\"\n\t\t\t\t\t\t:widget=\"msg.widget\"\n\t\t\t\t\t\t:from=\"msg.from\"\n\t\t\t\t\t\t@action=\"handleWidgetAction\"\n\t\t\t\t\t/>\n\t\t\t\t\t<MsgText v-else :text=\"fallbackText(msg)\" :from=\"msg.from\" />\n\t\t\t\t</view>\n\t\t\t</view>\n\t\t</scroll-view>\n\n\t\t<view v-if=\"systemTip\" class=\"system-status\">{{ systemTip }}</view>\n\n\t\t<view class=\"input-bar\">\n\t\t\t<input class=\"chat-input\" v-model=\"inputText\" placeholder=\"请输入消息，例如：报修单 R2025xxxx 状态？\" confirm-type=\"send\" @confirm=\"handleSend\" />\n\t\t\t<button class=\"send-btn\" type=\"primary\" @click=\"handleSend\" :disabled=\"!inputText.trim()\">发送</button>\n\t\t</view>\n\t</view>\n</template>\n\n<script setup>\nimport { ref, reactive, computed, onMounted, onBeforeUnmount, nextTick } from 'vue'\nimport MsgText from '@/components/MsgText.vue'\nimport MsgCard from '@/components/MsgCard.vue'\nimport MsgImage from '@/components/MsgImage.vue'\nimport MsgAudio from '@/components/MsgAudio.vue'\nimport MsgVideo from '@/components/MsgVideo.vue'\nimport MsgFile from '@/components/MsgFile.vue'\nimport MsgWidget from '@/components/MsgWidget.vue'\nimport { configureWS, connectWS, onWSMessage, sendWSMessage, closeWS } from '@/utils/langbot.ws.js'\nimport { configureHttp } from '@/utils/langbot.http.js'\nimport { getToken, setToken, getUserId, setUserId } from '@/utils/auth.js'\n\nconst HISTORY_STORAGE_KEY = 'langbot_chat_history'\nconst MAX_HISTORY_LENGTH = 100\n\nconst defaultWsURL = uni.getStorageSync('langbot_ws_url') || 'ws://127.0.0.1:8765'\nconst defaultHttpURL = uni.getStorageSync('langbot_http_base') || 'http://127.0.0.1:8080'\n\nconst config = reactive({\n\twsUrl: defaultWsURL,\n\thttpUrl: defaultHttpURL\n})\n\nconst wsUrlInput = ref(config.wsUrl)\nconst httpUrlInput = ref(config.httpUrl)\nconst settingsVisible = ref(false)\n\nconst userId = ref(getUserId() || `guest_${Date.now()}`)\nif (!getUserId()) {\n\tsetUserId(userId.value)\n}\nconst convId = ref('c_langbot')\n\nconst messages = ref([])\nconst inputText = ref('')\nconst systemTip = ref('')\nconst scrollAnchor = ref('')\nconst connectionStatus = ref('connecting')\nconst activeStreamId = ref(null)\n\nlet unsubscribeWS = null\n\nconst statusLabel = computed(() => {\n\tswitch (connectionStatus.value) {\n\t\tcase 'connected':\n\t\t\treturn '已连接'\n\t\tcase 'reconnecting':\n\t\t\treturn '重连中...'\n\t\tcase 'error':\n\t\t\treturn '连接异常'\n\t\tcase 'closed':\n\t\t\treturn '已断开'\n\t\tdefault:\n\t\t\treturn '连接中...'\n\t}\n})\n\nfunction loadHistory() {\n\ttry {\n\t\tconst raw = uni.getStorageSync(HISTORY_STORAGE_KEY)\n\t\tif (!raw) return\n\t\tconst data = typeof raw === 'string' ? JSON.parse(raw) : raw\n\t\tif (Array.isArray(data)) {\n\t\t\tmessages.value = data.map((item) => normalizeMessage(item))\n\t\t}\n\t} catch (error) {\n\t\tconsole.warn('[chat] load history failed', error)\n\t}\n}\n\nfunction persistHistory() {\n\ttry {\n\t\tconst snapshot = messages.value.slice(-MAX_HISTORY_LENGTH)\n\t\tuni.setStorageSync(HISTORY_STORAGE_KEY, JSON.stringify(snapshot))\n\t} catch (error) {\n\t\tconsole.warn('[chat] persist history failed', error)\n\t}\n}\n\nfunction normalizeMessage(payload = {}) {\n\treturn {\n\t\tid: payload.id || `msg-${Date.now()}`,\n\t\tfrom: payload.from || 'bot',\n\t\tmsg_type: payload.msg_type || 'text',\n\t\ttext: typeof payload.text === 'string' ? payload.text : '',\n\t\tcard: payload.card ?? null,\n\t\timage: payload.image ?? null,\n\t\taudio: payload.audio ?? null,\n\t\tvideo: payload.video ?? null,\n\t\tfile: payload.file ?? null,\n\t\twidget: payload.widget ?? null,\n\t\tmedia: payload.media ?? null,\n\t\tmeta: { ...(payload.meta || {}) },\n\t\tts: payload.ts || Date.now(),\n\t\tstreaming: !!payload.streaming\n\t}\n}\n\nfunction appendMessage(payload = {}) {\n\tconst record = normalizeMessage(payload)\n\tmessages.value.push(record)\n\ttrimMessages()\n\tpersistHistory()\n\tscrollToBottom()\n\treturn record.id\n}\n\nfunction updateMessage(id, patch = {}) {\n\tconst index = messages.value.findIndex((msg) => msg.id === id)\n\tconst base = index !== -1 ? messages.value[index] : normalizeMessage({ id })\n\tconst merged = normalizeMessage({\n\t\t...base,\n\t\t...patch,\n\t\tcard: patch.card !== undefined ? patch.card : base.card,\n\t\timage: patch.image !== undefined ? patch.image : base.image,\n\t\taudio: patch.audio !== undefined ? patch.audio : base.audio,\n\t\tvideo: patch.video !== undefined ? patch.video : base.video,\n\t\tfile: patch.file !== undefined ? patch.file : base.file,\n\t\twidget: patch.widget !== undefined ? patch.widget : base.widget,\n\t\tmedia: patch.media !== undefined ? patch.media : base.media,\n\t\tmeta: { ...(base.meta || {}), ...(patch.meta || {}) },\n\t\tts: patch.ts || base.ts,\n\t\tstreaming: patch.streaming !== undefined ? !!patch.streaming : base.streaming\n\t})\n\n\tif (index === -1) {\n\t\tmessages.value.push(merged)\n\t} else {\n\t\tmessages.value.splice(index, 1, merged)\n\t}\n\ttrimMessages()\n\tpersistHistory()\n\tscrollToBottom()\n\treturn merged\n}\n\nfunction trimMessages() {\n\tif (messages.value.length > MAX_HISTORY_LENGTH) {\n\t\tconst overflow = messages.value.length - MAX_HISTORY_LENGTH\n\t\tmessages.value.splice(0, overflow)\n\t}\n}\n\nfunction scrollToBottom() {\n\tnextTick(() => {\n\t\tscrollAnchor.value = `msg-${messages.value.length - 1}`\n\t})\n}\n\nfunction initNetwork() {\n\tconfigureHttp({\n\t\tbaseURL: config.httpUrl,\n\t\tgetAuthToken: getToken\n\t})\n\n\tconfigureWS({\n\t\turl: config.wsUrl,\n\t\tuserId: userId.value,\n\t\tconvId: convId.value,\n\t\tgetAuthToken: getToken,\n\t\tonOpen: () => {\n\t\t\tactiveStreamId.value = null\n\t\t\tsystemTip.value = '已连接 LangBot Adapter'\n\t\t},\n\t\tonClose: () => {\n\t\t\tsystemTip.value = '连接断开，正在尝试重连...'\n\t\t},\n\t\tonError: () => {\n\t\t\tsystemTip.value = '连接异常，请检查配置或稍后再试'\n\t\t},\n\t\tonStatusChange: (status) => {\n\t\t\tconnectionStatus.value = status\n\t\t\tif (status === 'connecting') {\n\t\t\t\tsystemTip.value = '正在连接 LangBot Adapter...'\n\t\t\t} else if (status === 'reconnecting') {\n\t\t\t\tsystemTip.value = '连接断开，正在尝试重连...'\n\t\t\t} else if (status === 'closed') {\n\t\t\t\tsystemTip.value = '连接已关闭'\n\t\t\t}\n\t\t}\n\t})\n\n\tconnectWS()\n\n\tif (typeof unsubscribeWS === 'function') {\n\t\tunsubscribeWS()\n\t}\n\tunsubscribeWS = onWSMessage(handleWSMessage)\n}\n\nfunction handleWSMessage(message) {\n\tif (!message || typeof message !== 'object') {\n\t\treturn\n\t}\n\n\tswitch (message.type) {\n\t\tcase 'system':\n\t\t\thandleSystemMessage(message)\n\t\t\tbreak\n\t\tcase 'reply':\n\t\t\thandleBotReply(message)\n\t\t\tbreak\n\t\tcase 'error':\n\t\t\thandleErrorMessage(message)\n\t\t\tbreak\n\t\tdefault:\n\t\t\tappendMessage({\n\t\t\t\tid: `unknown-${Date.now()}`,\n\t\t\t\tfrom: 'bot',\n\t\t\t\tmsg_type: 'text',\n\t\t\t\ttext: JSON.stringify(message)\n\t\t\t})\n\t}\n}\n\nfunction handleSystemMessage(message) {\n\tif (message.text) {\n\t\tsystemTip.value = message.text\n\t}\n}\n\nfunction handleBotReply(message) {\n\tconst payload = message.payload || {}\n\tconst converted = normalizePayload(payload)\n\tif (converted.msg_type === 'widget') {\n\t\tconsole.log('[chat] widget payload', converted.widget, 'raw', message.payload)\n\t}\n\tconst topMeta = message.meta || {}\n\tconst combinedMeta = { ...(payload.meta || {}), ...(topMeta || {}) }\n\tconst isChunk = topMeta && topMeta.is_final === false\n\tconst baseData = {\n\t\tfrom: 'bot',\n\t\tmsg_type: converted.msg_type,\n\t\ttext: converted.text,\n\t\tcard: converted.card,\n\t\timage: converted.image,\n\t\taudio: converted.audio,\n\t\tvideo: converted.video,\n\t\tfile: converted.file,\n\t\twidget: converted.widget,\n\t\tmedia: converted.media,\n\t\tmeta: combinedMeta,\n\t\tts: message.server_ts || Date.now(),\n\t\tstreaming: isChunk\n\t}\n\n\tif (isChunk) {\n\t\tsystemTip.value = 'AI 正在回复...'\n\t\tif (!activeStreamId.value) {\n\t\t\tactiveStreamId.value = appendMessage({\n\t\t\t\t...baseData,\n\t\t\t\tid: `stream-${Date.now()}`\n\t\t\t})\n\t\t} else {\n\t\t\tupdateMessage(activeStreamId.value, baseData)\n\t\t}\n\t\treturn\n\t}\n\n\tif (activeStreamId.value) {\n\t\tupdateMessage(activeStreamId.value, { ...baseData, streaming: false })\n\t\tactiveStreamId.value = null\n\t\tsystemTip.value = ''\n\t\treturn\n\t}\n\n\tappendMessage({\n\t\t...baseData,\n\t\tid: `bot-${Date.now()}`\n\t})\n\tsystemTip.value = ''\n}\n\nfunction normalizePayload(payload = {}) {\n\tconst media = payload.media || null\n\tlet msgType = payload.msg_type\n\tif (!msgType) {\n\t\tif (payload.card) {\n\t\t\tmsgType = 'card'\n\t\t} else if (payload.image) {\n\t\t\tmsgType = 'image'\n\t\t} else if (payload.audio || media?.type === 'audio') {\n\t\t\tmsgType = 'audio'\n\t\t} else if (payload.video || media?.type === 'video') {\n\t\t\tmsgType = 'video'\n\t\t} else if (payload.file || media?.type === 'file') {\n\t\t\tmsgType = 'file'\n\t\t} else if (payload.widget) {\n\t\t\tmsgType = 'widget'\n\t\t} else {\n\t\t\tmsgType = 'text'\n\t\t}\n\t}\n\tconst resolvedAudio = payload.audio || (media?.type === 'audio' ? media : null)\n\tconst resolvedVideo = payload.video || (media?.type === 'video' ? media : null)\n\tconst resolvedFile = payload.file || (media?.type === 'file' ? media : null)\n\treturn {\n\t\tmsg_type: msgType,\n\t\ttext: payload.text || '',\n\t\tcard: payload.card || null,\n\t\timage: payload.image || null,\n\t\taudio: resolvedAudio,\n\t\tvideo: resolvedVideo,\n\t\tfile: resolvedFile,\n\t\twidget: payload.widget || null,\n\t\tmedia\n\t}\n}\n\nfunction handleErrorMessage(message) {\n\tconst errorText = message.message || message.text || '系统错误'\n\tsystemTip.value = errorText\n\tappendMessage({\n\t\tid: `error-${Date.now()}`,\n\t\tfrom: 'system',\n\t\tmsg_type: 'text',\n\t\ttext: `错误：${errorText}`\n\t})\n}\n\nfunction sendUserTextMessage(text) {\n\tconst trimmed = text.trim()\n\tif (!trimmed) {\n\t\treturn\n\t}\n\n\tappendMessage({\n\t\tid: `me-${Date.now()}`,\n\t\tfrom: 'me',\n\t\tmsg_type: 'text',\n\t\ttext: trimmed,\n\t\tts: Date.now()\n\t})\n\n\tsendWSMessage({\n\t\ttype: 'message',\n\t\tclient_ts: Date.now(),\n\t\tuser_id: userId.value,\n\t\tconv_id: convId.value,\n\t\tpayload: {\n\t\t\tmsg_type: 'text',\n\t\t\ttext: trimmed\n\t\t}\n\t})\n}\n\nfunction handleSend() {\n\tconst text = inputText.value\n\tsendUserTextMessage(text)\n\tinputText.value = ''\n}\n\nfunction handleCardAction(action) {\n\tif (!action || typeof action !== 'object') {\n\t\treturn\n\t}\n\tswitch (action.type) {\n\t\tcase 'postback':\n\t\tcase 'reply':\n\t\t\tsendPostbackAction(action)\n\t\t\tbreak\n\t\tcase 'submit_form':\n\t\t\tsystemTip.value = action.text ? `请填写表单：${action.text}` : '表单提交流程待实现'\n\t\t\temitActionMessage(action, { note: 'form_submit_requested' })\n\t\t\tbreak\n\t\tcase 'interrupt':\n\t\t\tsendInterrupt()\n\t\t\tbreak\n\t\tdefault:\n\t\t\temitActionMessage(action)\n\t}\n}\n\nfunction handleWidgetAction(action) {\n\thandleCardAction(action)\n}\n\nfunction handleCardMediaEvent(event) {\n\tif (!event) return\n\tconsole.debug('[chat] card media event', event)\n}\n\nfunction handleFileOpen(file) {\n\tconsole.debug('[chat] file open', file)\n}\n\nfunction sendPostbackAction(action) {\n\tlet replyText = ''\n\tif (typeof action.value === 'string') {\n\t\treplyText = action.value\n\t} else if (action.value && typeof action.value === 'object' && typeof action.value.text === 'string') {\n\t\treplyText = action.value.text\n\t} else if (action.payload && typeof action.payload.text === 'string') {\n\t\treplyText = action.payload.text\n\t} else if (typeof action.text === 'string') {\n\t\treplyText = action.text\n\t}\n\tif (replyText) {\n\t\tappendMessage({\n\t\t\tid: `me-${Date.now()}`,\n\t\t\tfrom: 'me',\n\t\t\tmsg_type: 'text',\n\t\t\ttext: replyText,\n\t\t\tmeta: { action }\n\t\t})\n\t}\n\temitActionMessage(action, { user_text: replyText })\n\tsystemTip.value = action.text ? `已选择：${action.text}` : ''\n}\n\nfunction emitActionMessage(action, extraMeta = {}) {\n\tsendWSMessage({\n\t\ttype: 'message',\n\t\tclient_ts: Date.now(),\n\t\tuser_id: userId.value,\n\t\tconv_id: convId.value,\n\t\tpayload: {\n\t\t\tmsg_type: 'postback',\n\t\t\ttext: action.text || `[${action.type}]`,\n\t\t\tmeta: {\n\t\t\t\taction,\n\t\t\t\t...extraMeta\n\t\t\t}\n\t\t}\n\t})\n}\n\nfunction sendInterrupt() {\n\tsendWSMessage({\n\t\ttype: 'interrupt',\n\t\tclient_ts: Date.now(),\n\t\tuser_id: userId.value,\n\t\tconv_id: convId.value\n\t})\n\tsystemTip.value = '已发送打断请求'\n}\n\nfunction fallbackText(msg) {\n\tif (!msg) return ''\n\tif (msg.text) return msg.text\n\treturn JSON.stringify(msg)\n}\n\nfunction toggleSettings() {\n\tsettingsVisible.value = !settingsVisible.value\n}\n\nfunction applySettings() {\n\tconfig.wsUrl = wsUrlInput.value.trim()\n\tconfig.httpUrl = httpUrlInput.value.trim()\n\tuni.setStorageSync('langbot_ws_url', config.wsUrl)\n\tuni.setStorageSync('langbot_http_base', config.httpUrl)\n\n\tcloseWS()\n\tinitNetwork()\n\tsettingsVisible.value = false\n\tsystemTip.value = '连接已刷新'\n}\n\nonMounted(() => {\n\tconst token = getToken()\n\tif (!token) {\n\t\tsetToken('')\n\t}\n\tloadHistory()\n\tinitNetwork()\n\tscrollToBottom()\n})\n\nonBeforeUnmount(() => {\n\tif (typeof unsubscribeWS === 'function') {\n\t\tunsubscribeWS()\n\t}\n\tcloseWS()\n})\n</script>\n\n<style scoped>\n.chat-page {\n\tmin-height: 100vh;\n\tdisplay: flex;\n\tflex-direction: column;\n\tbackground-color: #f4f6fb;\n\tpadding: 0 20rpx 30rpx;\n\tbox-sizing: border-box;\n}\n\n.chat-header {\n\tdisplay: flex;\n\talign-items: center;\n\tjustify-content: space-between;\n\tpadding: 20rpx 0;\n}\n\n.title-area {\n\tdisplay: flex;\n\tflex-direction: column;\n}\n\n.title {\n\tfont-size: 34rpx;\n\tfont-weight: 600;\n\tcolor: #1e272e;\n}\n\n.subtitle {\n\tmargin-top: 6rpx;\n\tfont-size: 24rpx;\n\tcolor: #808e9b;\n}\n\n.status-area {\n\tdisplay: flex;\n\talign-items: center;\n\tgap: 12rpx;\n}\n\n.status-dot {\n\twidth: 14rpx;\n\theight: 14rpx;\n\tborder-radius: 50%;\n\tbackground-color: #ffa502;\n}\n\n.status-dot.connected {\n\tbackground-color: #2ed573;\n}\n\n.status-dot.reconnecting {\n\tbackground-color: #ffa502;\n}\n\n.status-text {\n\tfont-size: 24rpx;\n\tcolor: #57606f;\n}\n\n.settings-btn {\n\tfont-size: 24rpx;\n}\n\n.settings-panel {\n\tbackground-color: #ffffff;\n\tborder-radius: 16rpx;\n\tpadding: 20rpx;\n\tmargin-bottom: 16rpx;\n\tbox-shadow: 0 8rpx 20rpx rgba(0, 0, 0, 0.05);\n\tdisplay: flex;\n\tflex-direction: column;\n\tgap: 16rpx;\n}\n\n.settings-row {\n\tdisplay: flex;\n\tflex-direction: column;\n\tgap: 10rpx;\n}\n\n.settings-label {\n\tfont-size: 24rpx;\n\tcolor: #57606f;\n}\n\n.settings-input {\n\tpadding: 12rpx 18rpx;\n\tborder-radius: 10rpx;\n\tbackground-color: #f1f2f6;\n\tfont-size: 26rpx;\n}\n\n.settings-actions {\n\tdisplay: flex;\n\tjustify-content: flex-end;\n}\n\n.chat-body {\n\tflex: 1;\n\tbackground-color: #ffffff;\n\tborder-radius: 20rpx;\n\tpadding: 20rpx;\n\tbox-sizing: border-box;\n\toverflow: hidden;\n}\n\n.message-list {\n\tdisplay: flex;\n\tflex-direction: column;\n\tgap: 8rpx;\n}\n\n.message-row {\n\tdisplay: flex;\n}\n\n.message-row.me {\n\tjustify-content: flex-end;\n}\n\n.message-row.bot {\n\tjustify-content: flex-start;\n}\n\n.system-tip {\n\talign-self: center;\n\tfont-size: 24rpx;\n\tcolor: #a4b0be;\n\tpadding: 8rpx 14rpx;\n\tbackground-color: rgba(164, 176, 190, 0.2);\n\tborder-radius: 20rpx;\n}\n\n.system-status {\n\tfont-size: 22rpx;\n\tcolor: #a4b0be;\n\ttext-align: center;\n\tmargin: 12rpx 0;\n}\n\n.input-bar {\n\tmargin-top: 16rpx;\n\tdisplay: flex;\n\talign-items: center;\n\tgap: 12rpx;\n}\n\n.chat-input {\n\tflex: 1;\n\tbackground-color: #ffffff;\n\tborder-radius: 999px;\n\tpadding: 18rpx 26rpx;\n\tfont-size: 28rpx;\n\tbox-shadow: 0 6rpx 16rpx rgba(0, 0, 0, 0.06);\n}\n\n.send-btn {\n\tpadding: 0 36rpx;\n\tborder-radius: 999px;\n\theight: 80rpx;\n\tline-height: 80rpx;\n\tfont-size: 28rpx;\n}\n</style>\n","import MiniProgramPage from '/Users/orange/aicode/langbot/web_client/langbot-im-uniapp/pages/chat/chat.vue'\nwx.createPage(MiniProgramPage)"],"names":["uni","reactive","ref","getUserId","setUserId","computed","nextTick","configureHttp","getToken","configureWS","connectWS","onWSMessage","sendWSMessage","closeWS","onMounted","setToken","onBeforeUnmount"],"mappings":"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"}