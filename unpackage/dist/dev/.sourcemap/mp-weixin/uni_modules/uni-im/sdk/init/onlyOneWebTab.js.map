{"version":3,"file":"onlyOneWebTab.js","sources":["uni_modules/uni-im/sdk/init/onlyOneWebTab.js"],"sourcesContent":["import $state from '@/uni_modules/uni-im/sdk/state/index.js';\n\nexport default () => {\n  // console.log('onlyOneWebTab');\n  if (!('BroadcastChannel' in window)) {\n    return console.info('当前浏览器不支持BroadcastChannel')\n  }\n  const bc = new BroadcastChannel('uni-im-onlyOneWebTab');\n  // 发送消息\n  const msg = 'Is there any other IM window available' + \" msgId:\" + Math.random().toString(36).substring(7).padStart(12, '0');\n  bc.postMessage(msg);\n  // 接收消息\n  bc.onmessage = (ev) => {\n    // console.log(ev.data)\n    if (ev.data.indexOf('Is there any other IM window available') === 0) {\n      bc.postMessage('yes,about' + ev.data);\n    } else if (ev.data === 'yes,about' + msg) {\n      console.log('收到响应，说明当前浏览器其他选项卡已打开uni-im。通知其他关闭');\n      bc.postMessage(\"please close\");\n    } else if (ev.data === \"please close\") {\n      $state.indexDB.close();\n      $state.isDisabled = true;\n\n      setTimeout(() => {\n        document.title = \"uni-im（已掉线）\";\n      }, 1000);\n\n      // 弹窗提示，其他选项卡已打开uni-im，当前页面已失效，点击重新打开\n      uni.showModal({\n        title: '掉线提醒',\n        content: '已在其他页面发起会话，当前页面已掉线',\n        showCancel: false,\n        confirmText: '重新连接',\n        success: async res=>{\n          if (res.confirm) {\n            // console.log('用户点击确定');\n            // 点击确定，发送消息，其他选项卡关闭uni-im\n            bc.postMessage(\"please close\");\n            // 刷新当前页面\n            location.reload();\n          }\n        },\n        fail: function(res) {\n          console.log(res.errMsg);\n        },\n      });\n\n    }\n  };\n\n  // Close the channel\n  // bc.close();\n}"],"names":["uni","$state"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;AAEA,MAAA,gBAAe,MAAM;AAEnB,MAAI,EAAE,sBAAsB,SAAS;AACnC,WAAOA,uFAAa,0BAA0B;AAAA,EAC/C;AACD,QAAM,KAAK,IAAI,iBAAiB,sBAAsB;AAEtD,QAAM,MAAM,kDAAuD,KAAK,OAAQ,EAAC,SAAS,EAAE,EAAE,UAAU,CAAC,EAAE,SAAS,IAAI,GAAG;AAC3H,KAAG,YAAY,GAAG;AAElB,KAAG,YAAY,CAAC,OAAO;AAErB,QAAI,GAAG,KAAK,QAAQ,wCAAwC,MAAM,GAAG;AACnE,SAAG,YAAY,cAAc,GAAG,IAAI;AAAA,IACrC,WAAU,GAAG,SAAS,cAAc,KAAK;AACxCA,oBAAAA,MAAA,MAAA,OAAA,sDAAY,mCAAmC;AAC/C,SAAG,YAAY,cAAc;AAAA,IACnC,WAAe,GAAG,SAAS,gBAAgB;AACrCC,8CAAO,QAAQ;AACfA,wCAAM,MAAC,aAAa;AAEpB,iBAAW,MAAM;AACf,iBAAS,QAAQ;AAAA,MAClB,GAAE,GAAI;AAGPD,oBAAAA,MAAI,UAAU;AAAA,QACZ,OAAO;AAAA,QACP,SAAS;AAAA,QACT,YAAY;AAAA,QACZ,aAAa;AAAA,QACb,SAAS,CAAM,QAAK;AAClB,cAAI,IAAI,SAAS;AAGf,eAAG,YAAY,cAAc;AAE7B,qBAAS,OAAM;AAAA,UAChB;AAAA,QACF;AAAA,QACD,MAAM,SAAS,KAAK;AAClBA,wBAAA,MAAA,MAAA,OAAA,sDAAY,IAAI,MAAM;AAAA,QACvB;AAAA,MACT,CAAO;AAAA,IAEF;AAAA,EACL;AAIA;;"}