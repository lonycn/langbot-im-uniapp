{"version":3,"file":"imData.js","sources":["uni_modules/uni-im/sdk/init/imData.js"],"sourcesContent":["import getCloudMsg from './getCloudMsg.js';\nimport $state from '@/uni_modules/uni-im/sdk/state/index.js';\nimport $methods from '@/uni_modules/uni-im/sdk/methods/index.js';\nimport clearData from './clearData'\n\nconst imData = {\n  onInitAfter(callback){\n    if ($state.ext._initImData.isInit) {\n      callback()\n    } else {\n      // nvue下跨页面的数据不能共享，所以_initImData.callbackList需要挂到$state下\n      $state.ext._initImData.callbackList.push(callback)\n    }\n  },\n  async init() {\n\t\t// 初始化之前先将旧的清空，解决不调用退出登录直接直达登录页面换账号的情况\n\t\tclearData()\n    // console.log('初始化数据 data');\n    let storageConversationList = []\n    \n    // #ifdef H5\n    storageConversationList = []\n    \n    // 暂时关闭本地库相关逻辑\n    // await new Promise((resolve, reject) => {\n    //   let requst = $state.indexDB.transaction(\"uni-im-convasation\")\n    //     .objectStore(\"uni-im-convasation\")\n    //     .getAll()\n    //   requst.onsuccess = function (event) {\n    //     resolve(event.target.result)\n    //   }\n    //   requst.onerror = function (event) {\n    //     console.error('获取本地会话列表失败', event)\n    //     resolve([])\n    //   }\n    // })\n    // #endif\n    \n    \n    if (storageConversationList.length) {\n      $state.conversation.add(storageConversationList)\n    }\n    // getCloudMsg({\n    //   showLoading: \"加载中\",\n    //   async callback(){\n    //     /*console.log('启动后通过getCloudMsg拉取了会话数据，和直接云端全量拉做对比');\n    //     let localConversations = [...$state.conversation.dataList]\n    //     let localLength = localConversations.length\n    //     const uniImCo = uniCloud.importObject(\"uni-im-co\",{\n    //       customUI:true\n    //     })\n    //     uniImCo.getConversationList({\n    //       limit: 30\n    //     }).then(res => {\n    //       // console.log('拉取了云端会话数据', res.data);\n    //       // 取30个对比\n    //       // console.log('本地会话数据', localConversations);\n    //       let newConversations = res.data\n    //       function tr(arr){\n    //         arr = arr\n    //           .map(({update_time,id,group_info,user_info}) => {\n    //             let item = {\n    //               update_time,\n    //               id\n    //             }\n    //             if(group_info){\n    //               const {name,type} = group_info\n    //               item.group = {name,type}\n    //             }\n    //             if(user_info){\n    //               const {nickname} = user_info\n    //               item.user_info = {nickname}\n    //             }\n    //             return item\n    //           })\n    //           .sort((a, b) => b.update_time - a.update_time)\n    //           // 去重id相等的去掉\n    //         let tmpObj = {}\n    //         arr.forEach(item => {\n    //           tmpObj[item.id] = item\n    //         })\n    //         arr = Object.values(tmpObj)\n    //         arr = arr.slice(0, localLength > 20 ? 20 : localLength)\n    //         console.log('arr.length', arr.length,arr);\n    //         return JSON.stringify(arr)\n    //       }\n          \n    //       localConversations = tr(localConversations)\n    //       newConversations = tr(newConversations)\n          \n    //       // console.log('localConversations', localConversations.length, localConversations);\n    //       // console.log('newConversations', newConversations.length, newConversations);\n    //       if (localConversations === newConversations) {\n    //         console.log('会话数据一致，无需更新');\n    //       }else{\n    //         console.error('会话数据不一致，需要更新');\n    //         // 把不一致的项console.log出来\n    //         let local = JSON.parse(localConversations)\n    //         let newC = JSON.parse(newConversations)\n    //         local.forEach((item, index) => {\n    //           // 缺少的项\n    //           if (!newC.find(i => i.id === item.id)) {\n    //             console.error('缺少的项', item);\n    //           }\n    //         })\n    //         newC.forEach((item, index) => {\n    //           // 多余的项\n    //           if (!local.find(i => i.id === item.id)) {\n    //             console.error('多余的项', item);\n    //           }\n    //         })\n    //         $state.conversation.dataList = []\n    //         res.data.forEach(item => {\n    //           $state.conversation.add(item)\n    //         })\n    //       }\n    //     })\n    //     .catch(err => {\n    //       console.error('拉取会话数据失败', err);\n    //     })*/\n        \n        // 初始化完成\n        $state.ext._initImData.isInit = true\n        $state.ext._initImData.callbackList.forEach(fn => {\n          // console.error(' 初始化成功后执行',$state.ext._initImData.isInit);\n          fn();\n        })\n        \n    //   }\n    // })\n    \n    \n    $state.notification.loadMore()\n    $state.friend.loadMore()\n    $state.group.loadMore()\n\t\tconst user_id = $state.currentUser._id\n\t\tif(user_id){\n\t\t\t$state.users.merge({\n\t\t\t\t[user_id]: $state.currentUser\n\t\t\t})\n\t\t}\n\t\tconst db = uniCloud.databaseForJQL()\n\t\tdb.collection('uni-im-user-alias')\n\t\t\t.where(\"user_id == $cloudEnv_uid\")\n\t\t\t.limit(1000)\n\t\t\t.get()\n\t\t\t.then(res => {\n\t\t\t\t// console.log('获取用户别名成功', res.data);\n\t\t\t\t$state.userAlias = res.data.reduce((aliasMap, item) => {\n          aliasMap[item.target_uid] = item.content\n          return aliasMap\n        }, {})\n\t\t\t})\n\t\t\t.catch(err => {\n\t\t\t\tconsole.error('获取用户别名失败', err);\n\t\t\t})\n  }\n}\n\n// 将数据初始化完成事件，挂到 sdk 下\n$methods.onInitDataAfter = imData.onInitAfter\n\nexport default imData"],"names":["$state","clearData","uniCloud","uni","$methods"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;AAKK,MAAC,SAAS;AAAA,EACb,YAAY,UAAS;AACnB,QAAIA,wCAAO,IAAI,YAAY,QAAQ;AACjC,eAAU;AAAA,IAChB,OAAW;AAELA,wCAAAA,MAAO,IAAI,YAAY,aAAa,KAAK,QAAQ;AAAA,IAClD;AAAA,EACF;AAAA,EACK,OAAO;AAAA;AAEbC,qDAAW;AAET,UAAI,0BAA0B,CAAE;AAqBhC,UAAI,wBAAwB,QAAQ;AAClCD,gDAAO,aAAa,IAAI,uBAAuB;AAAA,MAChD;AAiFGA,wCAAAA,MAAO,IAAI,YAAY,SAAS;AAChCA,wCAAAA,MAAO,IAAI,YAAY,aAAa,QAAQ,QAAM;AAEhD;MACV,CAAS;AAMLA,wCAAM,MAAC,aAAa,SAAU;AAC9BA,wCAAM,MAAC,OAAO,SAAU;AACxBA,wCAAM,MAAC,MAAM,SAAU;AACzB,YAAM,UAAUA,wCAAO,YAAY;AACnC,UAAG,SAAQ;AACVA,0CAAM,MAAC,MAAM,MAAM;AAAA,UAClB,CAAC,OAAO,GAAGA,kCAAAA,MAAO;AAAA,QACtB,CAAI;AAAA,MACD;AACD,YAAM,KAAKE,cAAQ,GAAC,eAAgB;AACpC,SAAG,WAAW,mBAAmB,EAC/B,MAAM,0BAA0B,EAChC,MAAM,GAAI,EACV,IAAK,EACL,KAAK,SAAO;AAEZF,0CAAM,MAAC,YAAY,IAAI,KAAK,OAAO,CAAC,UAAU,SAAS;AACjD,mBAAS,KAAK,UAAU,IAAI,KAAK;AACjC,iBAAO;AAAA,QACR,GAAE,EAAE;AAAA,MACb,CAAI,EACA,MAAM,SAAO;AACbG,sBAAA,MAAA,MAAA,SAAA,gDAAc,YAAY,GAAG;AAAA,MACjC,CAAI;AAAA,IACD;AAAA;AACH;AAGAC,oCAAAA,QAAS,kBAAkB,OAAO;;"}