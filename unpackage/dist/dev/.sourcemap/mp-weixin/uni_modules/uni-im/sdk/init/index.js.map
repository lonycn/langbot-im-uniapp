{"version":3,"file":"index.js","sources":["uni_modules/uni-im/sdk/init/index.js"],"sourcesContent":["import config from '@/uni_modules/uni-im/common/config.js';\nimport $state from '@/uni_modules/uni-im/sdk/state/index.js';\nimport $methods from '@/uni_modules/uni-im/sdk/methods/index.js';\nimport $ext from '@/uni_modules/uni-im/sdk/ext/index.js';\nimport {init as initIndexDB} from '@/uni_modules/uni-im/sdk/ext/indexDB.js';\nimport $utils from '@/uni_modules/uni-im/sdk/utils';\n\nimport checkVersion from './checkVersion'\nimport onAppActivateStateChange from './onAppActivateStateChange'\nimport onNotification from './onNotification';\n\nimport clearData from './clearData'\nimport msgEvent from './msgEvent'\nimport getCloudMsg from './getCloudMsg'\nimport onSocketStateChange from './onSocketStateChange'\nimport imData from './imData'\nimport onlyOneWebTab from './onlyOneWebTab'\n\n\n// #ifdef APP\n// import sqlite from './sqlite.js'\n// #endif\n\nconst modules = {\n  checkVersion,\n  onAppActivateStateChange,\n  clearData,\n  msgEvent,\n  getCloudMsg,\n  onSocketStateChange,\n  imData,\n  onlyOneWebTab,\n  onNotification\n};\n\n\n// console.log('modules', modules);\n\nconst version = '3.0.0';\n\nexport default async function (initParam) {\n  // console.log('initParam:', initParam, this)\n  // 检查当前客户端版本号，如果低于最新版本，App端提示升级。其他端需要做本地数据的清洗\n  modules.checkVersion(version);\n\n  // 注册（扩展的）消息类型\n  $methods.msgTypes.registerTypes()\n\n    \n  // #ifdef H5\n  // 限制 im 在浏览器内只能由一个页签打开\n  modules.onlyOneWebTab();\n  try {\n    // 初始化 indexDB （如果版本号不一致会自动清空过期数据）\n    const initIndexDBRes = await initIndexDB(version);\n    $state.indexDB = initIndexDBRes.target.result;\n  } catch (e) {\n    console.error(e)\n    uni.showModal({\n      content: JSON.stringify(e),\n      showCancel: false\n    });\n  }\n  \n  // 监听所有错误并上报\n  window.addEventListener('error', function(e) {\n    console.error('监听所有错误并准备上报 error', e)\n    $utils.reportError(e.error)\n  });\n  \n  $state.networkConnected = navigator.onLine;\n  window.addEventListener('online', function() {\n    $state.networkConnected = true;\n    console.log('网络已连接');\n  });\n  window.addEventListener('offline', function() {\n    $state.networkConnected = false;\n    console.log('网络已断开');\n  });\n  // #endif\n  \n  // #ifndef H5\n  // uni.onNetworkStatusChange(({\n  // \tnetworkType\n  // }) => {\n  // \tif (this.networkType == 'none' && networkType != 'none') { //之前没网现在有了\n  // \t\tthis.$emit('networkResume')\n  // \t}\n  // \tthis.networkType = networkType;\n  // });\n  // uni.getNetworkType({\n  // \tsuccess: ({\n  // \t\tnetworkType\n  // \t}) => {\n  // \t\tthis.networkType = networkType;\n  // \t}\n  // });\n  // #endif\n  \n  \n  // 如果已经登录就直接初始化数据\n  if ($state.currentUser.tokenExpired > Date.now()) {\n    await modules.imData.init()\n  } else {\n    console.log(\"登录状态过期，暂不初始化数据\");\n  }\n  // 登录成功后 初始化数据\n  uni.$on('uni-id-pages-login-success', async () => {\n    console.log(\"登录成功，开始初始化数据\");\n    modules.imData.init()\n  });\n  \n  modules.imData.onInitAfter(() => {\n    //初始化完毕后\n    // 读取 云端{\"未读会话id\":未读数}的数据\n\t\tconst uniImCo = uniCloud.importObject(\"uni-im-co\")\n\t\tuniImCo.getUnreadCount()\n      .then(({data}) => {\n        // console.log('读取云端未读会话数据', data)\n\t\t\t\t$state.conversation.cloudUnreadCountObj = data.unreadCountObj\n      })\n      .catch(e => {\n        console.error('读取云端未读会话数据失败', e)\n        // uni.showModal({\n        //   content: '读取云端未读会话数据失败' + JSON.stringify(e),\n        //   showCancel: false\n        // });\n      })\n\n    // 移除监听，避免重复监听\n    uni.offPushMessage(onPushMsg)\n    // 监听推送消息\n    uni.onPushMessage(onPushMsg)\n  })\n  function onPushMsg(res){\n    // console.log('uni_on_PushMessage', res.data.payload);\n    switch (res.data.payload.type) {\n      case \"uni-im\":\n        modules.msgEvent.emitMsg(res)\n        break;\n      case \"uni-im-notification\":\n        modules.onNotification(res) //添加好友相关模块，暂不维护\n        break;\n      default:\n        break;\n    }\n  }\n\n  // 监听并记录socket连接状态\n  modules.onSocketStateChange((state, count) => {\n    this.socketConnectState = state;\n    if (count > 1) {\n      // 大于1，说明是断开后重连；获取socket断开时丢失的数据\n      modules.getCloudMsg()\n    }\n  });\n  // console.log('this.socketConnectState', this.socketConnectState);\n  \n  // 监听应用处于“活动状态”，并记录状态和变成活动状态的次数。\n  modules.onAppActivateStateChange((state, count) => {\n    this.appActivateState = state;\n    if (!state) return;\n    // #ifdef APP\n    this.socketConnectState = state;\n    if(!$state.ext._previewImageIsOpen){\n      //清理系统通知栏消息和app角标\n      plus.push.clear()\n      plus.runtime.setBadgeNumber(0)\n      // 查询一次缺失的云端消息\n      modules.getCloudMsg()\n    } else {\n      $state.ext._previewImageIsOpen = false\n    }\n    // #endif\n    \n    // 拿到当前页面的路由\n    const pages = getCurrentPages()\n    const currentPage = pages[pages.length - 1]\n    const isLoginPage = currentPage?.route.includes('uni_modules/uni-id-pages/pages/login')\n    \n    // 第二次 activate 之后开始 检查token是否已经过期，如果已经过期则重定向至登录页面\n    const { tokenExpired } = $state.currentUser\n    if (!currentPage?.options?.oauthToken && !isLoginPage && count > 1 && tokenExpired < Date.now()) {\n      console.info('uni-im检测到，当前用户登录过且当前登录状态已过期，将自动跳转至登录页面。')\n      uni.reLaunch({\n        url: '/uni_modules/uni-id-pages/pages/login/login-withpwd',\n        complete(e) {\n          console.log('uni.reLaunch to login page', e)\n        }\n      })\n    }\n  });\n\n  // 退出登录时，清空(归零)相关数据\n  uni.$on('uni-id-pages-logout', () => modules.clearData());\n  \n  $state.onMsg = modules.msgEvent.onMsg\n  $state.offMsg = modules.msgEvent.offMsg\n  \n  // #ifndef H5\n  // 提前拿到键盘高度，防止第一次在会话点击输入框时，输入框的高度弹起速度慢\n  $state.keyboardMaxHeight = uni.getStorageSync('uni-im-data-keyboard-max-height') || 0;\n  // console.log('键盘高度', $state.keyboardMaxHeight);\n  // if ($state.keyboardMaxHeight === 0) {\n  //   uni.onKeyboardHeightChange((e) => {\n  //     if (e.height > $state.keyboardMaxHeight) {\n  //       $state.keyboardMaxHeight = e.height;\n  //       uni.setStorageSync('uni-im-data-keyboard-max-height', e.height);\n  //       console.log('获取到键盘高度，并存储', e.height);\n  //     }\n  //   });\n  // }\n  // #endif\n\n  // #ifdef APP\n  // 初始化 本地数据库\n  // sqlite.init();\n  // 将sqlite对象存储到全局变量下\n  // getApp().globalData.sqlite = sqlite;\n  \n  // android 平台设置推送通道渠道id\n  if (uni.getSystemInfoSync().platform == \"android\") {\n    try{\n      const plugin = uni.requireNativePlugin(\"DCloud-PushSound\");\n      plugin.setCustomPushChannel(\n        {\n          // soundName: \"pushsound\",\n          channelId: config.uniPush.channel.id,\n          channelDesc: config.uniPush.channel.desc,\n          enableLights: true,\n          enableVibration: true,\n          importance: 4,\n          lockscreenVisibility: 1\n        }\n      );\n    }catch(e){\n      // console.error('android 平台设置推送通道渠道id',e);\n    }\n  }\n  // #endif\n\n  //时间戳心跳（定时器）用于刷新：消息或会话与当前的时间差。ps：全局共享一个定时器变量。比启多个定时器性能更好\n  setInterval(() => {\n    $state.heartbeat = Date.now();\n  }, 1000)\n\n  // 监听窗口变化\n  // #ifdef H5\n  function setIsWidescreen() {\n    let oldState = $state.isWidescreen\n    $state.isWidescreen = window.innerWidth > 960\n  }\n  window.addEventListener('resize',setIsWidescreen);\n  setIsWidescreen();\n  // #endif\n\n  const audioContext = uni.createInnerAudioContext()\n  let _audioContext = {}\n  Object.defineProperty(_audioContext, 'src', {\n    set(url) {\n      audioContext.src = url;\n    },\n    get() {\n      return audioContext.src;\n    }\n  })\n  $state.audioContext = new Proxy(_audioContext, {\n    get(target, propKey, receiver) {\n      return audioContext[propKey]\n    }\n  })\n  \n  // 获取系统信息\n  $state.systemInfo = uni.getSystemInfoSync()\n  // todo: 临时方案，为了解决部分老设备同步方法获取到的信息不准确的问题\n  uni.getSystemInfo({\n    success: (res) => {\n      $state.systemInfo = res;\n      // console.log('this.systemInfo',$state.systemInfo);\n    },\n    fail: (e) => {\n      console.error('获取系统信息失败', e);\n    }\n  });\n\n  // 检测屏幕特性\n  if ($state.systemInfo.deviceType === 'pc') {\n    // pc 只支持宽屏模式（会限制 page 的 min-width）\n    $state.isWidescreen = true\n    $state.isTouchable = false\n  } else {\n    // 其它设备类型由屏幕宽度来判定\n    $state.isWidescreen = $state.systemInfo.screenWidth >= 960\n    $state.isTouchable = true\n  }\n\n  // #ifdef H5\n  // 同步 键盘弹出/收起后，动态变化的窗口高度\n  window.addEventListener('resize', () => {\n    $state.systemInfo.windowHeight = window.innerHeight\n  })\n  // #endif\n\n  // 通过拦截器监听路由变化，解决在非tabbar页面，无法设置TabBarBadge的问题\n  let list = ['navigateTo', 'redirectTo', 'reLaunch', 'switchTab', 'navigateBack'];\n  list.forEach((item) => {\n    uni.addInterceptor(item, {\n      success: event => {\n        // 更新底部选项卡角标值\n        updateTabBarBadge()\n      }\n    })\n  })\n\n  // #ifdef MP-WEIXIN\n  // 微信的隐式API 监听路由变化\n  wx.onAppRoute((res) => {\n    // console.log('跳转', res)\n    // 更新底部选项卡角标值\n    updateTabBarBadge()\n  })\n  // #endif\n\n  // 更新底部选项卡角标值\n  function updateTabBarBadge() {\n    setTimeout(() => {\n      // console.log('updateTabBarBadge');\n      /**\n       * 默认每次路由发生变化都会更新updateTabBarBadge的值\n       * 你可以根据自己的项目情况优化，比如首页就是tabbar的可以判断getCurrentPages().length 的长度决定是否继续\n       */\n\n      let unread_count = $state.notification.unreadCount()\n      // console.log({unread_count});\n      $utils.setTabBarBadge(2, unread_count)\n\n      // 获取未读会话消息总数\n      unread_count = $state.conversation.unreadCount()\n      // console.log({unread_count});\n      $utils.setTabBarBadge(0, unread_count)\n      // 设置底部选项卡角标值\n    }, 300);\n  }\n\n  // #ifdef H5\n  uni.addInterceptor('switchTab', {\n    invoke: (e) => {\n      if (e.url.includes('/uni_modules/uni-im/pages/index/index')) {\n        if ($state.matches) {\n          let param = getUrlParam(e.url)\n          // console.log('param----',param);\n          if (param) {\n            uni.$emit('uni-im-toChat', param)\n          }\n        }\n      }\n    }\n  })\n\n  function getUrlParam(url) {\n    let u = url.split(\"?\");\n    if (typeof (u[1]) == \"string\") {\n      u = u[1].split(\"&\");\n      let get = {};\n      for (let i in u) {\n        let j = u[i].split(\"=\");\n        get[j[0]] = j[1];\n      }\n      return get;\n    } else {\n      return {};\n    }\n  };\n  // #endif\n\n  // #ifdef H5\n  if ($methods.extensions.hasExt('ui-esc')) {\n    // 如果有扩展程序需要处理 ESC 键，则监听 ESC 键并传递给扩展程序\n    $utils.appEvent.onKeyDown((evt) => {\n      $methods.extensions.invokeExts('ui-esc')\n      return true\n    }, {\n      order: 1000,\n      match: {\n        key: 'Escape',\n        altKey: false,\n        ctrlKey: false,\n        shiftKey: false,\n      }\n    })\n  }\n  \n  if (navigator.platform.indexOf('Win') > -1) {\n    // win 系统时给 dom 最外层加一个class .windows方便样式调整\n    document.body.classList.add('windows');\n  }\n  // #endif\n  \n  // uni.previewImage打开事件\n  uni.addInterceptor('previewImage', {\n    invoke: (e) => {\n      // #ifdef APP\n      $state.ext._previewImageIsOpen = true\n      // console.log('previewImage打开')\n      // #endif\n    },\n    success: (res) => {  \n      // #ifdef H5\n      setTimeout(() => {\n        const previewImageDom = document.getElementById('u-a-p')\n        const onDownEscapeKey = () => {\n          // console.log('Escape')\n          previewImageDom.getElementsByTagName('uni-swiper-item')[0].click()\n          return true\n        }\n        $utils.appEvent.onKeyDown(onDownEscapeKey, {\n          order: 0,\n          match: {\n            key: 'Escape',\n            altKey: false,\n            ctrlKey: false,\n            shiftKey: false,\n          }\n        })\n      \n      // uni.previewImage关闭事件\n        const closePreviewImage = () => {\n          // console.log('关闭previewImage')\n          $utils.appEvent.offKeyDown(onDownEscapeKey)\n          previewImageDom.removeEventListener('click',closePreviewImage)\n        }\n        previewImageDom.addEventListener('click',closePreviewImage)\n        \n        // 临时方案，只有一张图片时，不显示导航条\n        const swiperCount = previewImageDom.getElementsByTagName('uni-swiper-item').length\n        if (swiperCount < 2) {\n          let navigationDomList = previewImageDom.getElementsByClassName('uni-swiper-navigation')\n          navigationDomList[0].remove()\n          navigationDomList[0].remove()\n        }\n      },0)\n      // #endif\n    }\n  })\n  \n  $utils.appEvent.onAppActivate(() => {\n    $state.ext.appIsActive = true\n  })\n  $utils.appEvent.onAppDeactivate(() => {\n    $state.ext.appIsActive = false\n  })\n\t\n\t\n\tasync function doLogin(param){\n\t\tif(param.login){\n\t\t\ttry {\n\t\t\t\tparam.login = JSON.parse(param.login)\n\t\t\t\tawait $ext.login(param.login)\n\t\t\t} catch (error) {}\n\t\t}\n\t}\n\t$methods.extensions.installExt('index-load-before-extra',doLogin)\n\t$methods.extensions.installExt('chat-load-before-extra',doLogin)\n\t\n}\n"],"names":["checkVersion","onAppActivateStateChange","clearData","msgEvent","getCloudMsg","onSocketStateChange","imData","onlyOneWebTab","onNotification","$methods","$state","uni","uniCloud","wx","$utils","$ext"],"mappings":"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"}