{"version":3,"file":"index.js","sources":["uni_modules/uni-im/sdk/state/index.js"],"sourcesContent":["import {watchEffect,watch,reactive} from 'vue'\nimport data from './data';\nconst observable = reactive(data)\nuni.imObservableData = observable\nlet lastKey = ''\n// 监听数据变化\nlet index2 = 0,nnn2 = 0\nwatchEffect(() => {\n  const conversationDataList = observable.conversation.dataList\n  index2 ++ \n  // console.error('watchEffect会话数据变化2222',index2)\n  // 会话数据排序\n  const currentKey = sortConversationDataList(conversationDataList.slice()).map(item => item.id).join(',')\n  if (currentKey !== lastKey) {\n    nnn2 ++\n    // console.log('重新排序2',nnn2)\n    // TODO：优化未知错误需要加setTimeout 0，使得在下一次js引擎的事件循环执行，后续可以考虑优化\n    setTimeout(()=>sortConversationDataList(conversationDataList),0)\n    lastKey = currentKey\n  }else{\n    // console.error('---无需重新排序')\n  }\n})\n\n\nwatch(() => observable.currentConversationId,(currentConversationId,old)=>{\n  // console.log('选中的会话变化',currentConversationId,old)\n  if(old){\n    const oldConversation = observable.conversation.dataList.find(item => item.id === old)\n    // console.log('oldConversation',oldConversation)\n    // 只存储最后10条可见消息\n    const msgList = oldConversation?.msg?.dataList || []\n    const visibleDataList = oldConversation?.msg?.visibleDataList() || []\n    if (visibleDataList.length > 10) {\n      // 拿到倒数第10条可见消息\n      const lastTenMsg = visibleDataList[visibleDataList.length - 10]\n      const lastTenMsgIndex = msgList.findIndex(item => item._id === lastTenMsg._id)\n      oldConversation.msg.hasMore = true\n      // 删掉dataMap中的多余数据\n      for (let i = 0; i < lastTenMsgIndex; i++) {\n        oldConversation.msg.dataMap.delete(msgList[i]._id)\n      }\n      msgList.splice(0, lastTenMsgIndex)\n    }\n  }\n})\n\nwatch(() => observable.networkConnected, (networkConnected,oldNetworkConnected) => {\n  // console.log('网络连接状态变化',networkConnected,oldNetworkConnected)\n  if(networkConnected){\n    // 重新连接\n  }else{\n    // 断开连接\n  }\n  \n  if(oldNetworkConnected === false && networkConnected){\n    uni.showModal({\n      content: \"运行期间网络连接被异常中断，请重新加载\",\n      showCancel: false,\n      confirmText: '重新加载',\n      success(e) {\n        if (e.confirm) {\n          // console.log('用户点击确定');\n          window.location.reload()\n        }\n      }\n    });\n  }\n  \n})\n\n\nfunction sortConversationDataList(conversationDataList) {\n  return conversationDataList.sort(function(a, b) {\n    if (a.pinned != b.pinned) {\n      return a.pinned ? -1 : 1;\n    }\n    if (a.customIndex || b.customIndex) {\n      let aIndex = a.customIndex || 0\n      let bIndex = b.customIndex || 0\n      return bIndex > aIndex ? 1 : -1\n    }\n    if(b.time === a.time){\n      return b.id > a.id ? 1 : -1\n    }\n    return b.time > a.time ? 1 : -1\n  })\n}\nexport default observable;"],"names":["reactive","data","uni","watchEffect","watch"],"mappings":";;;AAEA,MAAM,aAAaA,cAAQ,SAACC,qCAAI;AAChCC,cAAG,MAAC,mBAAmB;AACvB,IAAI,UAAU;AAGdC,cAAAA,YAAY,MAAM;AAChB,QAAM,uBAAuB,WAAW,aAAa;AAIrD,QAAM,aAAa,yBAAyB,qBAAqB,MAAK,CAAE,EAAE,IAAI,UAAQ,KAAK,EAAE,EAAE,KAAK,GAAG;AACvG,MAAI,eAAe,SAAS;AAI1B,eAAW,MAAI,yBAAyB,oBAAoB,GAAE,CAAC;AAC/D,cAAU;AAAA,EAGX;AACH,CAAC;AAGDC,cAAK,MAAC,MAAM,WAAW,uBAAsB,CAAC,uBAAsB,QAAM;;AAExE,MAAG,KAAI;AACL,UAAM,kBAAkB,WAAW,aAAa,SAAS,KAAK,UAAQ,KAAK,OAAO,GAAG;AAGrF,UAAM,YAAU,wDAAiB,QAAjB,mBAAsB,aAAY,CAAE;AACpD,UAAM,oBAAkB,wDAAiB,QAAjB,mBAAsB,sBAAqB,CAAE;AACrE,QAAI,gBAAgB,SAAS,IAAI;AAE/B,YAAM,aAAa,gBAAgB,gBAAgB,SAAS,EAAE;AAC9D,YAAM,kBAAkB,QAAQ,UAAU,UAAQ,KAAK,QAAQ,WAAW,GAAG;AAC7E,sBAAgB,IAAI,UAAU;AAE9B,eAAS,IAAI,GAAG,IAAI,iBAAiB,KAAK;AACxC,wBAAgB,IAAI,QAAQ,OAAO,QAAQ,CAAC,EAAE,GAAG;AAAA,MAClD;AACD,cAAQ,OAAO,GAAG,eAAe;AAAA,IAClC;AAAA,EACF;AACH,CAAC;AAEDA,cAAK,MAAC,MAAM,WAAW,kBAAkB,CAAC,kBAAiB,wBAAwB;AAQjF,MAAG,wBAAwB,SAAS,kBAAiB;AACnDF,kBAAAA,MAAI,UAAU;AAAA,MACZ,SAAS;AAAA,MACT,YAAY;AAAA,MACZ,aAAa;AAAA,MACb,QAAQ,GAAG;AACT,YAAI,EAAE,SAAS;AAEb,iBAAO,SAAS,OAAQ;AAAA,QACzB;AAAA,MACF;AAAA,IACP,CAAK;AAAA,EACF;AAEH,CAAC;AAGD,SAAS,yBAAyB,sBAAsB;AACtD,SAAO,qBAAqB,KAAK,SAAS,GAAG,GAAG;AAC9C,QAAI,EAAE,UAAU,EAAE,QAAQ;AACxB,aAAO,EAAE,SAAS,KAAK;AAAA,IACxB;AACD,QAAI,EAAE,eAAe,EAAE,aAAa;AAClC,UAAI,SAAS,EAAE,eAAe;AAC9B,UAAI,SAAS,EAAE,eAAe;AAC9B,aAAO,SAAS,SAAS,IAAI;AAAA,IAC9B;AACD,QAAG,EAAE,SAAS,EAAE,MAAK;AACnB,aAAO,EAAE,KAAK,EAAE,KAAK,IAAI;AAAA,IAC1B;AACD,WAAO,EAAE,OAAO,EAAE,OAAO,IAAI;AAAA,EACjC,CAAG;AACH;AACA,MAAA,QAAe;;"}