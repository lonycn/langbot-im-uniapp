{"version":3,"file":"getCloudMsg.js","sources":["uni_modules/uni-im/sdk/init/getCloudMsg.js"],"sourcesContent":["import $state from '@/uni_modules/uni-im/sdk/state/index.js';\nconst uniImCo = uniCloud.importObject(\"uni-im-co\", {\n  customUI: false\n})\nconst dbJQL = uniCloud.databaseForJQL();\n// 获得云端数据，适用于：socket突然断开丢失，或者应用iOS切到后台拿不到透传等场景使用 获取丢失的数据\nlet getCloudMsgIng = false\n\nfunction getCloudMsg({\n  loadingTitle,\n  callback\n} = {\n  \"callback\": () => {}\n}) {\n  if ($state.isDisabled) {\n    return console.log('$state isDisabled')\n  }\n\n  if (getCloudMsgIng) {\n    callback()\n    return // 防止重复发起，比如即被切换到后台，socket又断开的场景\n  }\n\n  getCloudMsgIng = true\n\n  if (loadingTitle) {\n    uni.showLoading({\n      title: loadingTitle,\n      mask: true\n    });\n  }\n\n  // 下一次事件循环执行\n  setTimeout(async () => {\n    try {\n\n      await getConversationList()\n      async function getConversationList() {\n        // 根据本地会话的最大更新时间，查询云端数据\n        let maxConversation = ([...$state.conversation.dataList].sort((a, b) => b.update_time - a.update_time))[0]\n        console.log('maxConversation:', maxConversation)\n        \n        if (!maxConversation) {\n          getCloudMsgIng = false\n          return\n        }\n        let minUpdateTime = maxConversation.update_time\n        // console.log('minUpdateTime', minUpdateTime);\n        console.log('getCloudMsg');\n        let {data:conversationDatas} = await uniImCo.getConversationList({\n          minUpdateTime,\n          limit: 30\n        })\n        \n        // console.error('conversationDatas',conversationDatas)\n\n        conversationDatas.forEach(newConversationInfo => {\n          // console.error('newConversationInfo',newConversationInfo)\n          // 存在则更新，不存在则新增\n          const conversation = $state.conversation.set(newConversationInfo)\n          // 如果当前会话已经被打开则需要设置未读消息数为0\n          if ($state.currentConversationId === conversation.id) {\n            conversation.unread_count = 0\n          }\n        })\n\n        for (let i = 0; i < conversationDatas.length; i++) {\n          console.log('需要查询的msg有：'+conversationDatas.length,i)\n          // 判断是否已经存在\n          const conversation = conversationDatas[i]\n          // 查询云端消息数据\n          await getConversationMsgs({conversation,minUpdateTime})\n        }\n\n        // await getMsgList({minUpdateTime,conversation_ids: conversationDatas.map(item => item.id)})\n\n        if (conversationDatas.length === 30) {\n          console.log(\"可能存在下一页数据\");\n          return await getConversationList()\n        } else {\n          console.log('离线会话数据同步完毕')\n        }\n        console.log(`更新会话：${conversationDatas.length}`)\n      }\n      getCloudMsgIng = false\n      callback()\n      if (loadingTitle) {\n        uni.hideLoading()\n      }\n    } catch (e) {\n      console.error('getCloudMsg error', e);\n      getCloudMsgIng = false\n    }\n  }, 0);\n}\n\nexport default getCloudMsg\n\nasync function seaveMsgs(msgs) {\n  if (msgs.length === 0) {\n    return\n  }\n  const conversation = $state.conversation.find(msgs[0].conversation_id)\n  msgs.forEach(msg => {\n    // todo：暂时先不考虑本地库\n    // 会话未初始化（打开）过，不需要更新内存\n    if(conversation.isInit){\n      let hasThisMsg = conversation.msg.find(msg._id)\n      if (hasThisMsg) {\n        // 更新内存的这条消息内容\n        Object.assign(hasThisMsg, msg)\n      } else {\n        conversation.msg.add(msg)\n      }\n    }\n  })\n  /**\n   * 以下为启用本地库的端使用的代码\n   */\n  // msgs.sort((a, b) => a.update_time - b.update_time)\n  // msgs.forEach(async msg => {\n  //   // 判断是否出现重复\n  //   let [localHasThisMsg] = await conversation.msgManager.localMsg.get({\n  //     _id: msg._id\n  //   })\n  //   if (localHasThisMsg) {\n  //     // console.log('出现重复', localHasThisMsg);\n  //     // 更新本地的这条消息内容\n  //     const unique_id = localHasThisMsg.unique_id\n  //     msg.unique_id = unique_id\n  //     await conversation.msgManager.localMsg.update(unique_id, msg)\n  //     // 如果内存中存在也更新（这种情况，会话确定已经初始化（打开）过）\n  //     let memoryMsg = conversation.msg.find(msg._id)\n  //     if (memoryMsg) {\n  //       // console.log('出现重复', memoryMsg);\n  //       Object.assign(memoryMsg, msg)\n  //     }\n  //   } else {\n  //     // 本地库插入新消息\n  //     conversation.msgManager.localMsg.add(msg)\n  //     // console.log('本地库插入新消息', msg);\n  //     // 初始化（打开）过的会话，需要更新内存\n  //     if (conversation.isInit) {\n  //       conversation.msg.add(msg)\n  //     }\n  //   }\n  // })\n}\n\nasync function getConversationMsgs({\n  limit = 100,\n  conversation,\n  minUpdateTime = 0\n}){\n  // console.error('getConversationMsgs minUpdateTime',minUpdateTime);\n  // 按会话查\n  const conversation_id = conversation.id\n  let res = await dbJQL.collection('uni-im-msg').where({\n      conversation_id,\n      \"update_time\": dbJQL.command.gt(minUpdateTime),\n    })\n    .orderBy('update_time', 'asc')\n    .limit(limit)\n    .get()\n  console.log('查询到新msg数据', res,res.data.length);\n  seaveMsgs(res.data)\n  // 递推查询\n  if (res.data.length === limit) {\n    arguments[0].minUpdateTime = res.data[limit - 1].update_time\n    await getConversationMsgs(arguments[0])\n  }\n}\n\n// async function getMsgList({\n//   minUpdateTime = 0,\n//   conversation_ids\n// }) {\n//   const limit = 1000\n//   console.log('minUpdateTime', minUpdateTime);\n//   console.log('conversation_ids', conversation_ids);\n//   let res = await uniImCo.getMsgList({\n//     conversation_ids,\n//     minUpdateTime,\n//     limit\n//   })\n\n//   console.error('查询到新消息数据', res.data.length);\n//   // 按会话id分组\n//   let conversationMsgs = {}\n//   res.data.forEach(msg => {\n//     if (!conversationMsgs[msg.conversation_id]) {\n//       conversationMsgs[msg.conversation_id] = []\n//     }\n//     conversationMsgs[msg.conversation_id].push(msg)\n//   })\n//   // console.log('conversationMsgs', conversationMsgs);\n//   // 逐个会话处理\n//   for (let conversation_id in conversationMsgs) {\n//     let msgs = conversationMsgs[conversation_id]\n//     // console.log('msgs', msgs);\n//     seaveMsgs(msgs)\n//   }\n\n//   if (res.data.length === limit) {\n//     minUpdateTime = res.data[limit - 1].update_time\n//     let res2 = await getMsgList(arguments[0])\n//     res.data = res.data.concat(res2.data)\n//     return res\n//   } else {\n//     return res\n//   }\n// }"],"names":["uniCloud","$state","uni"],"mappings":"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"}