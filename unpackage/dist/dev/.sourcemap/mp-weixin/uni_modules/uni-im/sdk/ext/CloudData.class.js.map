{"version":3,"file":"CloudData.class.js","sources":["uni_modules/uni-im/sdk/ext/CloudData.class.js"],"sourcesContent":["const dbJQL = uniCloud.databaseForJQL()\nconst dbJQLcmd = dbJQL.command\nconst $ = dbJQL.command.aggregate\nimport $state from '../state/index.js';\nimport utils from '@/uni_modules/uni-im/sdk/utils/index.js';\n\nexport default class CloudData {\n  dataList = []\n  hasMore = true\n  loading = false\n  loadLimit = 100\n  indexKey = '_id'\n  __getMoreQueue = []\n  // 被哪个类继承\n  inheritedBy = ''\n  constructor() {\n    // this.dbJQL = dbJQL\n    // this.dbJQLcmd = dbJQLcmd\n    // this.dbJQL$ = $\n    if(this.indexKey){\n      this.dataMap = new Map()\n    }\n  }\n  reset() {\n    this.dataList.length = 0\n    this.hasMore = true\n    this.loading = false\n    if(this.indexKey){\n      this.dataMap.clear()\n    }\n  }\n  remove(param) {\n    let item = this.find(param)\n    if(item){\n      if(Array.isArray(this.dataList)){\n        this.dataList.splice(this.dataList.indexOf(item), 1)\n      }else{\n        delete this.dataList[item._id]\n      }\n      if(this.indexKey){\n        let key;\n        this.indexKey.split('.').forEach(k => {\n          key = key ? key[k] : item[k]\n        })\n        this.dataMap.delete(key)\n      }\n    }\n    this.__afterRemove(item)\n  }\n  __beforeRemove(param) {\n    // 空实现\n    return param\n  }\n  __afterRemove(param) {\n    // 空实现\n    return param\n  }\n  __beforeFind(param) {\n    // 空实现，用于子类重写\n    return param\n  }\n  /**\n   * @description 查找本地中存在的数据\n   * @param {Object} param 查找条件，如果为空则返回全部数据，否则返回查找到的1条数据\n   */\n  find(param) {\n    if(!param){\n      throw new Error('请传入查找条件')\n    }\n    const dataList = this.dataList\n    param = this.__beforeFind(param)\n    let res;\n    if(this.indexKey){\n      // 先判断param是否和this.indexKey一样,可以走dataMap查找\n      const indexKeyArr = this.indexKey.split('.');\n      let mapKey = false;\n      // 判断索引为字符串还是对象\n      if(indexKeyArr.length == 1 && typeof param == 'string'){\n        // 字符串索引\n        mapKey = param\n      }else if(typeof param == 'object' && convertObjToString(param) === this.indexKey){\n        // 对象索引\n        let key;\n        indexKeyArr.forEach(k => {\n          key = key ? key[k] : param[k]\n        })\n        mapKey = key\n      }\n      if (mapKey) {\n        // console.time('find dataMap.get' + this.constructor.name)\n        res = this.dataMap.get(mapKey)\n        // console.timeEnd('find dataMap.get' + this.constructor.name)\n      } else {\n        console.log('注意：此次查找未走索引',param,this.indexKey,this.constructor.name)\n      }\n    } \n    \n    if(!res) {\n      // console.time('find-no-index-' + this.constructor.name)\n      // 默认查找条件为_id\n      if(typeof param == 'string'){\n        res = dataList.find(item => item._id == param)\n      }else if(typeof param == 'object'){\n        // console.log('param',param)\n        res = dataList.find(item => isEq(item,param))\n      }else{\n        throw new Error('错误的查找条件')\n      }\n      // console.timeEnd('find-no-index-' + this.constructor.name)\n    }\n    if(this.__afterFind){\n     res = this.__afterFind?.({param,res})\n    }\n    \n    return res\n  }\n  /** @description 查询数据，先从本地查找，如果没有则从云端拉取\n   * @param {Object} param 查找条件，如果为空则返回全部数据，否则返回查找到的1条数据\n   */\n  async get(param) {\n    if(this.inheritedBy === 'conversation'){\n      // debugger\n    }\n    if(!param){\n      throw new Error('请传入查找条件')\n    }\n    let data = this.find(param)\n    if(!data){\n      data = await this.loadMore(param)\n    }\n    this.__afterGet(data)\n    return data\n  }\n  __afterGet(param) {\n    // 空实现，用于子类重写\n    return param\n  }\n  count() {\n    return this.dataList.length\n  }\n  __get(param){\n    // 空实现，用于子类重写\n    console.error('CloudData.pullData is not implemented')\n    // 返回入参，避免报错\n    return param\n  }\n  \n  async getMore(param) {\n    if(!param){\n      if(!this.hasMore){\n        console.log('没有更多数据了')\n        return []\n      }\n      if (this.loading) {\n        await new Promise((resolve, reject) => {\n          console.warn('正在加载中，本次请求进入列队。模块名称:' + this.constructor.name)\n          this.__getMoreQueue.push({resolve, reject})\n        })\n        console.log('列队任务已开始执行。模块名称:' + this.constructor.name)\n      }else{\n        this.loading = true\n      }\n    }\n    let datas = []\n    try{\n      datas = await this.__get(param)\n      if(!param){\n        this.hasMore = datas.length === this.loadLimit\n        this.loading = false\n      }\n    }catch(e){\n      console.error('loadMore err',e)\n      this.loading = false\n      uni.showToast({\n        title: e.message,\n        icon: 'none'\n      });\n    }\n    this.__afterGetMore?.(datas)\n    // 执行下一个队列\n    if(this.__getMoreQueue.length > 0){\n      const item = this.__getMoreQueue.shift()\n      item.resolve()\n    }\n    return datas\n  }\n  async loadMore(param) {\n    // console.log('loadMore param',param);\n    let datas = await this.getMore(param)\n    if(datas.length > 0){\n      datas = this.add(datas,{canSetIsFull:true})\n    }\n    return param == undefined ? datas : datas[0]\n  }\n  set(data){\n    if(!data) return\n    // 先判断是否存在\n    let item = this.find(data.id || data._id || Object.keys(data)[0])\n    if(item){\n      // console.log('更新会话',data)\n      try{\n        utils.deepAssign(item,data)\n      }catch(e){\n        console.error('合并更新出错',{item,data,e})\n      }\n      return item\n    }else{\n      return this.add(data)\n    }\n  }\n  __beforeAdd(param) {\n    // 空实现，用于子类重写\n    return param\n  }\n  add(param,options = {}) {\n    // console.time('add' + this.constructor.name)\n    const {canUpdate = true,unshift = false} = options\n    const paramIsArray = Array.isArray(param)\n    let datas = paramIsArray ? param : [param]\n    \n    // console.time('add __beforeAdd' + this.constructor.name)\n    let res = this.__beforeAdd(datas,options)\n    // console.timeEnd('add __beforeAdd' + this.constructor.name)\n    if(res !== undefined){\n      datas = res\n    }\n    // 插入之前dataList是否为空\n    const isEmpty = this.dataList.length === 0\n    const resData = datas.map(item => {\n      let val;\n      if(this.indexKey){\n        this.indexKey.split('.').forEach(k => {\n          val = val ? val[k] : item[k]\n        })\n      }else{\n        val = item._id || item.id || { [Object.keys(item)[0]]: item[Object.keys(item)[0]] }\n      }\n      // 如果当前数据列表为空或者没有传入索引值，则不检查要插入的数据是否存在\n      let _data = (isEmpty || !val) ? false : this.find(val)\n      // console.log('add _data',{_data,item})\n      // 如果已经存在的，只更新不添加\n      if(_data){\n        if(canUpdate && item != _data){\n          // console.log('添加的对象已经存在，更新对象',{item,item})\n          try{\n            utils.deepAssign(_data,item)\n          }catch(e){\n            console.error('合并更新出错',{item,_data,e})\n          }\n        }\n        return _data\n      }else{\n        if(unshift){\n          this.dataList.unshift(item)\n          item = this.dataList.slice(0,1)[0]\n        }else{\n          this.dataList.push(item)\n          item = this.dataList.slice(-1)[0]\n        }\n        if(this.indexKey){\n          // console.time('dataMap set')\n          let key;\n          this.indexKey.split('.').forEach(k => {\n            key = key ? key[k] : item[k]\n          })\n          const cs = this.__canSeaveToDataMap\n          const val = cs ? cs(item) : true\n          if(val){\n            this.dataMap.set(key, item)\n          }\n          // console.log('this.dataMap',this.dataMap)\n          // console.timeEnd('dataMap set')\n        }\n        return item\n      }\n    })\n    this.__afterAdd(resData,options)\n    // console.error('param',param)\n    // console.timeEnd('add' + this.constructor.name)\n    return paramIsArray ? resData : resData[0]\n  }\n  __afterAdd(param) {\n    // 空实现，用于子类重写\n    return param\n  }\n  update(param, data) {\n    let item = this.find(param)\n    if(item){\n      Object.assign(item, data)\n    }\n    return item\n  }\n}\n\nfunction convertObjToString(obj) {\n  let result = '';\n  function recursiveConvert(currentObj, path) {\n    for (const key in currentObj) {\n      const value = currentObj[key];\n      const newPath = path? `${path}.${key}` : key;\n      if (typeof value === 'object') {\n        recursiveConvert(value, newPath);\n      } else {\n        result += `${newPath}`;\n      }\n    }\n  }\n  recursiveConvert(obj, '');\n  return result;\n}\n\nfunction isEq(a, b) {\n  if (Array.isArray(a) || Array.isArray(b)) {\n    console.error('不支持数组比较')\n    return a === b;\n  }\n  let result = true;\n  for (let key in b) {\n    const valueA = a[key];\n    const valueB = b[key];\n    if (typeof valueB === 'object' \n      && valueB !== null\n      && typeof valueA === 'object'\n      && valueA !== null\n    ) {\n      return isEq(valueA, valueB);\n    }\n    result = valueA === valueB;\n    if (!result) {\n      break;\n    }\n  }\n  return result;\n}"],"names":["uniCloud","uni","utils","val"],"mappings":"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"}