{"version":3,"file":"ConversationItem.class.js","sources":["uni_modules/uni-im/sdk/state/ConversationItem.class.js"],"sourcesContent":["import {watch,computed} from 'vue'\nimport $state from '@/uni_modules/uni-im/sdk/state/index.js';\nimport $utils from '@/uni_modules/uni-im/sdk/utils/index.js';\nimport $extensions from '@/uni_modules/uni-im/sdk/methods/extensions.js';\nimport Msg from '@/uni_modules/uni-im/sdk/state/Msg.class.js'\nconst db = uniCloud.database();\nconst uniImCo = uniCloud.importObject(\"uni-im-co\",{customUI:true})\n/**\n * 会话类，实现会话相关的业务逻辑。\n */\nclass ConversationItem {\n  constructor(data) {\n    // 检查是否关联用户/群被删除\n    if (!data.group_id && !data.user_info) {\n      // 删除本地生成的 data.client_create_time 避免错误重复上报\n      delete data.client_create_time\n      throw new Error('会话列表失效，疑似关联用户/群被删除(请改为软删除避免系统异常）data:'+JSON.stringify(data));\n    }\n    // 对话框消息内容\n    this.chatInputContent = \"\"\n    // @我的消息id列表\n    this.remind_msg_ids = []\n    \n    this.msg = new Msg(data.id)\n    \n    // 客户端创建此会话的时间\n    this.client_create_time = Date.now()\n    // 是否已离开（退出、被踢出）群聊\n    this.leave = false\n    // 默认不置顶\n    this.pinned = false\n    \n    this.tags = []\n\n    // 是否已经初始化。 从缓存中取出的会话数据可能已经初始化，这里需要归零\n    data.isInit = true\n    Object.assign(this, data)\n\t\t\n\t\tthis.readRemindMsg = (id)=>{\n\t\t\t// 需要绕一圈，否则无法触发响应式\n\t\t\tconst remind_msg_ids = $state.conversation.find(this.id).remind_msg_ids\n\t\t\tif(id) {\n\t\t\t\tremind_msg_ids.splice(remind_msg_ids.indexOf(id),1)\n\t\t\t\tconsole.log('readRemindMsg',id,remind_msg_ids)\n\t\t\t} else {\n\t\t\t\tid = remind_msg_ids.pop()\n\t\t\t}\n\t\t\tif(id){\n\t\t\t\tuniImCo.removeRemindMsgId({\n\t\t\t\t\tconversation_id:this.id,\n\t\t\t\t\tmsg_id:id\n\t\t\t\t}).then((e)=>{\n\t\t\t\t\tconsole.log('removeRemindMsgId success',id,e)\n\t\t\t\t})\n\t\t\t}\n\t\t\treturn id\n\t\t}\n\n    if (this.group_id) {\n      // 群聊\n      this.group = $state.group.find(this.group_id)\n      if (!this.group) {\n        console.error('群聊不存在', this)\n        throw new Error('群聊不存在')\n      }\n\n      // 2. 设置群tag\n      // 调用扩展点，扩展程序可以为该会话增加 tag。\n      Promise.all($extensions.invokeExts('conversation-tags', this))\n        .then(tags => {\n          tags = tags.filter(tag => tag)\n          if (tags.length === 0) {\n            this.tags = ['群聊']\n          }else{\n            // 需要绕一圈，否则无法触发响应式\n            $state.conversation.find(this.id).tags = tags\n          }\n        })\n\n      // 3. 初始化字段:群简介、群公告、群头像\n      const fieldList = [{\n          \"introduction\": \"\"\n        }, {\n          \"notification\": {\n            \"content\": false\n          }\n        }, {\n          \"avatar_file\": {\n            \"url\": \"\"\n          }\n        },\n        {\n          \"mute_all_members\": false // 全员禁言\n        }\n      ]\n      fieldList.forEach(item => {\n        const key = Object.keys(item)[0]\n        if (!this.group[key]) {\n          this.group[key] = item[key]\n        }\n      })\n      // 4. 非单聊，不需要用户信息\n      this.user_info = false\n    } else {\n      // 非群聊，不需要群消息\n      this.group = false\n\t\t\tif(this.is_temp){\n\t\t\t\tthis.user_info = {}\n\t\t\t\t$state.users.get(this.friend_uid).then(userInfo => {\n\t\t\t\t\t// 绕一圈，否则无法触发响应式\n\t\t\t\t\t$state.conversation.find(this.id).user_info = userInfo\n\t\t\t\t})\n\t\t\t}else{\n\t\t\t\tthis.user_info = $state.users[this.friend_uid]\n\t\t\t}\n      const real_name = this.user_info?.realname_auth?.real_name\n      if (real_name){\n        this.tags = [real_name]\n      }\n    }\n    \n    // 初始化响应式属性\n    this.activeProperty().init()\n  }\n  /**\n   * 会话未读消息数清零。\n   */\n  clearUnreadCount() {\n    // console.log('clearUnreadCount');\n    setTimeout(() => {\n      this.unread_count = 0\n    }, 100);\n    // console.log('clearUnreadCount this.id', this.id)\n    // 触发器会触发消息表的 is_read = true\n    uniCloud.database()\n      .collection('uni-im-conversation')\n      .where({\n        user_id: $state.currentUser._id,\n        id: this.id\n      })\n      .update({\n        \"unread_count\": 0\n      }).then(e => {\n        console.log('设置为已读', e.result.updated);\n      }).catch(err => {\n        console.error('设置为已读失败', err);\n      })\n  }\n\n  /** 撤回消息。\n   * @param {object} msg - 参数对象\n   * @param {string} msg._id - 消息id\n   * @param {string} msg.msg_id - 消息id和_id二选一\n   * @param {string} msg.conversation_id - 所属会话的id\n   * @param {number} msg.create_time - 创建时间\n   * @param {boolean} [submit=true] -  是否需要提交；操作撤回端需要提交，被动撤回消息端无需提交\n   */\n  async revokeMsg(msg_id, submit = true) {\n    // 处理内存中显示中的数据\n    const msg = this.msg.find(msg_id)\n    if (!msg) {\n      return console.warn('内存中没有找到此消息（当前用户可能还没点开相关会话），无需撤回', msg_id)\n    }\n    // 是否为当前用户触发的撤回\n    if (submit) {\n      // 保存撤回前的消息内容，用于方便点击重新编辑\n      msg.before_revoke_body = msg.body\n      // ui 界面上显示撤回中\n      msg.revoke_ing = true\n      // 提交操作到云端\n      try {\n        await uniImCo.sendMsg({\n          \"type\": \"revoke_msg\",\n          \"body\": {msg_id}\n        })\n      } catch (err) {\n        console.log('err', err);\n        // 撤回失败，还原数据\n        msg.body = msg.before_revoke_body\n        delete msg.before_revoke_body\n        delete msg.revoke_ing\n        return uni.showToast({\n          title: err.message,\n          icon: 'none'\n        });\n      }\n      // ui 界面上去掉撤回中\n      delete msg.revoke_ing\n    }\n    msg.is_revoke = true\n    msg.body = '[此消息已被撤回]'\n  }\n\n  /**\n   * 获取用户信息。\n   */\n  getUsersInfo() {\n    // 群会话返回群成员信息，单聊返回对方用户信息\n    return this.group_id ? this.group.member.dataList : {\n      [this.user_info._id]: this.user_info\n    }\n  }\n  /**\n   * changeMute\n   */\n  changeMute() {\n    this.mute = !this.mute\n    const db = uniCloud.database();\n    db.collection('uni-im-conversation')\n      // 因为本地创建的会话没有_id，需通过user_id和id指定要操作的会话\n      .where({\n        user_id: this.user_id,\n        id: this.id\n      })\n      .update({\n        \"mute\": this.mute\n      })\n      .then((e) => {\n        console.log('updated 消息免打扰设置', e.result.updated, this._id)\n      })\n      .catch(() => {\n        uni.showToast({\n          title: '服务端错误，消息免打扰设置失败，请稍后重试',\n          icon: 'none'\n        });\n        this.mute = !this.mute\n      })\n  }\n  /**\n   * 设置响应式属性。\n   * @param {Object} data\n   */\n  activeProperty(data) {\n    this._leave = this.leave\n    this._update_time = this.update_time || this.create_time\n    const _conversation = this\n    const activeProperty = {\n      title() {\n        return _conversation.group_id ? _conversation.group.name : _conversation.user_info.nickname\n      },\n      avatar_file() {\n        return _conversation.group_id ? _conversation.group.avatar_file : _conversation.user_info.avatar_file\n      },\n      leave:{\n        get() {\n          if (_conversation.msg.dataList.length === 0) {\n            return _conversation._leave\n          } else {\n            let last_msg = _conversation.msg.dataList[_conversation.msg.dataList.length - 1]\n            //群被解散，或者被踢出\n            return \"group-dissolved\" === last_msg.action || [\"group-exit\", \"group-expel\"].includes(last_msg.action) && last_msg.body.user_id_list.includes($state.currentUser._id)\n          }\n        },\n        set(value){\n          // console.log('set leave value',value)\n          _conversation._leave = value\n        }\n      },\n      isMuteAllMembers() {\n        try{\n          if (!_conversation.group_id) return false\n          const member = _conversation.group.member.find($state.currentUser._id)\n          // console.log('member',member)\n          return member && !member.role.includes('admin') && _conversation.group.mute_all_members\n        }catch(e){\n          console.error('isMuteAllMembers',e,_conversation)\n          console.error('isMuteAllMembers',1,_conversation.group)\n          console.error('isMuteAllMembers',2,_conversation.group.member)\n          console.error('isMuteAllMembers',3,_conversation.group.member.find)\n          console.error('isMuteAllMembers',4,typeof _conversation.group.member.find)\n        }\n      },\n      // 最后一条可见消息\n      _last_visible_msg() {\n        // 拿到内存中的\n        const visibleMsgList = _conversation.msg.visibleDataList()\n        const vml = visibleMsgList.length\n        return vml > 0 ? visibleMsgList[vml - 1] : false\n      },\n      // 最后一条可见消息的时间，也被用于排序会话\n      time() {\n        // 如果存在最后一条可见消息，就用它的时间，否则用会话的更新时间 （注意：不能取最大值，因为消息被已读也会更新会话时间，此时会话无需重新排序）\n       const last_visible_msg = _conversation._last_visible_msg\n       let time = last_visible_msg ? (last_visible_msg.create_time || last_visible_msg.client_create_time) : _conversation.update_time\n       // time 和本地自定义排序时间比较，取最大值。说明：customSortTime 是临时将会话排序提升到最前的时间。比如：在群成员列表/消息列表等 与某个用户起会话，临时将会话提升到最前等\n       return Math.max(time, _conversation.customSortTime || 0)\n      },\n      // 最后一条可见消息的内容\n      note() {\n        let note = _conversation.last_msg_note || '暂无聊天记录'\n        // 如果输入框有文本未发出（草稿），直接覆盖消息\n        let chatInputContent = _conversation.chatInputContent\n        if (typeof chatInputContent === 'object') {\n          chatInputContent = chatInputContent.text || '[富文本消息]'\n        } else {\n          // 把this.chatInputContent中的&nbsp;变成空格，再把头尾的空格去掉\n          chatInputContent = chatInputContent.replace(/&nbsp;/g, ' ').trim()\n        }\n        _conversation.hasDraft = chatInputContent && $state.currentConversationId != _conversation.id\n        let last_visible_msg = _conversation._last_visible_msg\n        if (_conversation.hasDraft) {\n          note = chatInputContent\n          last_visible_msg = {\n            body: chatInputContent,\n            type: 'text'\n          }\n        }\n        if (last_visible_msg) { // 如果存在最后一条消息\n          const _last_visible_msg = JSON.parse(JSON.stringify(last_visible_msg))\n          // console.error('last_visible_msg',_last_visible_msg)\n          note = $utils.getMsgNote(last_visible_msg)\n        }\n        // 替换\\\\n \\\\r \\n \\r &nbsp; &lt; &gt; &amp; 为 空格\n        note = note.replace(/\\\\n|\\\\r|\\n|\\r|&nbsp;|&lt;|&gt;|&amp;/g, ' ')\n        // 拿到发送消息的用户昵称\n        const {nickname} =last_visible_msg\n        if(_conversation.group_id && nickname){\n          note = nickname + ': ' + note\n        }\n        \n        return note.trim()\n      },\n      // 刷新会话的更新时间\n      update_time:{\n        get() {\n          // console.log('refreshUpdateTime');\n          // 拿到最后一条消息\n          let update_time = _conversation._update_time\n          let msgLength = _conversation.msg.dataList.length\n          if (msgLength > 0) {\n            let last_msg = _conversation.msg.dataList[msgLength - 1]\n            // 拿到最后一条消息的创建时间，消息发送成功之前没有create_time，用client_create_time\n            let last_msg_time = last_msg.create_time || last_msg.client_create_time\n            if (last_msg_time > update_time) {\n              update_time = last_msg_time\n            }\n          }\n          return update_time\n        },\n        set(value) {\n          _conversation._update_time = value\n        }\n      }\n    }\n    \n    let res = {\n      init() {\n        Object.keys(activeProperty).forEach(key => {\n          let item = activeProperty[key];\n          if (typeof activeProperty[key] != 'function') {\n            item = activeProperty[key].get\n          }\n          _conversation[key] = item()\n        })\n      },\n      ...activeProperty\n    }\n    \n    Object.defineProperty(res, 'init', {\n      // 设置init方法不可枚举\n      enumerable: false\n    })\n    return res\n  }\n  // 隐藏会话\n  async hide() {\n    console.log('hidden######');\n    this.hidden = true\n    let res = await db.collection('uni-im-conversation')\n      // 因为本地创建的会话没有_id，需通过user_id和id指定要操作的会话\n      .where({\n        user_id: this.user_id,\n        id: this.id\n      })\n      .update({\n        \"hidden\": true\n      })\n    console.log('updated hidden', res)\n    return res\n  }\n  // 设置未读消息数\n  async setUnreadCount(count) {\n    // console.log('setUnreadCount', count);\n    const oldCount = this.unread_count\n    this.unread_count = count\n    let res = await db.collection('uni-im-conversation')\n      // 因为本地创建的会话没有_id，需通过user_id和id指定要操作的会话\n      .where({\n        user_id: this.user_id,\n        id: this.id\n      })\n      .update({\n        \"unread_count\": count\n      })\n      .catch(err => {\n        console.error('setUnreadCount err', err);\n        this.unread_count = oldCount\n      })\n      .then(e => {\n        // console.log('setUnreadCount updated', e.result.updated);\n      })\n    return res\n  }\n  async changeIsStar() {\n    const oldIsStar = this.is_star\n    console.log('setIsStar', oldIsStar);\n    this.is_star = !oldIsStar\n    let res = await db.collection('uni-im-conversation')\n      // 因为本地创建的会话没有_id，需通过user_id和id指定要操作的会话\n      .where({\n        user_id: this.user_id,\n        id: this.id\n      })\n      .update({\n        \"is_star\": this.is_star\n      })\n      .catch(err => {\n        console.error('setIsStar err', err);\n        this.is_star = oldIsStar\n      })\n      .then(e => {\n        console.log('setUnreadCount updated', e.result.updated);\n      })\n    return res\n  }\n}\n\nexport default ConversationItem\n"],"names":["uniCloud","Msg","$state","uni","$extensions","db","$utils"],"mappings":"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"}