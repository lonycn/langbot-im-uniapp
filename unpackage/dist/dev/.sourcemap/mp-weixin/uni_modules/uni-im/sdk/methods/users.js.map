{"version":3,"file":"users.js","sources":["uni_modules/uni-im/sdk/methods/users.js"],"sourcesContent":["import $state from '../state/index.js';\nlet $users = {\n  system: {\n    _id: 'system',\n    nickname: '系统消息',\n    avatar_file: '/static/uni-im/avatar/system.png',\n  },\n  merge(usersInfo) {\n    if (Array.isArray(usersInfo)) {\n      let obj = {}\n      usersInfo.forEach(item => {\n        obj[item._id] = item\n      })\n      usersInfo = obj\n    }\n\t\tfor(let key in usersInfo){\n\t\t\tconst {nickname} = usersInfo[key]\n\t\t\tif (nickname && !nickname.includes('(')){\n\t\t\t\tusersInfo[key] = new Proxy(usersInfo[key], {\n\t\t\t\t\tget(target, prop) {\n\t\t\t\t\t\tif(prop === 'nickname'){\n\t\t\t\t\t\t\tconst alias = $state.userAlias[target._id]\n\t\t\t\t\t\t\tif(alias){\n\t\t\t\t\t\t\t\treturn target[prop] + ' (' + alias + ')'\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn target[prop]\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t} else {\n\t\t\t\tconsole.log('已经代理过了',usersInfo[key].nickname)\n\t\t\t}\n\t\t}\n    Object.assign($state.users, usersInfo)\n  },\n  find(param) {\n    param = Array.isArray(param) ? param : [param]\n    let usersInfo = []\n    param.forEach(uid => {\n      const userInfo = $state.users[uid]\n      if (userInfo) {\n        usersInfo.push(userInfo)\n      }\n    })\n    return usersInfo\n  },\n  async get(param) {\n    const uid_list = Array.isArray(param) ? param : [param]\n    // 信息在本地不存在的用户id\n    let new_uid_list = [];\n    let userInfoList = [];\n    uid_list.forEach(uid => {\n      let userInfo = $state.users[uid]\n      if (userInfo && !this.loadTask.list.includes(uid)) {\n        userInfoList.push(userInfo)\n      } else {\n        new_uid_list.push(uid)\n      }\n    })\n    if (new_uid_list.length) {\n      // 从云端加载本地不存在的用户数据\n      const db = uniCloud.database();\n      let res = await db.collection('uni-id-users').where({\n          \"_id\": db.command.in(new_uid_list)\n        })\n        .field('_id,nickname,avatar_file,realname_auth')\n        .get()\n      $state.users.merge(res.result.data.reduce((obj, item) => {\n\t\t\t\tobj[item._id] = item\n\t\t\t\treturn obj\n\t\t\t}, {}))\n\t\t\t// 拿到sdk处理后的用户数据\n\t\t\tuserInfoList.push(...this.find(new_uid_list))\n      // console.log('从云端加载本地不存在的用户数据',new_uid_list.length,res.result.data, res,$state.users)\n    }\n    return Array.isArray(param) ? userInfoList : userInfoList[0]\n  },\n  getNickname(user_id,tmpNickname = '[昵称加载中...]'){\n    const nickname = $state.users[user_id]?.nickname\n    if(nickname){\n      return nickname\n    } else {\n      // 如果用户信息不存在，先加入队列\n      $users.loadTask.add(user_id)\n      \n      $state.users[user_id] = {\n        nickname:tmpNickname,\n        _id:user_id,\n        __loading:true\n      }\n      return $state.users[user_id]?.nickname\n    }\n  },\n  // 设置一个队列加载用户信息避免频繁请求\n  loadTask:{\n    list:[],\n    add(uids){\n      uids = Array.isArray(uids) ? uids : [uids],\n      this.list.push(...uids)\n      this.run()\n    },\n    run(){\n      // console.log('run-loadTask0')\n      if(this.timer){\n        clearTimeout(this.timer)\n      }\n      // console.log('run-loadTask1')\n      this.timer = setTimeout(()=>{\n        this.timer = null\n        if(this.list.length){\n          // console.log('run-loadTask2')\n          // 去重\n          this.list = [...new Set(this.list)]\n          $users.get(this.list)\n          this.list = []\n        }\n      },300)\n    }\n  }\n}\nexport default $users;"],"names":["$state","uni","uniCloud"],"mappings":"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"}