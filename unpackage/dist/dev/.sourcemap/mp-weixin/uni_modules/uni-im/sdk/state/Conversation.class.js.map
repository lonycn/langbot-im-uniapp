{"version":3,"file":"Conversation.class.js","sources":["uni_modules/uni-im/sdk/state/Conversation.class.js"],"sourcesContent":["import {watch,computed} from 'vue'\nimport CloudData from '@/uni_modules/uni-im/sdk/ext/CloudData.class.js'\nimport getCloudMsg from '../init/getCloudMsg.js';\nimport ConversationItem from './ConversationItem.class.js'\nimport $utils from '@/uni_modules/uni-im/sdk/utils/index.js';\nimport $state from '../state/index.js';\nimport $extensions from '@/uni_modules/uni-im/sdk/methods/extensions.js';\nimport $users from '@/uni_modules/uni-im/sdk/methods/users.js';\n\nconst uniImCo = uniCloud.importObject(\"uni-im-co\")\nexport default class Conversation extends CloudData {\n  constructor() {\n    super()\n    this.inheritedBy = 'conversation'\n    this.indexKey = 'id'\n    // 云端{\"未读会话id\":未读数}数据\n    this.cloudUnreadCountObj = {}\n    // 定义加载数据的条数\n    this.loadLimit = 15\n    // #ifdef H5\n    this.loadLimit = 30\n    // #endif\n    this.typeList = [\n      {\n        title:'全部',\n        value:'all',\n\t\t\t\tfilter: () => true\n      },\n      {\n        title:'未读',\n        value:'unread',\n\t\t\t\tfilter: c => c.unread_count > 0,\n\t\t\t\tneedKeep: true\n      },\n\t\t\t{\n\t\t\t  title:'@我的',\n\t\t\t  value:'has_remind_msg',\n\t\t\t\tfilter: c => c?.remind_msg_ids?.length > 0,\n\t\t\t\tneedKeep: true\n\t\t\t},\n      // 群聊\n      {\n        title:'群聊',\n        value:'group',\n\t\t\t\tfilter: c => c.group_id\n      },\n      // 单聊\n      {\n        title:'单聊',\n        value:'single',\n\t\t\t\tfilter: c => !c.group_id\n      },\n      {\n        title:'星标',\n        value:'is_star',\n\t\t\t\tfilter: c => c.is_star\n      }\n    ]\n  }\n  __beforeFind(param){\n    if (typeof param === 'string'){\n      // 设置为默认按id查找会话，而不是按_id查找\n      return {id:param}\n    }else if(typeof param === 'object' && param !== null && !Array.isArray(param)){\n      const {user_id,friend_uid,conversation_id:id} = param\n      if(id){\n        param.id = id\n        delete param.conversation_id\n      }else if(user_id){\n        param.friend_uid = friend_uid || user_id\n        delete param.user_id\n      }\n      if('source' in param){\n        // 本地查找不需要source字段\n        const source = param.source\n        delete param.source\n        setTimeout(()=>{\n          // 在下一个事件循环中执行，加上source\n          /**\n           * 存在source字段的会话，表示此会话基于某个来源而被创建。\n           * 比如：群聊会话，可能是从群聊列表中创建的，此时source字段会记录群聊的id\n           * 用于在云端同步创建会话时的判断依据，比如：限制只能群成员和群管理员才能发起私聊时，确定指的是哪个群\n           */\n          const conversation = this.find(param)\n          if(conversation){\n            conversation.source = source\n          }\n        },0)\n      }\n      return param\n    }\n  }\n  __afterFind({res,param}){\n    const friend_uid = param?.friend_uid || param?.user_id\n     if(!res && friend_uid){\n      // console.error('Conversation __afterFind',res,param)\n      // 会话不存在，创建会话\n      const conversationData = {\n        friend_uid,\n\t\t\t\t\"user_info\": {\"nickname\": \"\"},\n        \"unread_count\": 0,\n        \"user_id\": $state.currentUser._id,\n        \"id\": $utils.getConversationId(friend_uid),\n        \"type\": param.friend_uid ? 1 : 2,\n        \"msgList\": [],\n        \"update_time\": Date.now(),\n        \"customSortTime\": Date.now(),\n        // 是本地临时会话数据\n        \"is_temp\": true\n      }\n      const conversation = this.add(conversationData)\n      return conversation\n    }\n    return res\n  }\n  __beforeAdd(datas){\n\t\t // console.log('__beforeAdd',datas)\n    if(!Array.isArray(datas)){\n      datas = [datas]\n    }\n    return datas.reduce((resList, item, index) => {\n      // console.log('resList',resList);\n      // 如果已存在，则直接返回原来的。不需要重复处理\n      let conversation_item = $state.conversation.find(item.id)\n      if (conversation_item) {\n        // console.log('此会话已经存在', conversation_item,conversation_item._update_time)\n        resList.push(conversation_item)\n        return resList\n      }\n      \n      // 把群数据都存到群列表\n      if(item.group_id){\n        $state.group.set(item.group_info)\n        // 删除冗余数据\n        delete item.group_info\n      } else {\n\t\t\t\t// 把会话相关的用户信息合并到 $users\n\t\t\t\tif(!item.is_temp) {\n\t\t\t\t\t$users.merge({[item.friend_uid]: item.user_info})\n\t\t\t\t}\n\t\t\t}\n      \n      // console.log('新增会话', item)\n      // 插入客户端创建此会话的时间\n      item.client_create_time = Date.now()\n      try{\n        let conversation = new ConversationItem(item)\n        // console.log('新增会话', conversation)\n        resList.push(conversation)\n      }catch(e){\n\t\t\t\tconsole.error('ConversationItem error',e)\n        $utils.reportError(e)\n      }\n      return resList\n    }, [])\n  }\n  __afterAdd(datas){\n    if(!Array.isArray(datas)){\n      datas = [datas]\n    }\n    \n    datas.forEach(conversation => {\n      const {msgList} = conversation\n      if(msgList){\n        // 服务端查找“应当”按消息“更新”时间排序，但显示需要按“创建”时间倒序，所以这里需要重新排序\n        msgList.sort((a,b) => a.create_time - b.create_time)\n        // 将会话数据带的msgList添加到msg中\n        conversation.msg.add(msgList,{canSetIsFull:true})\n        // 删除冗余数据\n        delete conversation.msgList\n      }\n    })\n    \n    \n    // 通过 setTimeout 0，使得在下一次事件循环中执行，避免冲突\n    setTimeout(() => {\n      // console.log('__afterAdd',datas)\n      datas.forEach(conversation => {\n        // init响应式字段\n        const activeProperty = this.find(conversation.id).activeProperty()\n        Object.keys(activeProperty).forEach(key => {\n          const item = activeProperty[key]\n          conversation[key] = computed(item)\n        })\n      })\n    }, 0)\n  }\n  __afterGet(datas){\n    // 获取单个会话时，检查群会话是否已经加载完群成员\n    if(datas && !Array.isArray(datas)){\n      const conversation = datas\n      const member = conversation.group?.member\n      if (member?.needLoadOnce) {\n        member.needLoadOnce = false\n        setTimeout(()=>member.loadMore(),1000)\n      }\n    }\n  }\n  __afterGetMore(datas){\n    if (this.dataList.length === 0 && datas.length >0){\n      // console.log('首次拉取会话')\n      getCloudMsg()\n    }\n  }\n  async __get(param) {\n    const loadMoreType = this.loadMore?.type || 'all'\n\t\tconst lastConversationKey = typeof loadMoreType === 'string' ? loadMoreType : Object.keys(loadMoreType).join('-') + \"_\" + Object.values(loadMoreType).join('-')\n    let conversation_id = param\n    if (typeof param === \"object\"){\n      conversation_id = param.id || param.conversation_id\n    }\n    const uniImCo = uniCloud.importObject(\"uni-im-co\",{customUI: true})\n    const limit = this.loadLimit\n    const conversationDatas = this.dataList\n    // 已有会话id的情况下，不设置更新时间条件\n    let maxLastMsgCreateTime = false;\n    let skip = 0;\n    const group_id = param?.group_id\n    if (!conversation_id && !group_id) {\n      // 会话列表的总数\n      const conversationCount = conversationDatas.length\n      if(conversationCount !== 0){\n        // 本地除置顶会话之外的普通会话个数\n        const normalConversationCount = conversationDatas.filter(i => !i.pinned).length\n        if(normalConversationCount === 0){\n          // 全部是置顶会话的情况下，当前会话有几个就跳过几个\n          skip = conversationCount\n        }else{\n          // 上一次请求的最后一条会话数据，用于分页查询。如果当前会话列表为空（比如：首次打开/被移除了所有会话/重新登录等），则此字段应当为false\n          maxLastMsgCreateTime = this.loadMore?.lastConversation?.[lastConversationKey]?.last_msg_create_time || false\n          // console.log('maxLastMsgCreateTime：'+maxLastMsgCreateTime,'loadMoreType:'+lastConversationKey);\n          if(maxLastMsgCreateTime){\n            // 查询时间与 maxLastMsgCreateTime 相同的会话数。（因为某些情况下，多个会话的update_time相同）\n            skip = conversationDatas.filter(i => i.last_msg_create_time === maxLastMsgCreateTime).length\n          }\n        }\n      }\n    }\n    // console.log('maxLastMsgCreateTime', maxLastMsgCreateTime);\n    let res = await uniImCo.getConversationList({\n      maxLastMsgCreateTime,\n      limit,\n      conversation_id,\n      skip,\n      // 是否要区分是否为置顶会话\n      distinguishPinned: loadMoreType === 'all',\n      type:loadMoreType,\n      group_id\n    })\n    if (!conversation_id) {\n\t\t\tif (typeof this.loadMore.lastConversation == \"object\") {\n\t\t\t\tthis.loadMore.lastConversation[lastConversationKey] = res.data[res.data.length - 1]\n\t\t\t}else{\n\t\t\t\tthis.loadMore.lastConversation = {[lastConversationKey]: res.data[res.data.length - 1]}\n\t\t\t}\n    }\n    return res.data\n  }\n  // 统计所有消息的未读数\n  unreadCount() {\n    // console.log('计算 conversation unreadCount')\n    const conversationDatas = $state.conversation.dataList\n    const cloudUnreadCountObj = $state.conversation.cloudUnreadCountObj\n    const localUnreadCountObj = conversationDatas.reduce((sum, item, index, array) => {\n      const {id,mute,unread_count} = item\n      if ( id in cloudUnreadCountObj || !mute && unread_count) {\n        sum[id] = mute ? 0 : unread_count\n      }\n      return sum\n    }, {})\n    // console.log('localUnreadCountObj n',Object.values(localUnreadCountObj).reduce((sum, item) => sum + item, 0))\n    const unreadCountObj = {\n      ...cloudUnreadCountObj,\n      ...localUnreadCountObj\n    }\n    // console.log('unreadCountObj', unreadCountObj)\n    return Object.values(unreadCountObj).reduce((sum, item) => sum + item, 0)\n  }\n  /**\n   * 清空所有未读消息数\n   */\n  clearUnreadCount(){\n    uniImCo.clearUnreadCount().then(res => {\n      let conversationDatas = $state.conversation.dataList.filter(i => i.unread_count > 0)\n      conversationDatas.forEach(i => {\n        i.unread_count = 0\n        // console.log('i',i)\n      })\n      this.cloudUnreadCountObj = {}\n    }).catch(err => {\n      console.error('clearUnreadCount err',err)\n    })\n  }\n  // 删除会话后，如果当前选中的会话是该会话，则清空当前选中的会话\n  __afterRemove(item){\n    if($state.currentConversationId == item.id){\n      $state.currentConversationId = null\n    }\n  }\n}"],"names":["uniCloud","CloudData","$state","$utils","$users","ConversationItem","uni","computed","getCloudMsg","uniImCo"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AASA,MAAM,UAAUA,cAAAA,GAAS,aAAa,WAAW;AAClC,MAAM,qBAAqBC,0CAAAA,UAAU;AAAA,EAClD,cAAc;AACZ,UAAO;AACP,SAAK,cAAc;AACnB,SAAK,WAAW;AAEhB,SAAK,sBAAsB,CAAE;AAE7B,SAAK,YAAY;AAIjB,SAAK,WAAW;AAAA,MACd;AAAA,QACE,OAAM;AAAA,QACN,OAAM;AAAA,QACV,QAAQ,MAAM;AAAA,MACX;AAAA,MACD;AAAA,QACE,OAAM;AAAA,QACN,OAAM;AAAA,QACV,QAAQ,OAAK,EAAE,eAAe;AAAA,QAC9B,UAAU;AAAA,MACP;AAAA,MACJ;AAAA,QACE,OAAM;AAAA,QACN,OAAM;AAAA,QACP,QAAQ,OAAK;;AAAA,+CAAG,mBAAH,mBAAmB,UAAS;AAAA;AAAA,QACzC,UAAU;AAAA,MACV;AAAA;AAAA,MAEE;AAAA,QACE,OAAM;AAAA,QACN,OAAM;AAAA,QACV,QAAQ,OAAK,EAAE;AAAA,MACZ;AAAA;AAAA,MAED;AAAA,QACE,OAAM;AAAA,QACN,OAAM;AAAA,QACV,QAAQ,OAAK,CAAC,EAAE;AAAA,MACb;AAAA,MACD;AAAA,QACE,OAAM;AAAA,QACN,OAAM;AAAA,QACV,QAAQ,OAAK,EAAE;AAAA,MACZ;AAAA,IACF;AAAA,EACF;AAAA,EACD,aAAa,OAAM;AACjB,QAAI,OAAO,UAAU,UAAS;AAE5B,aAAO,EAAC,IAAG,MAAK;AAAA,IACtB,WAAa,OAAO,UAAU,YAAY,UAAU,QAAQ,CAAC,MAAM,QAAQ,KAAK,GAAE;AAC5E,YAAM,EAAC,SAAQ,YAAW,iBAAgB,GAAE,IAAI;AAChD,UAAG,IAAG;AACJ,cAAM,KAAK;AACX,eAAO,MAAM;AAAA,MACd,WAAQ,SAAQ;AACf,cAAM,aAAa,cAAc;AACjC,eAAO,MAAM;AAAA,MACd;AACD,UAAG,YAAY,OAAM;AAEnB,cAAM,SAAS,MAAM;AACrB,eAAO,MAAM;AACb,mBAAW,MAAI;AAOb,gBAAM,eAAe,KAAK,KAAK,KAAK;AACpC,cAAG,cAAa;AACd,yBAAa,SAAS;AAAA,UACvB;AAAA,QACF,GAAC,CAAC;AAAA,MACJ;AACD,aAAO;AAAA,IACR;AAAA,EACF;AAAA,EACD,YAAY,EAAC,KAAI,MAAK,GAAE;AACtB,UAAM,cAAa,+BAAO,gBAAc,+BAAO;AAC9C,QAAG,CAAC,OAAO,YAAW;AAGrB,YAAM,mBAAmB;AAAA,QACvB;AAAA,QACJ,aAAa,EAAC,YAAY,GAAE;AAAA,QACxB,gBAAgB;AAAA,QAChB,WAAWC,kCAAAA,MAAO,YAAY;AAAA,QAC9B,MAAMC,kCAAAA,MAAO,kBAAkB,UAAU;AAAA,QACzC,QAAQ,MAAM,aAAa,IAAI;AAAA,QAC/B,WAAW,CAAE;AAAA,QACb,eAAe,KAAK,IAAK;AAAA,QACzB,kBAAkB,KAAK,IAAK;AAAA;AAAA,QAE5B,WAAW;AAAA,MACZ;AACD,YAAM,eAAe,KAAK,IAAI,gBAAgB;AAC9C,aAAO;AAAA,IACR;AACD,WAAO;AAAA,EACR;AAAA,EACD,YAAY,OAAM;AAEhB,QAAG,CAAC,MAAM,QAAQ,KAAK,GAAE;AACvB,cAAQ,CAAC,KAAK;AAAA,IACf;AACD,WAAO,MAAM,OAAO,CAAC,SAAS,MAAM,UAAU;AAG5C,UAAI,oBAAoBD,kCAAAA,MAAO,aAAa,KAAK,KAAK,EAAE;AACxD,UAAI,mBAAmB;AAErB,gBAAQ,KAAK,iBAAiB;AAC9B,eAAO;AAAA,MACR;AAGD,UAAG,KAAK,UAAS;AACfA,0CAAAA,MAAO,MAAM,IAAI,KAAK,UAAU;AAEhC,eAAO,KAAK;AAAA,MACpB,OAAa;AAET,YAAG,CAAC,KAAK,SAAS;AACjBE,8CAAM,OAAC,MAAM,EAAC,CAAC,KAAK,UAAU,GAAG,KAAK,UAAS,CAAC;AAAA,QAChD;AAAA,MACD;AAIE,WAAK,qBAAqB,KAAK,IAAK;AACpC,UAAG;AACD,YAAI,eAAe,IAAIC,mDAAgB,iBAAC,IAAI;AAE5C,gBAAQ,KAAK,YAAY;AAAA,MAC1B,SAAM,GAAE;AACXC,sBAAAA,MAAA,MAAA,SAAA,6DAAc,0BAAyB,CAAC;AACpCH,0CAAM,MAAC,YAAY,CAAC;AAAA,MACrB;AACD,aAAO;AAAA,IACR,GAAE,EAAE;AAAA,EACN;AAAA,EACD,WAAW,OAAM;AACf,QAAG,CAAC,MAAM,QAAQ,KAAK,GAAE;AACvB,cAAQ,CAAC,KAAK;AAAA,IACf;AAED,UAAM,QAAQ,kBAAgB;AAC5B,YAAM,EAAC,QAAO,IAAI;AAClB,UAAG,SAAQ;AAET,gBAAQ,KAAK,CAAC,GAAE,MAAM,EAAE,cAAc,EAAE,WAAW;AAEnD,qBAAa,IAAI,IAAI,SAAQ,EAAC,cAAa,KAAI,CAAC;AAEhD,eAAO,aAAa;AAAA,MACrB;AAAA,IACP,CAAK;AAID,eAAW,MAAM;AAEf,YAAM,QAAQ,kBAAgB;AAE5B,cAAM,iBAAiB,KAAK,KAAK,aAAa,EAAE,EAAE,eAAgB;AAClE,eAAO,KAAK,cAAc,EAAE,QAAQ,SAAO;AACzC,gBAAM,OAAO,eAAe,GAAG;AAC/B,uBAAa,GAAG,IAAII,cAAQ,SAAC,IAAI;AAAA,QAC3C,CAAS;AAAA,MACT,CAAO;AAAA,IACF,GAAE,CAAC;AAAA,EACL;AAAA,EACD,WAAW,OAAM;;AAEf,QAAG,SAAS,CAAC,MAAM,QAAQ,KAAK,GAAE;AAChC,YAAM,eAAe;AACrB,YAAM,UAAS,kBAAa,UAAb,mBAAoB;AACnC,UAAI,iCAAQ,cAAc;AACxB,eAAO,eAAe;AACtB,mBAAW,MAAI,OAAO,SAAQ,GAAG,GAAI;AAAA,MACtC;AAAA,IACF;AAAA,EACF;AAAA,EACD,eAAe,OAAM;AACnB,QAAI,KAAK,SAAS,WAAW,KAAK,MAAM,SAAQ,GAAE;AAEhDC,yDAAa;AAAA,IACd;AAAA,EACF;AAAA,EACK,MAAM,OAAO;AAAA;;AACjB,YAAM,iBAAe,UAAK,aAAL,mBAAe,SAAQ;AAC9C,YAAM,sBAAsB,OAAO,iBAAiB,WAAW,eAAe,OAAO,KAAK,YAAY,EAAE,KAAK,GAAG,IAAI,MAAM,OAAO,OAAO,YAAY,EAAE,KAAK,GAAG;AAC5J,UAAI,kBAAkB;AACtB,UAAI,OAAO,UAAU,UAAS;AAC5B,0BAAkB,MAAM,MAAM,MAAM;AAAA,MACrC;AACD,YAAMC,WAAUT,cAAAA,GAAS,aAAa,aAAY,EAAC,UAAU,KAAI,CAAC;AAClE,YAAM,QAAQ,KAAK;AACnB,YAAM,oBAAoB,KAAK;AAE/B,UAAI,uBAAuB;AAC3B,UAAI,OAAO;AACX,YAAM,WAAW,+BAAO;AACxB,UAAI,CAAC,mBAAmB,CAAC,UAAU;AAEjC,cAAM,oBAAoB,kBAAkB;AAC5C,YAAG,sBAAsB,GAAE;AAEzB,gBAAM,0BAA0B,kBAAkB,OAAO,OAAK,CAAC,EAAE,MAAM,EAAE;AACzE,cAAG,4BAA4B,GAAE;AAE/B,mBAAO;AAAA,UACjB,OAAa;AAEH,qCAAuB,sBAAK,aAAL,mBAAe,qBAAf,mBAAkC,yBAAlC,mBAAwD,yBAAwB;AAEvG,gBAAG,sBAAqB;AAEtB,qBAAO,kBAAkB,OAAO,OAAK,EAAE,yBAAyB,oBAAoB,EAAE;AAAA,YACvF;AAAA,UACF;AAAA,QACF;AAAA,MACF;AAED,UAAI,MAAM,MAAMS,SAAQ,oBAAoB;AAAA,QAC1C;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA;AAAA,QAEA,mBAAmB,iBAAiB;AAAA,QACpC,MAAK;AAAA,QACL;AAAA,MACN,CAAK;AACD,UAAI,CAAC,iBAAiB;AACvB,YAAI,OAAO,KAAK,SAAS,oBAAoB,UAAU;AACtD,eAAK,SAAS,iBAAiB,mBAAmB,IAAI,IAAI,KAAK,IAAI,KAAK,SAAS,CAAC;AAAA,QACtF,OAAQ;AACJ,eAAK,SAAS,mBAAmB,EAAC,CAAC,mBAAmB,GAAG,IAAI,KAAK,IAAI,KAAK,SAAS,CAAC,EAAC;AAAA,QACtF;AAAA,MACC;AACD,aAAO,IAAI;AAAA,IACZ;AAAA;AAAA;AAAA,EAED,cAAc;AAEZ,UAAM,oBAAoBP,wCAAO,aAAa;AAC9C,UAAM,sBAAsBA,wCAAO,aAAa;AAChD,UAAM,sBAAsB,kBAAkB,OAAO,CAAC,KAAK,MAAM,OAAO,UAAU;AAChF,YAAM,EAAC,IAAG,MAAK,aAAY,IAAI;AAC/B,UAAK,MAAM,uBAAuB,CAAC,QAAQ,cAAc;AACvD,YAAI,EAAE,IAAI,OAAO,IAAI;AAAA,MACtB;AACD,aAAO;AAAA,IACR,GAAE,EAAE;AAEL,UAAM,iBAAiB,kCAClB,sBACA;AAGL,WAAO,OAAO,OAAO,cAAc,EAAE,OAAO,CAAC,KAAK,SAAS,MAAM,MAAM,CAAC;AAAA,EACzE;AAAA;AAAA;AAAA;AAAA,EAID,mBAAkB;AAChB,YAAQ,iBAAgB,EAAG,KAAK,SAAO;AACrC,UAAI,oBAAoBA,wCAAO,aAAa,SAAS,OAAO,OAAK,EAAE,eAAe,CAAC;AACnF,wBAAkB,QAAQ,OAAK;AAC7B,UAAE,eAAe;AAAA,MAEzB,CAAO;AACD,WAAK,sBAAsB,CAAE;AAAA,IACnC,CAAK,EAAE,MAAM,SAAO;AACdI,oBAAAA,MAAc,MAAA,SAAA,6DAAA,wBAAuB,GAAG;AAAA,IAC9C,CAAK;AAAA,EACF;AAAA;AAAA,EAED,cAAc,MAAK;AACjB,QAAGJ,wCAAO,yBAAyB,KAAK,IAAG;AACzCA,wCAAM,MAAC,wBAAwB;AAAA,IAChC;AAAA,EACF;AACH;;"}