{"version":3,"file":"msgEvent.js","sources":["uni_modules/uni-im/sdk/init/msgEvent.js"],"sourcesContent":["import config from '@/uni_modules/uni-im/common/config.js';\nimport $utils from '@/uni_modules/uni-im/sdk/utils/index.js';\nimport $extensions from '@/uni_modules/uni-im/sdk/methods/extensions.js';\nimport $state from '../state/index.js';\n// #ifdef H5\nimport EasyWebNotification from './EasyWebNotification';\nconst easyWebNotification = new EasyWebNotification();\n// #endif\n// nvue下页面之间数据是隔离的需要挂载到$state上\n$state.ext.onMsgFnList = []\nconst msgEvent = {\n  emitMsg(res) {\n    if ($state.isDisabled) {\n      return console.log('uniIm isDisabled')\n    }\n    if (res.data.payload.device_id == $state.systemInfo.deviceId) {\n      return console.log('当前设备发的消息，不用接收；忽略');\n    }\n    $state.ext.onMsgFnList.forEach(fn => {\n      fn(res)\n    })\n  },\n  onMsg(res) {\n    $state.ext.onMsgFnList.push(res)\n  },\n  offMsg(fn) {\n    $state.ext.onMsgFnList = $state.ext.onMsgFnList.filter(item => item != fn)\n  }\n}\n\nexport default msgEvent;\n\n// 默认注册了一个监听收到im消息后的事件\nmsgEvent.onMsg(async res=>{\n    // console.log('收到im消息', res);\n    const {\n      payload\n    } = res.data;\n    const msg = payload.data\n    // console.log({msg});\n    // 超长文本传输时的id\n    if (msg.LongMsg) {\n      const db = uniCloud.database();\n      let res = await db.collection('uni-im-msg')\n        .where({\n          \"_id\": msg._id,\n          \"conversation_id\": msg.conversation_id // conversation_id 必传否则会被触发器拦截\n        })\n        .get()\n      // console.log(res);\n      if (res.result.errCode == 0) {\n        payload.data.body = res.result.data[0].body\n      } else {\n        console.error('超长文本类型消息查库失败', msg._id);\n      }\n    }\n    await Promise.all($extensions.invokeExts('before-on-im-msg', msg))\n    // console.log('payload------', payload.device_id, $state.systemInfo.deviceId);\n    // console.log(777);\n    // 更新本地users信息\n    if(msg.nickname){\n      const {nickname,avatar_file,from_uid:_id} = msg\n      const aboutUser = $state.users[_id]\n      if(aboutUser){\n        aboutUser.nickname = nickname\n        aboutUser.avatar_file = avatar_file\n      }else{\n        $state.users[_id] = {nickname,avatar_file}\n      }\n      // console.error('更新本地users信息', msg.from_uid, msg.nickname,$state.users[_id]);\n    }else{\n      // console.error('msg.nickname不存在', msg);\n    }\n    const {\n      conversation_id,\n      group_id\n    } = msg\n    // console.log('msgmsgmsgmsgmsg.msg',msg);\n    // 拿到收到消息的会话对象\n    let conversation = $state.conversation.find(conversation_id)\n    let isNewCreateConversation = false\n    if (!conversation) {\n      isNewCreateConversation = true\n      conversation = await $state.conversation.get(conversation_id)\n    }\n    \n    if (!conversation) {\n      // 当前用户自己点退出登录的时候，最后一条退出消息通知来之前 会话已经被本地移除属于正常情况\n      console.log('找不到会话对象 id:'+ conversation_id);\n      return\n    }\n    \n    // 处理其他设备已读某会话的情况\n    if (msg.type == 'clear-conversation-unreadCount') {\n      if (conversation.update_time < msg.create_time) {\n        conversation.update_time = msg.create_time\n        conversation.unread_count = 0\n        // 同时去掉通知栏消息\n        // #ifdef H5\n        //关闭所有通知栏\n        easyWebNotification.closeAllNotification()\n        easyWebNotification.recoverTitle()\n        // #endif\n        \n        // #ifdef APP\n        //清理系统通知栏消息和app角标\n        plus.push.clear()\n        plus.runtime.setBadgeNumber(0)\n        // #endif\n        \n      }\n      // 阻止后续动作\n      return\n    }\n\t\t\n\t\t// 处理会话信息更新\n\t\tif (msg.action == 'setUnreadGroupNoticeId') {\n\t\t\tif (msg.body.type != 'add') {\n\t\t\t\t// 除了添加动作，更新和删除都需要把之前的消息撤回\n\t\t\t\tconversation.msg.dataList.forEach(item => {\n\t\t\t\t\tif (item.body.notice_id == msg.body.notice_id) {\n\t\t\t\t\t\titem.is_revoke = true\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t}\n\t\t\t\n\t\t\t\n\t\t\tif(msg.body.type === 'delete'){\n\t\t\t\t// 相等的情况下才能删除，否则会出现删除旧公告把新公告的通知“提示符”给清除的情况\n\t\t\t\tif (conversation.unread_group_notice_id === msg.body.notice_id) {\n\t\t\t\t\tconversation.unread_group_notice_id = false\n\t\t\t\t}\n\t\t\t\treturn // 删除动作无需添加新的群公告，这里阻止继续运行\n\t\t\t} else {\n\t\t\t\tconsole.log('设置群公告提示符', msg.body.notice_id);\n\t\t\t\t// 先设置为false，再设置为指定值触发更新\n\t\t\t\tconversation.unread_group_notice_id = false\n\t\t\t\tawait $utils.sleep(100)\n\t\t\t\tconversation.unread_group_notice_id = msg.body.notice_id\n\t\t\t}\n\t\t}\n\t\t\n    const isReadableMsg = $utils.isReadableMsg(msg)\n    const isMuteMsg = $utils.isMuteMsg(msg)\n    const canCreateNotification = isReadableMsg && \n                                  // 会话不是免打扰的\n                                  !conversation.mute &&\n                                  // 消息不是系统配置了免打扰的\n                                  !isMuteMsg &&\n                                  // 不是自己发的消息\n                                  msg.from_uid != $state.currentUser._id\n    // 判断并创建通知栏消息\n    // #ifdef H5\n    if (canCreateNotification) {\n      if (!$state.ext.appIsActive) {\n        easyWebNotification.create({\n          \"title\": payload.title,\n          \"option\": {\n            \"body\": payload.content,\n            conversation_id,\n            \"icon\": payload.avatar_file ? payload.avatar_file.url :\n              'https://web-assets.dcloud.net.cn/unidoc/zh/uni.png'\n          }\n        })\n      }\n\n      // 调用扩展程序告知有新消息到达\n      $extensions.invokeExts('ui-new-message')\n    }\n    // #endif\n    \n    /**\n     * 排除会话中已包含此消息的情况\n     */\n    if (!conversation.msg.find(msg._id)) {\n      conversation.msg.add(msg)\n      if (\n        // 不是正在对话的会话，且不是自己发的消息，就给会话的未读消息数+1\n        $state.currentConversationId != msg.conversation_id &&\n        // 为可读消息\n        isReadableMsg &&\n        // 消息不是系统配置了免打扰的\n        !isMuteMsg &&\n        msg.from_uid != $state.currentUser._id &&\n        // 新创建的会话直接读取云端的未读消息数，本地不需要 ++\n        !isNewCreateConversation\n      ) {\n        conversation.unread_count++\n      }\n    }\n    // 如果socket已经关闭的情况下收到消息，说明消息来源浏览器页签之间通讯 不需要重复存库\n    if (!$state.socketIsClose) {\n      // conversation.msgManager.localMsg.add(msg)\n    }\n    \n    // #ifdef APP\n    // console.log('notification type=>',res.type);\n    if (res.type == 'click'){\n      let currentPages = getCurrentPages()\n      let topViewRoute = currentPages[currentPages.length - 1].route\n      // console.log('topViewRoute',topViewRoute);\n      if (topViewRoute == 'uni_modules/uni-im/pages/chat/chat') {\n        uni.redirectTo({\n          url: '/uni_modules/uni-im/pages/chat/chat?conversation_id=' + msg.conversation_id,\n          complete(e) {\n            console.log(e);\n          }\n        })\n      } else {\n        uni.navigateTo({\n          url: '/uni_modules/uni-im/pages/chat/chat?conversation_id=' + msg.conversation_id,\n          complete(e) {\n            console.log(e);\n          }\n        })\n      }\n    }else{\n      let currentPages = getCurrentPages()\n      let topViewRoute = currentPages[currentPages.length - 1].route\n      // console.log('topViewRoute',topViewRoute);\n      let pathList = [\n        'uni_modules/uni-im/pages/chat/chat',\n        'uni_modules/uni-im/pages/index/index',\n        'uni_modules/uni-im/pages/userList/userList',\n        'uni_modules/uni-im/pages/contacts/contacts'\n      ]\n      if (canCreateNotification && (!$state.ext.appIsActive || !pathList.includes(topViewRoute)) ) {\n        // console.log('payload',payload);\n        let {\n          content,\n          data,\n          title,\n          avatar_file\n        } = payload\n        let url = avatar_file ? avatar_file.url : ''\n        let icon = '_www/uni_modules/uni-im/static/avatarUrl.png'\n        //安卓才有头像功能，再执行下载\n        if ($state.systemInfo.platform == \"android\") {\n          if (avatar_file) {\n            let downloadFileRes = await uni.downloadFile({\n              url: avatar_file.url\n            });\n            icon = downloadFileRes[1]?.tempFilePath\n          }\n        }\n        uni.createPushMessage({\n          title,\n          content,\n          payload,\n          icon,\n          channelId: config.uniPush.channel.id,\n          category: 'IM',\n        })\n      } else if (conversation_id != $state.currentConversationId) {\n        // uni.showToast({\n        // \ttitle: '收到新消息请注意查看',\n        // \ticon: 'none'\n        // });\n      }\n    }\n    // #endif\n})"],"names":["$state","uni","uniCloud","res","$extensions","$utils"],"mappings":"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"}