{"version":3,"file":"GroupMember.class.js","sources":["uni_modules/uni-im/sdk/state/GroupMember.class.js"],"sourcesContent":["import CloudData from '@/uni_modules/uni-im/sdk/ext/CloudData.class.js'\nimport GroupMemberItem from '@/uni_modules/uni-im/sdk/state/GroupMemberItem.class.js'\nimport $users from '@/uni_modules/uni-im/sdk/methods/users.js';\nimport $extensions from '@/uni_modules/uni-im/sdk/methods/extensions.js';\nconst dbJQL = uniCloud.databaseForJQL()\nconst dbJQLCommand = dbJQL.command\nconst $ = dbJQL.command.aggregate\n\nexport default class GroupMember extends CloudData {\n  constructor({group_id}={}) {\n    super()\n    this.group_id = group_id\n    this.indexKey = 'users._id'\n    this.needLoadOnce = true\n  }\n  __beforeAdd(datas){\n    // console.log('GroupMember beforeAdd',datas);\n    // 调用扩展点中的方法\n    // $extensions.invokeExts('before-add-group-member', datas)\n    \n    // 为了方便使用，将用户信息缓存到全局\n    const userInfoObj = datas.reduce((obj,item) => {\n      obj[item.users._id] = item.users\n      return obj\n    },{})\n    $users.merge(userInfoObj)\n\t\treturn datas.map(item => new GroupMemberItem(item))\n  }\n  findByUid(uid) {\n    console.warn('member.findByUid 已经过期，去直接member.find(uid)查找');\n    return this.dataList.find(item => item.users._id === uid)\n  }\n  __beforeFind(param){\n    if (typeof param === 'string'){\n      // 设置为默认按users._id查找群成员，而不是按_id查找\n      return {\n        users:{\n          _id:param\n        }\n      }\n    }else{\n      return param\n    }\n  }\n  async __get() {\n    // console.error('pull GroupMember Data param',this.group_id);\n    let _where = `\"group_id\" == \"${this.group_id}\"`\n    if (this.lastItem) {\n      const {active_time,_id} = this.lastItem\n      _where += ` && !(role in [\"admin\"]) && (\"active_time\" < ${active_time} || (\"active_time\" == ${active_time} && \"_id\" < \"${_id}\"))`\n    }\n    let res = await dbJQL.collection(\n        dbJQL.collection('uni-im-group-member')\n            .where(_where)\n            .orderBy(\"role desc,active_time desc,_id desc\")\n            .limit(this.loadLimit)\n            .getTemp(),\n        dbJQL.collection('uni-id-users').field('_id,nickname,avatar_file,realname_auth').getTemp()\n      )\n      .get()\n    // console.error('拉取到群成员数据',_where,res.data.length,length);\n    this.lastItem = res.data[res.data.length - 1]\n    return res.data.map(item => {\n      const usersInfo = item.user_id[0];\n      delete item.user_id\n      item.users = usersInfo\n      return item\n    })\n  }\n}"],"names":["uniCloud","CloudData","$users","GroupMemberItem","uni"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;AAIA,MAAM,QAAQA,cAAQ,GAAC,eAAgB;AAClB,MAAM;AACjB,MAAM,QAAQ;AAET,MAAM,oBAAoBC,0CAAAA,UAAU;AAAA,EACjD,YAAY,EAAC,SAAQ,IAAE,IAAI;AACzB,UAAO;AACP,SAAK,WAAW;AAChB,SAAK,WAAW;AAChB,SAAK,eAAe;AAAA,EACrB;AAAA,EACD,YAAY,OAAM;AAMhB,UAAM,cAAc,MAAM,OAAO,CAAC,KAAI,SAAS;AAC7C,UAAI,KAAK,MAAM,GAAG,IAAI,KAAK;AAC3B,aAAO;AAAA,IACR,GAAC,EAAE;AACJC,wCAAM,OAAC,MAAM,WAAW;AAC1B,WAAO,MAAM,IAAI,UAAQ,IAAIC,kDAAe,gBAAC,IAAI,CAAC;AAAA,EACjD;AAAA,EACD,UAAU,KAAK;AACbC,kBAAAA,MAAA,MAAA,QAAA,2DAAa,6CAA6C;AAC1D,WAAO,KAAK,SAAS,KAAK,UAAQ,KAAK,MAAM,QAAQ,GAAG;AAAA,EACzD;AAAA,EACD,aAAa,OAAM;AACjB,QAAI,OAAO,UAAU,UAAS;AAE5B,aAAO;AAAA,QACL,OAAM;AAAA,UACJ,KAAI;AAAA,QACL;AAAA,MACF;AAAA,IACP,OAAS;AACH,aAAO;AAAA,IACR;AAAA,EACF;AAAA,EACK,QAAQ;AAAA;AAEZ,UAAI,SAAS,kBAAkB,KAAK,QAAQ;AAC5C,UAAI,KAAK,UAAU;AACjB,cAAM,EAAC,aAAY,IAAG,IAAI,KAAK;AAC/B,kBAAU,gDAAgD,WAAW,yBAAyB,WAAW,gBAAgB,GAAG;AAAA,MAC7H;AACD,UAAI,MAAM,MAAM,MAAM;AAAA,QAClB,MAAM,WAAW,qBAAqB,EACjC,MAAM,MAAM,EACZ,QAAQ,qCAAqC,EAC7C,MAAM,KAAK,SAAS,EACpB,QAAS;AAAA,QACd,MAAM,WAAW,cAAc,EAAE,MAAM,wCAAwC,EAAE,QAAS;AAAA,MAC3F,EACA,IAAK;AAER,WAAK,WAAW,IAAI,KAAK,IAAI,KAAK,SAAS,CAAC;AAC5C,aAAO,IAAI,KAAK,IAAI,UAAQ;AAC1B,cAAM,YAAY,KAAK,QAAQ,CAAC;AAChC,eAAO,KAAK;AACZ,aAAK,QAAQ;AACb,eAAO;AAAA,MACb,CAAK;AAAA,IACF;AAAA;AACH;;"}