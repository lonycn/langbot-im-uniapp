{"version":3,"file":"Msg.class.js","sources":["uni_modules/uni-im/sdk/state/Msg.class.js"],"sourcesContent":["import {watch} from 'vue'\nimport $state from '../state/index.js'\nimport $methods from '@/uni_modules/uni-im/sdk/methods/index.js';\nimport $utils from '@/uni_modules/uni-im/sdk/utils/index.js';\nimport CloudData from '@/uni_modules/uni-im/sdk/ext/CloudData.class.js'\nimport MsgItem from './MsgItem.class.js'\nconst dbJQL = uniCloud.databaseForJQL()\nconst dbJQLcmd = dbJQL.command;\n\nexport default class Msg extends CloudData {\n  constructor(conversation_id) {\n    super()\n    this.loadLimit = 10 //每次拉取的条数\n    this.conversation_id = conversation_id\n    this.isFull = false\n  }\n  // 可见的消息列表（过滤掉不可见的消息，比如：消息撤回指令、更新群头像指令...）\n  visibleDataList(){\n    return this.dataList.filter(msg => $utils.isReadableMsg(msg))\n  }\n  __saveToLocal(datas,{canSetIsFull}){\n    // #ifndef H5\n    return\n    // #endif\n    \n    let transaction = $state.indexDB.transaction('uni-im-msg', 'readwrite')\n    let objectStore = transaction.objectStore('uni-im-msg') // 仓库对象\n    let index = 0\n    let length = datas.length\n    const addData = (data) =>{\n      data.__isLocal = true\n      const res = objectStore.add(data)\n      res.onsuccess = (e) => {\n        // console.log('resolve',e, index, length);\n        index++\n        if (index == length) {\n          // console.log('add - success', e);\n        }\n      }\n      res.onerror = (e) => {\n        console.error('add - failed', e);\n        reject(e)\n      }\n    }\n    // 拷贝一份数据，避免修改原数据\n    const dataList = JSON.parse(JSON.stringify(datas))\n    dataList.forEach(data => {\n      // console.log('data._id',data._id);\n      if(data._id){\n        objectStore.index(\"_id\").get(data._id).onsuccess = event => {\n          // console.log('get',event.target.result);\n          if (event.target.result) {\n            // console.error('canSetIsFull',canSetIsFull)\n            if(canSetIsFull && !this.isFull){\n              // console.log('数据已存在，设置canSetIsFull', canSetIsFull, data.body);\n              this.isFull = true\n            }\n            // console.log('数据已存在', data._id);\n            return\n          }else{\n            // console.log('可以新增', data._id);\n            addData(data)\n          }\n        }\n      }else{\n        addData(data)\n      }\n    })\n  }\n  __beforeAdd(datas){\n    const currentConversation = $state.conversation.find(this.conversation_id)\n    // 如果插入的消息，包含指令（撤回、新用户进群、用户离群、@我 等）则执行指令\n    // 允许插入消息之前，执行一些操作\n    $state.extensions.invokeExts('before-add-msg', datas)\n    datas.forEach(async data => {\n      // console.log('beforeAdd',data);\n      // 如果此消息，创建时间在当前设备创建此会话之前，则无需执行\n      const conversation_time =  currentConversation.update_time || currentConversation.client_create_time || 0\n      if (data.create_time <= conversation_time) {\n        return //console.log('消息创建时间早于会话最新时间，不执行',data.create_time,conversation_time);\n      }\n      // 调用扩展程序，使扩展程序可以在消息插入之前执行一些操作\n      $methods.msgTypes.get(data.type)?.beforeLocalAdd?.(data,currentConversation)\n      // 如果收到的是撤回消息指令\n      if (data.type === \"revoke_msg\") {\n        return currentConversation.revokeMsg(data.body.msg_id, false)\n      }\n      // 订单支付通知\n      if(data.type === 'pay-notify' && data.from_uid === \"system\"){\n        // console.log('收到订单支付通知',data);\n        const {order_id,group_id,pay_channel,status} = data.body\n        let currentConversation = $state.conversation.find({group_id})\n        if(currentConversation){\n          const msg = currentConversation.msg.find({body:{\"order_id\":order_id}})\n          if(!msg){\n            console.log('pay-notify 未找到订单消息',data);\n            return\n          }\n          console.log('pay-notify msg',msg);\n          msg.body.pay_channel = pay_channel\n          msg.body.status = status || 1\n          msg.body.pay_time = data.create_time\n          msg.body.pay_notify = data\n        }else{\n          console.log('pay-notify 未找到会话',data);\n        }\n      }\n      const current_uid = $state.currentUser._id\n      //  系统通知\n      if (data.type === \"system\") {\n        // 用户退出、被踢出群\n        if ([\"group-exit\", \"group-expel\"].includes(data.action)) {\n          data.body.user_id_list.forEach(uid=>{\n            // 从列表中移除这些用户\n            currentConversation.group.member.remove({\"users\":{\"_id\":uid}})\n            currentConversation.group.member_count --\n          })\n          if (data.body.user_id_list.includes(current_uid)) {\n            // 移除相关会话\n            $state.conversation.remove(currentConversation.id)\n            // 删除相关群\n            $state.group.remove(currentConversation.group_id)\n          }\n        } else if (data.action === \"group-dissolved\") {\n          // 解散群\n          $state.conversation.remove(currentConversation.id)\n          $state.group.remove(currentConversation.group_id)\n        }\n        // 新用户加群\n        else if (data.action === \"join-group\") {\n          const {new_member_list,user_id_list} = data.body\n          // 如果新加入此群的用户id列表，包括当前用户 \n          if(user_id_list.includes(current_uid)){\n            // 此会话当前设备之前就加载过，需要重新加载群会话和成员列表（因为被踢出群期间可能有其他用户进群、发消息等）\n            if(currentConversation.client_create_time < data.create_time){\n              const uniImCo = uniCloud.importObject(\"uni-im-co\",{customUI: true})\n              let res = await uniImCo.getConversationList({\"conversation_id\":currentConversation.id})\n              Object.assign(currentConversation, res.data[0])\n              //先清空 群成员\n              currentConversation.msg.reset()\n              currentConversation.group.reset()\n              //重新拉取 群成员\n              await currentConversation.group.loadMore()\n              // 获取群公告\n              currentConversation.has_unread_group_notification = !!currentConversation.group.notification\n            }\n          }else{\n            // 将新成员加入到群成员列表\n            // 获取成员信息 get方法会从云端拉取本地不存在的用户数据\n            await $state.users.get(new_member_list.map(i=>i.user_id))\n            new_member_list.forEach(member=>{\n              // 补全用户信息\n              member.users = $state.users[member.user_id]\n              currentConversation.group.member.add(member)\n              currentConversation.group.member_count ++\n            })\n          }\n        }\n        //更新群资料\n        else if (data.action.indexOf(\"update-group-info-\") === 0) {\n          if(data.action === \"update-group-info-mute_all_members\" && currentConversation?.group?.mute_all_members != data?.body?.updateData?.mute_all_members){\n            const {mute_all_members} = data.body.updateData\n            currentConversation.group.member.dataList.forEach(member => {\n              member.mute_type += (mute_all_members ? 1 : -1)\n            })\n          }\n          currentConversation.group = Object.assign(currentConversation.group,data.body.updateData)\n          const {notification} = data.body.updateData\n          if(data.action === \"update-group-info-notification\"){\n            console.log('收到群公告');\n            currentConversation.has_unread_group_notification = true\n          }\n        }\n        else if(data.action === \"set-group-admin\"){\n          const {user_id,addRole,delRole} = data.body\n          const {role} = currentConversation.group.member.find(user_id)\n          if(addRole.length != 0){\n            role.push(...addRole)\n          }else if(delRole.length != 0){\n            console.log('delRole',delRole);\n            delRole.forEach(r=>{\n              console.log('r',r);\n              console.log('role',role);\n              const index = role.findIndex(i => i === r)\n              console.log('index',index);\n              if(index > -1){\n                role.splice(index,1)\n              }\n            })\n          }\n          // console.log('设置群管理员',currentConversation.group.member.find(user_id));\n        }\n        // \n        else if(data.action === \"set-group-member-ext-plugin-order-info\"){\n          const {user_id,group_id,dcloud_plugin_order_info} = data.body\n          const member = currentConversation.group.member.find(user_id)\n          if(!member.ext){\n            member.ext = {}\n          }\n          console.log('设置群成员插件订单信息',member);\n          member.ext.dcloud_plugin_order_info = dcloud_plugin_order_info\n        }\n      }\n      \n      if (\n        // 如果收到的是群聊且带@的消息\n        data.group_id &&\n        data.call_uid && \n        (\n          // @所有人 或 @我\n          data.call_uid == '__ALL' ||\n          data.call_uid.includes(current_uid)\n        )\n      ) {\n        currentConversation.remind_msg_ids.push(data._id)\n      }\n    })\n    \n    return datas.map(item => new MsgItem(item))\n  }\n  __afterAdd(datas,{canSetIsFull}){\n    datas.forEach(msg => {\n      watch(msg, (newMsg)=>msg.__updateAfter(newMsg), {deep: true})\n    })\n    // console.log('canSetIsFull',canSetIsFull)\n    // 存到客户端数据库中\n    if(datas[0] && !datas[0].__isLocal){\n      const msgs = datas.filter(data => {\n        let needSave = $utils.isReadableMsg(data)\n        if (needSave) {\n          return true\n        }else{\n          // console.log('不需要保存',data);\n          return false\n        }\n      })\n      this.__saveToLocal(msgs,{canSetIsFull})\n    }\n    return datas\n  }\n  async __getLocalData({\n    minTime = 0,\n    maxTime = Date.now(),\n    limit = this.loadLimit,\n    _id = false,\n    orderBy = {\n      // asc 升序，desc 降序\n      \"create_time\": \"desc\"\n    }\n  }){\n    // #ifndef H5\n    return []\n    // #endif\n    \n    // console.log('minTime',minTime,'maxTime',maxTime,'limit',limit,'_id',_id,'orderBy',orderBy)\n    const start = Date.now()\n    let datas = await new Promise((resolve, reject) => {\n      //  根据 id 查询\n      if (_id) {\n        // console.error('$state.indexDB~~~',$state.indexDB)\n        let getRequest = $state.indexDB.transaction(\"uni-im-msg\")\n          .objectStore(\"uni-im-msg\")\n          .index(\"_id\")\n          .get(_id)\n        getRequest.onsuccess = function(event) {\n          if (getRequest.result) {\n            resolve([getRequest.result])\n          } else {\n            resolve([])\n          }\n        };\n        getRequest.onerror = function(event) {\n          console.log('Error getting data');\n          resolve([])\n        };\n        return\n      }\n\n      // 设置查询索引\n      // console.log('kkkkkkkk',[this.conversation_id, minTime], [this.conversation_id,maxTime]);\n      let range = IDBKeyRange.bound([this.conversation_id, minTime], [this.conversation_id, maxTime])\n      // 传入的 prev 表示是降序遍历游标，默认是next表示升序；\n      // $state.indexDB 在im的场景下，查始终是降序遍历游标 orderBy指的是查询结果的排序方式\n      let sort = \"prev\"\n      // console.log('sortsortsortsortsortsortsort',sort);\n      // console.error('$state.indexDB~~~',$state.indexDB)\n      let task = $state.indexDB.transaction(\"uni-im-msg\")\n        .objectStore(\"uni-im-msg\")\n        .index(\"conversation_id-create_time\")\n        .openCursor(range, sort)\n      \n      let datas = [], index = 0;\n      task.onsuccess = function(event) {\n        let cursor = event.target.result;\n        if (cursor) {\n          // console.log('cursor',cursor.value);\n          // 排除边界值\n          if (![minTime, maxTime].includes(cursor.value.create_time)) {\n            datas.push(cursor.value)\n            index++\n          }else{\n            // console.log('边界值',cursor.value.create_time);\n          }\n          \n          // console.log('index',index,limit);\n          if (limit && index === limit) {\n            resolve(datas)\n          } else {\n            cursor.continue();\n          }\n        } else {\n          resolve(datas)\n        }\n      }\n      task.onerror = function(err) {\n        console.error(err);\n        resolve([])\n      }\n    })\n    // console.log('本地查找耗时',Date.now() - start);\n    datas.sort((a, b) => {\n      if (orderBy.create_time == 'asc') {\n        return a.create_time - b.create_time\n      } else {\n        return b.create_time - a.create_time\n      }\n    })\n    // console.log('本地查到的datas：',datas);\n    return datas\n  }\n  async __get(){\n    //已经拉取的数据中时间最小的值，作为最大\n    let maxTime = this.dataList[0]?.create_time || Date.now()\n    let localData = []\n    if(this.isFull){\n      // 如果云端和本地数据重合了，则可以先从本地查\n      // console.log('如果云端和本地数据重合了，则可以先从本地查',this.isFull);\n      localData = await this.__getLocalData({\n        maxTime: maxTime,\n        limit: this.loadLimit,\n        orderBy: {\n          \"create_time\": \"asc\",\n        },\n      })\n      // 如果本地有数据，直接返回\n      if (localData.length === this.loadLimit) {\n        // console.log('本地有数据',localData);\n        return localData\n      }else{\n        // console.error('本地未拉满'+this.loadLimit+'条，从云端拉取 this.isFull',this.isFull);\n      }\n    }else{\n      // console.log('本地数据未与云端重合，需从云端拉取',this.isFull);\n    }\n    \n    maxTime = localData[0]?.create_time || maxTime\n    \n    // 本地没有数据，从云端拉取\n    const where = {\n      \"conversation_id\": this.conversation_id\n    }\n    if(this.preWhere){\n      Object.assign(where, this.preWhere)\n    }\n    if(maxTime){\n      where.update_time = dbJQLcmd.lt(maxTime)\n    }\n    let data;\n    let res = await dbJQL.collection('uni-im-msg')\n      .where(where)\n      .limit(this.loadLimit - localData.length)\n      .orderBy('update_time', 'desc')\n      .get()\n    // console.error('云端查找到', res.data.length ,'条',res.data);\n    \n    // 服务端查找“应当”按消息“更新”时间排序，但显示需要按“创建”时间倒序，所以这里需要重新排序\n    res.data.sort((a,b) => b.create_time - a.create_time)\n    data = res.data.concat(localData)\n    // console.error('合并本地与云端为', data.length ,'条',data);\n    // console.error('where', where,data);\n    return data\n  }\n  __canSeaveToDataMap(msg){\n    // 本地创建的消息，不保存到dataMap中。等发送成功后，服务端回调_id再由__updateAfter方法更新到dataMap中\n    return msg._id?.indexOf('temp_') === -1\n  }\n}"],"names":["uniCloud","CloudData","$utils","$state","$methods","currentConversation","uni","MsgItem","watch"],"mappings":"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"}