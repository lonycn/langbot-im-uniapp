{"version":3,"file":"notification.js","sources":["uni_modules/uni-im/sdk/methods/notification.js"],"sourcesContent":["/**\n * 系统消息\n */\nimport state from '../state/index.js';\nimport $utils from '@/uni_modules/uni-im/sdk/utils';\nconst db = uniCloud.database();\nexport default {\n  get: ({\n    type,\n    excludeType\n  } = {}) => {\n    const notificationDatas = state.notification.dataList\n    if (notificationDatas) {\n      return notificationDatas.reduce((sum, item) => {\n        // 指定需要的类型\n        if (type) {\n          //兼容字符串和数组\n          typeof type == 'string' ? type = [type] : ''\n          if (type.includes(item.payload.subType)) {\n            sum.push(item)\n          }\n          // 排查指定的类型\n        } else if (excludeType) {\n          //兼容字符串和数组\n          typeof excludeType == 'string' ? excludeType = [excludeType] : ''\n          if (!excludeType.includes(item.payload.subType)) {\n            sum.push(item)\n          }\n        } else {\n          sum.push(item)\n        }\n        return sum\n      }, [])\n    } else {\n      return false\n    }\n  },\n  async loadMore() {\n    let res = await db.collection('uni-im-notification')\n      .aggregate()\n      .match('\"payload.type\" == \"uni-im-notification\" && \"user_id\" == $cloudEnv_uid')\n      .sort({\n        create_time: -1\n      })\n      .limit(1000)\n      .end()\n    this.add(res.result.data)\n    this.hasMore == (res.result.data.length != 0)\n  },\n  add(datas) {\n    if (!Array.isArray(datas)) {\n      datas = [datas]\n    }\n\n    let notificationDatas = datas.concat(state.notification.dataList)\n    // 正序，实现时间大的覆盖时间小的\n    notificationDatas.sort((a, b) => a.create_time - b.create_time)\n    // console.log('notificationDatas',notificationDatas);\n    let obj = {}\n    for (var i = 0; i < notificationDatas.length; i++) {\n      let item = notificationDatas[i]\n      // 去重操作\n      let {\n        subType,\n        unique\n      } = item.payload\n      obj[unique ? (subType + \"_\" + unique) : (Date.now() + \"_\" + i)] = item\n    }\n    let dataList = []\n    for (let key in obj) {\n      let item = obj[key]\n      dataList.push(item)\n    }\n    // 倒序 实现，最新的消息在最上面\n    dataList.sort((a, b) => b.create_time - a.create_time)\n    // console.log('dataList',dataList)\n    state.notification.dataList = dataList\n  },\n  unreadCount(param = {}) {\n    let notificationDatas = this.get(param)\n    let unreadCount = notificationDatas.reduce((sum, item, index, array) => {\n      if (!item.is_read) {\n        sum++\n      }\n      return sum\n    }, 0)\n\n    // console.log('最新的未读数:', unreadCount, data);\n\t\t$utils.setTabBarBadge(2, unreadCount)\n\t\t\n    if (unreadCount) {\n      return unreadCount + ''\n    } else {\n      return ''\n    }\n  }\n}\n"],"names":["uniCloud","state","$utils"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;AAKA,MAAM,KAAKA,cAAAA,GAAS;AACpB,MAAe,eAAA;AAAA,EACb,KAAK,CAAC;AAAA,IACJ;AAAA,IACA;AAAA,EACD,IAAG,OAAO;AACT,UAAM,oBAAoBC,wCAAM,aAAa;AAC7C,QAAI,mBAAmB;AACrB,aAAO,kBAAkB,OAAO,CAAC,KAAK,SAAS;AAE7C,YAAI,MAAM;AAER,iBAAO,QAAQ,WAAW,OAAO,CAAC,IAAI,IAAI;AAC1C,cAAI,KAAK,SAAS,KAAK,QAAQ,OAAO,GAAG;AACvC,gBAAI,KAAK,IAAI;AAAA,UACd;AAAA,QAEF,WAAU,aAAa;AAEtB,iBAAO,eAAe,WAAW,cAAc,CAAC,WAAW,IAAI;AAC/D,cAAI,CAAC,YAAY,SAAS,KAAK,QAAQ,OAAO,GAAG;AAC/C,gBAAI,KAAK,IAAI;AAAA,UACd;AAAA,QACX,OAAe;AACL,cAAI,KAAK,IAAI;AAAA,QACd;AACD,eAAO;AAAA,MACR,GAAE,EAAE;AAAA,IACX,OAAW;AACL,aAAO;AAAA,IACR;AAAA,EACF;AAAA,EACK,WAAW;AAAA;AACf,UAAI,MAAM,MAAM,GAAG,WAAW,qBAAqB,EAChD,UAAW,EACX,MAAM,uEAAuE,EAC7E,KAAK;AAAA,QACJ,aAAa;AAAA,MACrB,CAAO,EACA,MAAM,GAAI,EACV,IAAK;AACR,WAAK,IAAI,IAAI,OAAO,IAAI;AACxB,WAAK,YAAY,IAAI,OAAO,KAAK,UAAU;AAAA,IAC5C;AAAA;AAAA,EACD,IAAI,OAAO;AACT,QAAI,CAAC,MAAM,QAAQ,KAAK,GAAG;AACzB,cAAQ,CAAC,KAAK;AAAA,IACf;AAED,QAAI,oBAAoB,MAAM,OAAOA,kCAAAA,MAAM,aAAa,QAAQ;AAEhE,sBAAkB,KAAK,CAAC,GAAG,MAAM,EAAE,cAAc,EAAE,WAAW;AAE9D,QAAI,MAAM,CAAE;AACZ,aAAS,IAAI,GAAG,IAAI,kBAAkB,QAAQ,KAAK;AACjD,UAAI,OAAO,kBAAkB,CAAC;AAE9B,UAAI;AAAA,QACF;AAAA,QACA;AAAA,MACD,IAAG,KAAK;AACT,UAAI,SAAU,UAAU,MAAM,SAAW,KAAK,QAAQ,MAAM,CAAE,IAAI;AAAA,IACnE;AACD,QAAI,WAAW,CAAE;AACjB,aAAS,OAAO,KAAK;AACnB,UAAI,OAAO,IAAI,GAAG;AAClB,eAAS,KAAK,IAAI;AAAA,IACnB;AAED,aAAS,KAAK,CAAC,GAAG,MAAM,EAAE,cAAc,EAAE,WAAW;AAErDA,4CAAM,aAAa,WAAW;AAAA,EAC/B;AAAA,EACD,YAAY,QAAQ,IAAI;AACtB,QAAI,oBAAoB,KAAK,IAAI,KAAK;AACtC,QAAI,cAAc,kBAAkB,OAAO,CAAC,KAAK,MAAM,OAAO,UAAU;AACtE,UAAI,CAAC,KAAK,SAAS;AACjB;AAAA,MACD;AACD,aAAO;AAAA,IACR,GAAE,CAAC;AAGNC,4CAAO,eAAe,GAAG,WAAW;AAElC,QAAI,aAAa;AACf,aAAO,cAAc;AAAA,IAC3B,OAAW;AACL,aAAO;AAAA,IACR;AAAA,EACF;AACH;;"}