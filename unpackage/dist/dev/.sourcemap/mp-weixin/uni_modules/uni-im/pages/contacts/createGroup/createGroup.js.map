{"version":3,"file":"createGroup.js","sources":["uni_modules/uni-im/pages/contacts/createGroup/createGroup.vue","uni_modules/uni-im/pages/contacts/createGroup/createGroup.vue?type=page"],"sourcesContent":["<template>\n  <view class=\"create-group-box\" :class=\"{'join-grpop':group_id}\">\n    <view class=\"header-box\">\n      <uni-search-bar v-model=\"keyword\" placeholder=\"搜索\" bgColor=\"#fff\" :radius=\"100\" \n        @cancel=\"doClear();isFocus = true\" @clear=\"doClear\" :isFocus=\"isFocus\" @focus=\"isFocus = true\" @blur=\"isFocus = false\" ></uni-search-bar>\n    </view>\n    <uni-list class=\"content-box\" :border=\"false\">\n      <uni-im-info-card @click=\"checkboxChange(item._id)\" v-for=\"(item,index) in friendList\" :key=\"index\" :avatar-circle=\"true\" :title=\"item.nickname\" :border=\"false\" :clickable=\"true\"\n        :avatarUrl=\"item.avatar_file?.url || '/uni_modules/uni-im/static/avatarUrl.png'\">\n        <template v-slot:left>\n          <view class=\"checkbox\" :class=\"{\n            'disabled': groupMemberUid.includes(item._id),\n            'checked': checkFriendIds.includes(item._id)}\n          \">\n            <uni-icons type=\"checkmarkempty\" color=\"#FFF\" v-if=\"groupMemberUid.includes(item._id) || checkFriendIds.includes(item._id)\"></uni-icons>\n          </view>\n        </template>\n      </uni-im-info-card>\n      <uni-im-load-state :status=\"loading?'loading':(hasMore?'hasMore':'noMore')\"\n        :contentText='{\"contentnomore\": friendList.length?\"没有更多好友\":\"没有可以选择的好友\"}'></uni-im-load-state>\n      <uni-list-item style=\"height: 60px;\" :border=\"false\">\n        <!-- 占位，用于此元素上方显示 操作按钮 -->\n      </uni-list-item>\n    </uni-list>\n    <view class=\"foot-box\">\n      <!-- 创建新群可以不选择好友直接创建，邀请好友进群必须选择好友 -->\n      <button :disabled=\"group_id? !checkFriendIds.length : false \" class=\"btn\" type=\"primary\"\n        @click=\"createGroup\">{{btnText}}{{checkFriendNum}}</button>\n    </view>\n  </view>\n</template>\n\n<script>\n  import uniIm from '@/uni_modules/uni-im/sdk/index.js';\n  const db = uniCloud.database();\n  export default {\n    emits: ['done'],\n    data() {\n      return {\n        loading: true,\n        hasMore: false,\n        keyword: '',\n        checkFriendIds: [],\n        friendData: [],\n        groupMemberUid: [], //选人进群时，已经在群里的人的id\n        group_id: false,\n        isFocus: false\n      }\n    },\n    computed: {\n      friendList() {\n        return this.friendData.filter(item => {\n          //转小写筛选\n          return (this.keyword == '' || item.nickname.toLowerCase().includes(this.keyword.toLowerCase()))\n        })\n      },\n      checkFriendNum() {\n        return this.checkFriendIds.length > 0 ? '（' + this.checkFriendIds.length + '）' : ''\n      },\n      btnText() {\n        return this.group_id ? '立即邀请' : '立即创建'\n      },\n      checkFriendsWidth() {\n        return this.checkFriendIds.length > 6 ? '100%' : this.checkFriendIds.length * 80 + 'px'\n      },\n      // checkFriendsSearchWidth() {\n      // \treturn this.checkFriendIds.length > 6 ? '360' : 720 - (this.checkFriendIds.length * 60)\n      // },\n      translateXWidth() {\n        return this.checkFriendIds.length > 6 ? this.checkFriendIds.length * 65 : '60'\n      },\n      checkFriendImg() {\n        return this.friendList.reduce((sum, current) => {\n          if (this.checkFriendIds.includes(current._id)) {\n            sum.push(current)\n          }\n          return sum\n        }, []).map(item => item.avatar_file)\n      }\n    },\n    async onLoad(options) {\n      this.setParam(options)\n    },\n    methods: {\n      async setParam(options = {}) {\n        console.log(\"group_id\", options);\n        if (options.group_id) {\n          this.group_id = options.group_id\n          if(!uniIm.isWidescreen){\n            uni.setNavigationBarTitle({\n              title: '邀请新成员'\n            })\n          }\n          //查本群，成员，\n          let res = await db.collection('uni-im-group-member').where({\n              group_id: options.group_id\n            })\n            .get()\n          console.log(\"res:查本群，成员 \", res);\n          this.groupMemberUid = res.result.data.map(item => item.user_id)\n          // console.log('this.groupMemberUid', this.groupMemberUid);\n        }\n        this.getFriendsData()\n      },\n      async getFriendsData() {\n        let whereString = {}\n        if (this.keyword) {\n          whereString = `\n          \t\"_id\"\t\t== \t\"${this.keyword}\" ||\n          \t\"username\"\t== \t\"${this.keyword}\" || \n          \t\"nickname\"\t== \t\"${this.keyword}\" || \n          \t\"email\"\t\t== \t\"${this.keyword}\" || \n          \t\"mobile\"\t== \t\"${this.keyword}\" \n          `\n        }\n        let res = await db.collection(\n          db.collection('uni-im-friend').where('\"user_id\" == $cloudEnv_uid').field('friend_uid,mark,class_name')\n          .getTemp(),\n          db.collection('uni-id-users').where(whereString).field('_id,nickname,avatar_file').getTemp()\n        ).get()\n        // console.log(res);\n        let data = res.result.data\n        data.forEach((item, index) => {\n          if (item.friend_uid[0]) {\n            data[index] = item.friend_uid[0]\n          } else {\n            delete data[index]\n          }\n        })\n        this.friendData = data\n        this.loading = false\n        this.hasMore = this.friendList.length != 0\n      },\n      doClear() {\n        this.keyword = ''\n        this.getFriendsData()\n      },\n      checkboxChange(user_id) {\n        if (this.groupMemberUid.includes(user_id)){\n          return console.log('已经在群里了');\n        }\n        console.log(\"checkboxChange-value\",user_id);\n        this.checkFriendIds = this.checkFriendIds.includes(user_id) ? this.checkFriendIds.filter(item => item != user_id) : this.checkFriendIds.concat(user_id)\n        console.log(\"checkboxChange\",this.checkFriendIds);\n      },\n      async createGroup() {\n        // console.log('创建', this.checkFriendIds.length)\n        const uniImCo = uniCloud.importObject(\"uni-im-co\")\n        let res = await uniImCo.chooseUserIntoGroup({\n          user_ids: this.checkFriendIds,\n          group_id: this.group_id\n        })\n        this.checkFriendIds = []\n        // console.log('createGroup',res);\n        if (this.group_id) {\n          if (uniIm.isWidescreen) {\n            this.$emit('done')\n          } else {\n            uni.navigateBack({\n              delta: 1\n            })\n          }\n        } else {\n          // #ifdef H5\n          if (uniIm.isWidescreen) {\n            uni.$emit('uni-im-toChat', 'group_' + res.data.group_id)\n          } else {\n            uni.redirectTo({\n              url: '/uni_modules/uni-im/pages/chat/chat?conversation_id=' + 'group_' + res.data.group_id,\n              animationDuration: 300,\n              fail: (e) => {\n                console.log(e);\n              }\n            })\n          }\n          // #endif\n\n          // #ifndef H5\n          uni.redirectTo({\n            url: '/uni_modules/uni-im/pages/chat/chat?conversation_id=' + 'group_' + res.data.group_id,\n            animationDuration: 300,\n            complete: (e) => {\n              console.log(e);\n            }\n          })\n          // #endif\n        }\n      }\n    }\n  }\n</script>\n\n<style lang=\"scss\">\n@import \"@/uni_modules/uni-im/common/baseStyle.scss\";\n.create-group-box {\n  position: relative;\n  background-color: #F9F9F9;\n  flex: 1;\n  .header-box {\n    flex-direction: column;\n    background-color: #F9F9F9;\n  }\n  \n  .content-box {\n   width: 100%;\n   overflow: auto;\n  }\n  \n  .label-box {\n    flex-direction: row;\n    align-items: center;\n    background-color: #FFF;\n    padding: 5px 0;\n  }\n  \n  .checkbox {\n    margin: 12px 10px 0 0;\n    border: 1px solid #DDD;\n    width: 20px;\n    height: 20px;\n    justify-content: center;\n    align-items: center;\n    border-radius: 100px;\n    &.disabled {\n      background-color: #1189e9;\n      opacity: 0.5;\n      border: none;\n      cursor: not-allowed;\n    }\n    &.checked {\n      background-color: #1189e9;\n      border: none;\n    }\n  }\n  \n  .foot-box {\n    position: fixed;\n    bottom: 15px;\n    // 注意：此页面可能显示在pc端所以不能用750rpx，而用100%\n    width: 100%;\n    height: 60px;\n    justify-content: center;\n    align-items: center;\n  }\n  \n  .foot-box .btn {\n    width: 300px;\n  }\n  \n  /* #ifdef H5 */\n  @media screen and (min-device-width:960px){\n    width: 100%;\n    margin: 10px auto;\n    &.join-grpop {\n      width: 800px;\n    }\n    .content-box {\n      height: calc(100vh - 175px);\n    }\n    .content-box ::v-deep .info-card {\n      cursor: pointer;\n    }\n    .foot-box {\n      position: absolute;\n    }\n  }\n  /* #endif */\n}\n</style>","import MiniProgramPage from '/Users/orange/aicode/langbot/web_client/langbot-im-uniapp/uni_modules/uni-im/pages/contacts/createGroup/createGroup.vue'\nwx.createPage(MiniProgramPage)"],"names":["uniCloud","uni","uniIm"],"mappings":"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"}