{"version":3,"file":"index.js","sources":["uni_modules/uni-im/pages/index/index.vue","uni_modules/uni-im/pages/index/index.vue?type=page"],"sourcesContent":["<template>\n\t<view id=\"page\" class=\"uni-im-index\">\n\t\t<!-- #ifdef H5 -->\n\t\t<!-- 布局最左侧 菜单栏 -->\n\t\t<view id=\"left-view\" v-if=\"isWidescreen\" @click=\"chatInfoIsShow = false;\">\n\t\t\t<uni-im-img class=\"user-avatar item\" @click=\"toUcenter\" :src=\"avatarUrl\" width=\"40px\" height=\"40px\"\n\t\t\t\tborderRadius=\"10px\"></uni-im-img>\n\t\t\t<uni-badge class=\"chat-icon item\" @contextmenu.prevent.native=\"openConversationMenu($event,'unreadMsgCount')\" size=\"small\" :text=\"unreadMsgCount\" absolute=\"rightTop\" type=\"error\">\n\t\t\t\t<uni-icons  @click=\"showChatView\"\n\t\t\t\t\t:color=\"contactsViewIsShow?'#c5c5c5':'#5fc08e'\" size=\"32\" type=\"chatbubble-filled\"></uni-icons>\n\t\t\t</uni-badge>\n\t\t\t<uni-badge class=\"item\" id=\"show-contacts-btn\" size=\"small\" :text=\"unreadnotificationCount\" absolute=\"rightTop\" type=\"error\">\n\t\t\t\t<uni-icons @click=\"showContactsView\" :color=\"contactsViewIsShow?'#5fc08e':'#c5c5c5'\" size=\"32\"\n\t\t\t\t\ttype=\"staff-filled\"></uni-icons>\n\t\t\t</uni-badge>\n      <template v-for=\"(component,index) in extIndexMenu\" :key=\"index\" class=\"item\">\n        <component :is=\"component\"></component>\n      </template>\n      \n      <view class=\"download\">\n        <uni-link class=\"item\" href=\"https://im.dcloud.net.cn/uni-portal.html\" text=\"下载地址\">\n          <image class=\"icon\" src=\"https://mp-172f98d6-0564-4974-980e-d78dc9189b22.cdn.bspapp.com/cloudstorage/af92325b-6993-4765-8c80-4c69eb900fa7.png\" mode=\"widthFix\"></image>\n        \t<text class=\"title\">APP端</text>\n        </uni-link>\n        \n        <uni-link class=\"item\" href=\"https://ext.dcloud.net.cn/plugin?id=16984\">\n          <image class=\"icon\" src=\"https://qiniu-web-assets.dcloud.net.cn/unidoc/zh/hx.png\" mode=\"widthFix\"></image>\n        \t<text class=\"title\">通知插件</text>\n        </uni-link>\n        \n        <uni-link class=\"item\" href=\"https://gitcode.net/dcloud/hello-uni-im/-/tree/v3\">\n          <image class=\"icon\" src=\"https://web-assets.dcloud.net.cn/unidoc/zh/git-1.png\" mode=\"widthFix\"></image>\n        \t<text class=\"title\">开源仓库</text>\n        </uni-link>\n      </view>\n\t\t</view>\n\t\t<!-- #endif -->\n\n\t\t<!-- 会话列表 -->\n\t\t<view id=\"center-view\">\n\t\t\t<!-- #ifdef H5 -->\n      <template v-if=\"isWidescreen\">\n        <!-- 搜索会话用户、聊天记录... -->\n        <view id=\"search-bar-box\" v-show=\"!contactsViewIsShow\">\n        \t<uni-search-bar v-model=\"keyword\" id=\"search-bar\" radius=\"5\" placeholder=\"搜索\" bgColor=\"#F3F3F3\" clearButton=\"auto\" cancelButton=\"none\"></uni-search-bar>\n        \t<!-- <uni-icons class=\"pointer\" @click=\"beforeJoinGroup\" color=\"#aaa\" size=\"26\" type=\"plus\"></uni-icons> -->\n        \t<view class=\"add-icon-box\">\n            <uni-im-icons title=\"加入群聊\" class=\"pointer add-icon\" @click=\"beforeJoinGroup\" color=\"#999\" size=\"12\" code=\"eab9\"></uni-im-icons>\n          </view>\n        </view>\n        <view id=\"uni-im-contacts-box\" v-show=\"contactsViewIsShow\">\n        \t<uni-im-contacts @clickMenu=\"clickMenu\" id=\"uni-im-contacts\" ref=\"uni-im-contacts\"></uni-im-contacts>\n        </view>\n        <!-- 会话查找结果列表 -->\n        <uni-im-filtered-conversation-list\n          ref=\"uni-im-filtered-conversation-list\"\n          id=\"conversation-list-box\"\n          :keyword=\"keyword\"\n          @to-chat=\"toChat\"\n          @to-chat-filtered=\"toChatFiltered\"\n\t\t\t\t\t@close=\"closeChatFiltered\"\n        ></uni-im-filtered-conversation-list>\n      </template>\n\t\t\t<!-- #endif -->\n      <!-- 会话用户列表 -->\n      <uni-im-conversation-list \n\t\t\t\tv-show=\"!keyword\"\n        ref=\"uni-im-conversation-list\" @clickItem=\"toChat($event.id)\"\n        @change=\"conversationList = $event\" :active-conversation-id=\"currentConversationId\"\n        id=\"conversation-list-box\"\n      ></uni-im-conversation-list>\n\t\t</view>\n\n\t\t<!-- #ifdef H5 -->\n\t\t<view id=\"right-view\" v-if=\"isWidescreen\">\n\t\t\t<!-- 聊天窗口 -->\n\t\t\t<view id=\"chat-view-box\">\n\t\t\t\t<chat-filtered ref=\"chat-filtered\" @to-chat=\"toChat\" @fragment-closed=\"fragmentClosed\"/>\n\t\t\t\t<template v-if=\"!contactsViewIsShow && currentConversationId\">\n          <view class=\"header\">\n            <uni-icons @click=\"showChatInfo\" class=\"more\" type=\"more-filled\" size=\"20\"></uni-icons>\n          </view>\n          <view class=\"content\">\n            <chat-view ref=\"chat-view\"></chat-view>\n            <view v-if=\"chatInfoIsShow\" class=\"chatInfoBox\" @click.stop=\"chatInfoIsShow = false\">\n              <view @click.stop class=\"group-info-parent\">\n                <uni-im-group-info v-if=\"currentConversation.group_id\" ref=\"group-info\"></uni-im-group-info>\n                <uni-im-chat-info v-else ref=\"chat-info\"></uni-im-chat-info>\n              </view>\n            </view>\n          </view>\n\t\t\t\t</template>\n    \n\t\t\t\t<view v-else id=\"ccid-is-null-tip\">\n          <image class=\"img\" src=\"https://im.dcloud.net.cn/static/favicon.ico\" mode=\"widthFix\"></image>\n\t\t\t\t\t<text class=\"text\">未选择会话对象</text>\n\t\t\t\t</view>\n\t\t\t</view>\n\t\t\t<view id=\"dynamic-component-box\" v-show=\"contactsViewIsShow\">\n\t\t\t\t<view class=\"dynamic-component-title\">{{view2Title}}</view>\n\t\t\t\t<component ref=\"dynamicComponent\" :is=\"dynamicComponentName\"></component>\n\t\t\t</view>\n\t\t</view>\n    <uniImVideo></uniImVideo>\n    <uni-im-contextmenu ref=\"uni-im-contextmenu\" />\n\t\t<!-- #endif -->\n\t</view>\n</template>\n\n<script>\n  import {markRaw} from \"vue\";\n\timport uniIm from '@/uni_modules/uni-im/sdk/index.js';\n\timport contacts from '@/uni_modules/uni-im/pages/contacts/contacts';\n\n\t// #ifdef H5\n  import chatView from '@/uni_modules/uni-im/pages/chat/chat';\n  import chatFiltered from '@/uni_modules/uni-im/pages/chat/chat-filtered';\n\timport notification from '@/uni_modules/uni-im/pages/contacts/notification/notification';\n\timport addPeopleGroups from '@/uni_modules/uni-im/pages/contacts/addPeopleGroups/addPeopleGroups';\n\timport groupList from '@/uni_modules/uni-im/pages/contacts/groupList/groupList';\n\timport createGroup from '@/uni_modules/uni-im/pages/contacts/createGroup/createGroup';\n\timport chatInfo from '@/uni_modules/uni-im/pages/chat/info';\n\timport groupInfo from '@/uni_modules/uni-im/pages/group/info';\n  import uniImVideo from '@/uni_modules/uni-im/pages/common/video/video';\n  let currentScrollTop = 0\n\t// #endif\n\n\tlet lastConversationId = false\n\texport default {\n\t\t// #ifdef H5\n\t\tcomponents: {\n\t\t\tchatView,\n      chatFiltered,\n\t\t\t\"uni-im-contacts\": contacts,\n\t\t\t\"uni-im-notification\": notification,\n\t\t\t\"uni-im-addPeopleGroups\": addPeopleGroups,\n\t\t\t\"uni-im-groupList\": groupList,\n\t\t\t\"uni-im-createGroup\": createGroup,\n\t\t\t\"uni-im-chat-info\": chatInfo,\n\t\t\t\"uni-im-group-info\": groupInfo,\n      uniImVideo\n\t\t},\n\t\t// #endif\n\t\tdata() {\n\t\t\treturn {\n        extIndexMenu: uniIm.extensions.invokeExts(\"index-page-menu\").map(i=>markRaw(i.component)),\n\t\t\t\tusers: {},\n\t\t\t\tdynamicComponentName: 'uni-im-addPeopleGroups', //通过动态组件引入页面在pc端显示\n\t\t\t\tview2Title: '加人/加群',\n\t\t\t\tcontactsViewIsShow: false,\n\t\t\t\tchatInfoIsShow: false,\n\t\t\t\tcurrentConversation: {},\n        keyword:'',\n        conversationList: [],\n        filteredConversationId: false // 仅显示匹配的聊天记录的会话\n\t\t\t};\n\t\t},\n\t\tcomputed: {\n\t\t\t// 导入uniIm响应式数据，支持别名：比如:['a as b']\n\t\t\t...uniIm.mapState(['currentConversationId', 'isWidescreen']),\n\t\t\tunreadMsgCount() {\n\t\t\t\treturn uniIm.conversation.unreadCount()\n\t\t\t},\n\t\t\tunreadnotificationCount() {\n\t\t\t\treturn uniIm.notification.unreadCount()\n\t\t\t},\n\t\t\tavatarUrl() {\n\t\t\t\treturn uniIm.currentUser?.avatar_file?.url || '/uni_modules/uni-im/static/avatarUrl.png'\n\t\t\t}\n\t\t},\n\t\twatch: {\n\t\t\tunreadMsgCount: {\n\t\t\t\thandler(unreadMsgCount) {\n\t\t\t\t\t// console.log({\n\t\t\t\t\t// \tunreadMsgCount\n\t\t\t\t\t// });\n\n\t\t\t\t\t// #ifdef APP\n\t\t\t\t\tplus.runtime.setBadgeNumber(unreadMsgCount)\n\t\t\t\t\t// #endif\n\t\t\t\t\tuniIm.utils.setTabBarBadge(0, unreadMsgCount)\n\n\t\t\t\t\t// 调用扩展点，更新未读消息总数。\n\t\t\t\t\tuniIm.extensions.invokeExts('ui-update-unread-count', unreadMsgCount)\n\t\t\t\t},\n\t\t\t\timmediate: true,\n\t\t\t},\n\t\t\tcontactsViewIsShow(contactsViewIsShow) {\n\t\t\t\tif (contactsViewIsShow) {\n\t\t\t\t\tlastConversationId = this.currentConversationId\n\t\t\t\t\tuniIm.currentConversationId = false\n\t\t\t\t} else {\n\t\t\t\t\tif (lastConversationId) {\n\t\t\t\t\t\tuniIm.currentConversationId = lastConversationId\n\t\t\t\t\t\tthis.$nextTick(() => {\n\t\t\t\t\t\t\tthis.toChat(lastConversationId)\n\t\t\t\t\t\t})\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n      //  根据当前会话id，设置会话对象\n\t\t\tasync currentConversationId(id) {\n        if(id){\n          this.currentConversation = await uniIm.conversation.get(id)\n          // 如果是被隐藏的会话，取消隐藏\n          if(this.currentConversation.hidden){\n            this.currentConversation.hidden = false\n          }\n        }\n\t\t\t}\n\t\t},\n\t\tasync onLoad(param) {\n      console.log('onLoad',param)\n      /**\n       * 打开index页面之前的扩展点，用于自己扩展登录等逻辑\n       */\n      await Promise.all(uniIm.extensions.invokeExts('index-load-before-extra', param))\n      \n      const {tokenExpired} = uniIm.currentUser\n      if (tokenExpired < Date.now()) {\n      \tconsole.info('当前用户的登录状态无效，将自动跳转至登录页面。', param)\n      \tlet url = '/uni_modules/uni-id-pages/pages/login/login-withpwd?uniIdRedirectUrl='\n      \tlet paramString = '/uni_modules/uni-im/pages/index/index?'\n      \tfor (let key in param) {\n      \t\tparamString += `${key}=${param[key]}&`\n      \t}\n      \tparamString = paramString.substring(0, paramString.length - 1) //携带参数，实现登录成功后 跳回首页时传回\n      \turl += encodeURIComponent(paramString)\n      \treturn uni.redirectTo({\n      \t\turl\n      \t})\n      }\n      \n      uniIm.onInitDataAfter(()=>{\n        // console.log('onUniImInitDataAfter');\n        // 执行当前页面初始化\n        this.init(param)\n      })\n\t\t\t// #ifdef H5\n\t\t\t// 去掉链接后面的参数且不刷新\n\t\t\thistory.replaceState(null, '', window.location.href.split('?')[0])\n\t\t\t// #endif\n\t\t},\n    onShow(){\n      \n    },\n\t\tasync onReady() {\n      uni.$on('uni-im-toChat', param => {\n      \tif (param) {\n      \t\t// 关闭最后一次的会话id，防止切回后重新显示最后一次会话，而指定显示到某个会话\n      \t\tlastConversationId = false\n      \t\tthis.toChat(param)\n      \t}\n      \tthis.contactsViewIsShow = false\n      })\n\t\t\t// #ifdef H5\n      const deviceInfo = uni.getDeviceInfo()\n      if(deviceInfo.deviceType === 'pc'){\n        // about PWA start -\n        // 判断用户是否已经要求不再显示安装PWA的提示\n        const isNotShowInstallPWAPrompt = uni.getStorageSync('uni-im-data:isNotShowInstallPWAPrompt')\n        if(!isNotShowInstallPWAPrompt){\n          const mediaQuery = window.matchMedia('(display-mode: standalone)');\n          function handleMediaChange(event) {\n            // console.error('standalone',event.matches)\n            if (event.matches) {\n              document.body.classList.add('isPWA')\n            } else {\n              document.body.classList.remove('isPWA')\n              // console.error('window.installPWAPrompt',window.installPWAPrompt)\n              if(window.installPWAPrompt){\n                uni.showModal({\n                  content: '仅需 1 秒，即可快速安装本应用桌面端，畅享更好的体验。',\n                  cancelText: '不再提醒',\n                  confirmText: '安装',\n                  success: (res) => {\n                    if (res.confirm) {\n                      window.installPWAPrompt.prompt();\n                    }else{\n                      // console.error('不再提醒');\n                      uni.setStorage({\n                        key: 'uni-im-data:isNotShowInstallPWAPrompt',\n                        data: true\n                      })\n                    }\n                  }\n                });\n              }\n            }\n          }\n          mediaQuery.addListener(handleMediaChange);\n          handleMediaChange(mediaQuery);\n        }\n        // about PWA end -\n        \n        \n        const centerView = document.querySelector('#center-view')\n        const indexCenterViewWidth = uni.getStorageSync('uni-im-data:indexCenterViewWidth') || \"380px\"\n        centerView.style.width = indexCenterViewWidth\n        // 拖动center-view的 伪元素 after 来调整center-view的宽度\n        const resizeLine = document.createElement('div')\n        resizeLine.className = 'resize-line'\n        resizeLine.style = `\n          position: absolute;\n          top: 0;\n          right: 0;\n          width: 3px;\n          height: 100%;\n          cursor: col-resize;\n        `;\n        centerView.appendChild(resizeLine)\n        resizeLine.addEventListener('mousedown', (e) => {\n          e.preventDefault()\n          let startX = e.clientX\n          let startWidth = centerView.offsetWidth\n          document.onmousemove = (e) => {\n            let moveX = e.clientX - startX\n            const newWidth = startWidth + moveX\n            if(newWidth > 550){\n              // 改变鼠标样式，为向左箭头\n              document.body.style.cursor = 'w-resize';\n            }else if(newWidth < 200){\n              // 改变鼠标样式，为向右箭头\n              document.body.style.cursor = 'e-resize';\n            }else{\n              centerView.style.width = newWidth + 'px'\n              uni.setStorage({\n                key: 'uni-im-data:indexCenterViewWidth',\n                data: centerView.style.width\n              })\n            }\n          }\n          document.onmouseup = () => {\n            document.body.style.cursor = '';\n            document.onmousemove = null\n            document.onmouseup = null\n          }\n        })\n        const shortcutKeyFn = (keyName,event)=>{\n          const index = this.conversationList.findIndex(item=>item.id == this.currentConversationId)\n          if(keyName == 'ArrowUp' && index > 0){\n            this.toChat( this.conversationList[index - 1].id )\n            event.preventDefault();\n          }else if(keyName == 'ArrowDown' && index < this.conversationList.length){\n            this.toChat( this.conversationList[index + 1].id )\n            event.preventDefault();\n          }\n        }\n        uniIm.utils.shortcutKey.withMeta(shortcutKeyFn)\n        uniIm.utils.shortcutKey.withCtrl(shortcutKeyFn)\n        \n        if (!window.chrome && (deviceInfo.deviceType === 'pc' || deviceInfo.platform != 'ios')) {\n          let newElement = document.createElement('div')\n          newElement.innerHTML = `\n          <div id=\"tip-browser-compatibility\" style=\"background: #fff9ea;color: #ff9a43;position: fixed;top: 0;left: 0;width: 100vw;padding: 15px;font-size: 18px;\">\n          \t注意：本系统仅兼容chrome内核的浏览器，其他浏览器可能出现异常。<a href=\"https://www.google.cn/chrome/\">点此下载chrome浏览器</a>\n          </div>\n          `\n          document.body.appendChild(newElement)\n        }\n      }\n\t\t\t// #endif\n\t\t},\n\t\tonUnload() {\n\t\t},\n    onBackPress(e) {\n      const clRef = this.$refs['uni-im-conversation-list']\n      if(clRef.focusConversationId){\n        clRef.closeConversationMenu()\n        return true\n      }\n    },\n\t\tonHide() {},\n\t\tmethods: {\n\t\t\tfragmentClosed(){\n\t\t\t\t// 恢复选中的会话\n\t\t\t\tif (lastConversationId) {\n\t\t\t\t\tuniIm.currentConversationId = lastConversationId\n\t\t\t\t\tthis.$nextTick(() => {\n\t\t\t\t\t\tthis.toChat(lastConversationId)\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t},\n\t\t\tclickMenu(data) {\n\t\t\t\t// console.log('79879789798898798978789', data);\n\t\t\t\tthis.dynamicComponentName = data.componentName\n\n\t\t\t\tif (data.title) {\n\t\t\t\t\tthis.view2Title = data.title\n\t\t\t\t}\n\n        this.$nextTick(() => {\n        \tthis.$refs.dynamicComponent.setParam(data.param || {})\n          if (data.componentName == 'uni-im-createGroup') {\n            this.$refs.dynamicComponent.getFriendsData()\n          }\n        })\n\t\t\t\t// console.log('data.componentName----',data.componentName);\n\t\t\t},\n      /**\n       * @description 根据群id，申请加入群聊\n       * @param {Object} 群id\n       */\n      joinGroup(group_id){\n        console.log('group_id',group_id);\n        const db = uniCloud.database();\n        uni.showLoading({\n          title: '正在申请加群...',\n          mask: true\n        });\n        db.collection('uni-im-group-join').add({\n        \tgroup_id,\n        \t\"message\":''\n        }).then((res) => {\n        \tconsole.log(\"res: \",res);\n          if(res.result.isPass){\n            this.toChat(\"group_\" + group_id)\n          }else{\n            uni.showToast({\n            \ticon: 'none',\n            \ttitle: '已提交加群申请，等待管理员审核'\n            })\n          }\n        }).catch((err) => {\n        \tif(err.code === 10001){\n            console.log('已经是群成员 直接打开对应页面');\n        \t\treturn this.toChat(\"group_\" + group_id)\n        \t}\n        \tuni.showModal({\n        \t\tcontent: err.message || '请求服务失败',\n        \t\tshowCancel: false\n        \t})\n        })\n        .finally(()=>{\n          uni.hideLoading()\n        })\n      },\n      // #ifdef H5\n      beforeJoinGroup(){\n        let group_id = prompt(\"请输入群id\", \"\");\n        if (group_id) {\n          this.joinGroup(group_id)\n        }\n      },\n      // #endif\n\t\t\treadQrCode() {\n\t\t\t\tuni.scanCode({\n\t\t\t\t\tcomplete: (e) => {\n\t\t\t\t\t\t// console.log(e);\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tlet data = JSON.parse(e.result)\n\t\t\t\t\t\t\t// console.log(data);\n\t\t\t\t\t\t\tif (data.type == 'uni-im' && data.subType == \"groupInfo\") {\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t},\n\t\t\tasync init({\n\t\t\t\tconversation_id,\n\t\t\t\tgoods,\n\t\t\t\tuser_id,\n        joinGroup\n\t\t\t}) {\n        // console.log('init', {\n        //   conversation_id,\n        //   goods,\n        //   user_id\n        // });\n        if(user_id || conversation_id){\n          this.toChat(conversation_id || {user_id})\n        }\n        //  如果初始化时，指定了要访问的会话。将指定要访问的会话排序位置置顶，方便看到\n        setTimeout(()=> this.currentConversation.customIndex = Date.now(), 0);\n        \n\t\t\t\t//  如果列表小于30个会话，尝试着从云端拉取一次\n        if( this.conversationList.length < 30 ){\n          await this.$nextTick()\n          await this.$refs['uni-im-conversation-list'].loadMore()\n        }else{\n          console.log('会话列表已满一页，需要用户自己滚动到底，再拉取更多');\n        }\n\t\t\t\t\n\t\t\t\t// 传递参数goods（对象格式，包含：商品名称name，链接url。自动设置对话框默认内容\n\t\t\t\tif (this.isWidescreen && goods) {\n\t\t\t\t\t// console.log(goods);\n\t\t\t\t\tif (typeof goods != 'object') {\n\t\t\t\t\t\tgoods = JSON.parse(goods)\n\t\t\t\t\t}\n\t\t\t\t\tconst {\n\t\t\t\t\t\tname,\n\t\t\t\t\t\turl\n\t\t\t\t\t} = goods\n\t\t\t\t\tif (name && url) {\n\t\t\t\t\t\tsetTimeout(()=>{\n\t\t\t\t\t\t\tthis.$refs['chat-view'].chatInputContent = '【' + name + ':' + url + '】'\n\t\t\t\t\t\t}, 1000);\n\t\t\t\t\t}\n\t\t\t\t}\n        \n        /**\n         * 在本页面链接传递参数 joinGroup=group_id即可申请加入群，\n         * 比如：http://localhost:8082/#/uni_modules/uni-im/pages/index/index?joinGroup=xxx\n         */ \n        if(joinGroup){\n          this.joinGroup(joinGroup)\n        };\n\t\t\t},\n\t\t\tsearch(e) {\n\t\t\t\t// console.log(\"search-e: \" + JSON.stringify(e));\n\t\t\t\tuni.showToast({\n\t\t\t\t\ttitle: '加好友功能入口，暂时在左侧菜单的通讯录中',\n\t\t\t\t\ticon: 'none',\n\t\t\t\t\tduration: 3000\n\t\t\t\t});\n\t\t\t},\n\t\t\taddUser() {\n\t\t\t\tuni.showToast({\n\t\t\t\t\ttitle: '加好友功能入口，暂时在左侧菜单的通讯录中',\n\t\t\t\t\ticon: 'none',\n\t\t\t\t\tduration: 3000\n\t\t\t\t});\n\t\t\t},\n      showChatView() {\n        this.contactsViewIsShow = false\n        // 拿到所有存在未读消息的会话对象\n        const ucId = uniIm.conversation.dataList\n                          .filter(item => item.unread_count > 0)\n                          .filter(item => !item.mute)\n                          .map(item => item.id)\n        if(ucId.length > 0){\n          let index = ucId.findIndex(item => item == this.currentConversation.id)\n          // 如果当前会话存在未读消息，则切换到下一个会话。如果当前会话不存在未读消息，则切换到第一个存在未读消息的会话\n          index >= 0 ? index ++ : index = 0;\n          this.toChat(ucId[index])\n        }\n      },\n      showContactsView() {\n        this.contactsViewIsShow = true\n        // 判断是不是第一次打开\n        if(!this.showContactsView.firstOpen){\n          this.showContactsView.firstOpen = true\n          this.$nextTick(() => {\n            const contactsRef = this.$refs['uni-im-contacts']\n            contactsRef.openPages(contactsRef.menuList[0])\n          })\n        }\n      },\n\t\t\tcloseChatFiltered(){\n\t\t\t\tif (this.isWidescreen) { // 若为宽屏，则切换右侧的组件\n\t\t\t\t\tthis.$refs['chat-filtered']?.onCloseFragment()\n\t\t\t\t}\n\t\t\t},\n      toChatFiltered({ conversation_id, count, keyword, msg }) {\n        this.chatInfoIsShow = false;\n        this.filteredConversationId = conversation_id\n\t\t\t\t\n\t\t\t\tlastConversationId = this.currentConversationId\n        uniIm.currentConversationId = false\n\n        if (this.isWidescreen) { // 若为宽屏，则切换右侧的组件\n          this.$nextTick(() => {\n            let chatFilteredRef = this.$refs['chat-filtered']\n            if (chatFilteredRef) {\n              chatFilteredRef.load({\n                conversation_id,\n                keyword,\n                count,\n\t\t\t\t\t\t\t\tmsg\n              })\n            }\n          })\n        } else { // 若为窄屏，则打开新窗体\n          uni.navigateTo({\n            url: '/uni_modules/uni-im/pages/chat/chat-filtered'\n                  + `?conversation_id=${conversation_id}`\n                  + `&keyword=${encodeURIComponent(keyword)}`\n                  + `&count=${count}`,\n            animationDuration: 300\n          })\n        }\n      },\n      async toChat(param) {\n        this.chatInfoIsShow = false;\n        this.keyword = ''\n        this.filteredConversationId = false\n        const {id} = await uniIm.conversation.get(param)\n        uniIm.currentConversationId = id\n        if (this.isWidescreen) { // 若为宽屏，则切换右侧的组件\n          this.$nextTick(() => {\n            let chatViewRef = this.$refs['chat-view']\n            if (chatViewRef) {\n              chatViewRef.load(id)\n            }\n          })\n        } else { // 若为窄屏，则打开新窗体\n          // param 转成字符串\n          uni.navigateTo({\n            url: '/uni_modules/uni-im/pages/chat/chat?conversation_id=' + id,\n            animationDuration: 300\n          })\n        }\n      },\n\t\t\tshowChatInfo() {\n\t\t\t\tthis.chatInfoIsShow = !this.chatInfoIsShow\n        if(this.chatInfoIsShow){\n          this.$nextTick(()=>{\n            if(this.currentConversation.group_id){\n              this.$refs['group-info'].load(this.currentConversation.id)\n            }else{\n              this.$refs['chat-info'].load(this.currentConversation)\n            }\n          })\n        }\n\t\t\t},\n\t\t\ttoUcenter() {\n\t\t\t\tuni.navigateTo({\n\t\t\t\t\turl: '/uni_modules/uni-id-pages/pages/userinfo/userinfo?showLoginManage=true',\n\t\t\t\t\tcomplete(e) {\n\t\t\t\t\t\t// console.log(\"e: \" + JSON.stringify(e));\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t},\n      openConversationMenu(e,name){\n        const myContextmenu = this.$refs['uni-im-contextmenu']\n        let menuList = []\n        if(name == 'unreadMsgCount' && this.unreadMsgCount > 0){\n          menuList.push({\n            \"title\": \"清空所有未读消息数\",\n            \"action\": () => {\n              console.log('清空所有未读消息数')\n              uniIm.conversation.clearUnreadCount()\n            }\n          })\n        }\n        if(menuList.length == 0){\n          return\n        }\n        console.log('menuList.length',menuList.length)\n        myContextmenu.show({\n          \"top\": e.clientY + 35,\n          \"left\": e.clientX\n        }, menuList)\n        // myContextmenu.onClose(() => {\n        //   console.log('关闭右键菜单')\n        // })\n      }\n\t\t},\n\t\tasync onReachBottom() {\n\t\t\tawait this.$refs['uni-im-conversation-list']?.loadMore()\n\t\t},\n\t\tonNavigationBarButtonTap() {\n      uni.navigateTo({\n      \turl: '/uni_modules/uni-id-pages/pages/userinfo/userinfo?showLoginManage=true',\n      \tcomplete: e => {\n      \t\t// console.log(e);\n      \t}\n      });\n\t\t}\n\t}\n</script>\n\n<style lang=\"scss\">\n  @import \"@/uni_modules/uni-im/common/baseStyle.scss\";\n  @import \"@/uni_modules/uni-im/pages/index/index.scss\";\n</style>","import MiniProgramPage from '/Users/orange/aicode/langbot/web_client/langbot-im-uniapp/uni_modules/uni-im/pages/index/index.vue'\nwx.createPage(MiniProgramPage)"],"names":["uniIm","markRaw","uni","uniCloud","e"],"mappings":"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"}