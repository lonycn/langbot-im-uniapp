{"version":3,"file":"share-msg.js","sources":["uni_modules/uni-im/pages/share-msg/share-msg.vue","uni_modules/uni-im/pages/share-msg/share-msg.vue?type=page"],"sourcesContent":["<template>\n<view\n  v-if=\"isOpen\"\n  class=\"share-msg-root\"\n  @click=\"close\"\n>\n  <view class=\"share-msg-content\" @click.stop>\n    <!-- #ifndef APP -->\n    <view class=\"navbar\" v-if=\"!isWidescreen\">\n      <text class=\"btn cancel\" @click=\"close\">返回</text>\n      <text class=\"title\">选择会话</text>\n      \n      <text class=\"btn\" @click=\"send\" v-if=\"canSend\">发送({{checkedList.length}})</text>\n      <text class=\"btn disabled\" v-else>发送</text>\n    </view>\n    <!-- #endif -->\n    <view class=\"conversation-list-box\">\n      <uni-search-bar\n        id=\"search-bar\"\n        v-model=\"keyword\"\n        radius=\"5\"\n        placeholder=\"搜索会话\"\n        clear-button=\"auto\"\n        cancel-button=\"none\"\n      />\n      <uni-im-conversation-list\n        id=\"conversation-list-box\"\n        v-model:checked-list=\"checkedList\"\n        :keyword=\"keyword\"\n        :can-check=\"true\"\n        :show-unread-count=\"false\"\n      />\n    </view>\n    <view class=\"conversation-detail-box\" v-if=\"isWidescreen\">\n      <text class=\"title\">\n        转发给：\n      </text>\n      <!-- 已经选择的会话列表 -->\n      <scroll-view scroll-y class=\"selected-conversation-list\">\n        <view class=\"scroll-content\">\n          <view\n            v-for=\"(item,index) in checkedList\"\n            :key=\"index\"\n            class=\"selected-conversation-item\"\n          >\n            <image\n              class=\"avatar\"\n              :src=\"item.avatar_file&&item.avatar_file.url ? item.avatar_file.url : '/uni_modules/uni-im/static/avatarUrl.png'\"\n              mode=\"widthFix\"\n            />\n            <text class=\"title\">\n              {{ item.title }}\n            </text>\n            <uni-icons\n              class=\"close-icon\"\n              type=\"clear\"\n              color=\"#ccc\"\n              @click=\"removeCheckedItem(index)\"\n            />\n          </view>\n        </view>\n      </scroll-view>\n      <!-- 消息详情 -->\n      <view v-if=\"!noMsgList\" class=\"msg\">\n        <uni-list-item\n          title=\"转发的消息内容\"\n          link\n          @click=\"viewMsg\"\n        />\n      </view>\n      <!-- 输入留言 -->\n      <view v-if=\"!noComment\" class=\"input-box\">\n        <textarea\n          v-model=\"inputText\"\n          class=\"textarea\"\n          placeholder=\"留言...\"\n        />\n      </view>\n      <!-- 操作按钮 -->\n      <view class=\"action-btns\">\n        <button\n          class=\"btn cancel\"\n          plain\n          @click=\"close\"\n        >\n          取消\n        </button>\n        <button\n          class=\"btn\"\n          :disabled=\"checkedList.length === 0\"\n          type=\"primary\"\n          @click=\"send\"\n        >\n          发送\n        </button>\n      </view>\n    </view>\n\n    <!-- 消息详情 -->\n    <uni-im-view-msg v-if=\"!noMsgList\" ref=\"view-msg\" />\n  </view>\n</view>\n</template>\n\n<script>\nimport uniIm from '@/uni_modules/uni-im/sdk/index.js';\nexport default {\n  name: 'UniImShareMsg',\n  emits: ['close'],\n  props: {\n    noMsgList: { // 不显示转发的消息列表\n      type: Boolean,\n      default: false\n    },\n    noComment: { // 不显示留言\n      type: Boolean,\n      default: false\n    }\n  },\n  data() {\n    return {\n      inputText: '',\n      keyword: '',\n      checkedList: [],\n      isOpen: false,\n      msgList: [],\n      merge: false,\n      canSend: false\n    }\n  },\n  computed: {\n    ...uniIm.mapState(['isWidescreen'])\n  },\n  watch: {\n    checkedList: {\n      handler(val) {\n        this.canSend = val.length > 0;\n        // #ifdef APP\n        const titleNView = {\n          \"autoBackButton\": false,\n          \"buttons\": [{\n            \"text\": \"取消\",\n            \"fontSize\": 16,\n            \"float\": \"left\",\n            \"onclick\": this.close\n          },{\n            \"text\": \"发送\",\n            \"fontSize\": 16,\n            \"float\": \"right\",\n            \"onclick\": this.canSend ? this.send : null\n          }]\n        }\n        const rightButton = titleNView.buttons[1];\n        rightButton.width = \"100px\"\n        rightButton.text = `发送(${val.length})`\n        rightButton.color = this.canSend ? '#149d42' : '#CCC'\n        const currentWebview = this.$scope.$getAppWebview();\n        currentWebview.setStyle({titleNView});\n        // #endif\n      },\n      immediate: true,\n      deep: true\n    }\n  },\n  onLoad() {\n  \tconst eventChannel = this.getOpenerEventChannel();\n  \teventChannel.on('shareMsg', ([msgList,merge]) => {\n      console.log('shareMsg',msgList,merge)\n      this.open(msgList, merge);\n  \t});\n  },\n  methods: {\n    open(msgList, merge) {\n      console.info('msgList', msgList);\n      this.isOpen = true;\n      this.merge = merge;\n\n      this.msgList = msgList.map(msg => {\n        let data = Object.assign({},msg);\n        delete data._id\n        if (!merge) {\n          // 如果不是合并转发，则删除会话id和群id\n          data.conversation_id = '';\n          data.group_id = '';\n        }\n        return data;\n      });\n    },\n    removeCheckedItem(index) {\n      this.checkedList.splice(index, 1);\n    },\n    close() {\n      this.isOpen = false;\n      this.checkedList = [];\n      this.inputText = '';\n      if(!this.isWidescreen){\n        uni.navigateBack();\n      }\n    },\n    createMsg(msg, conversation) {\n\n    },\n    viewMsg() {\n      console.info('viewMsg', this.msgList);\n      this.$refs['view-msg'].open(this.msgList);\n    },\n    async send() {\n      console.info('send', this.checkedList);\n      console.info('this.msgList', this.msgList);\n      if (!this.merge && this.inputText.length != 0) {\n        this.msgList.push({\n          \"body\": this.inputText,\n          \"type\": \"text\"\n        })\n      }\n\n      for (var cidIndex = 0; cidIndex < this.checkedList.length; cidIndex++) {\n        const conversation = this.checkedList[cidIndex];\n        const {\n          friend_uid,\n          group_id,\n          id: conversation_id\n        } = conversation;\n        // 基本消息信息\n        const baseMsgInfo = {\n          \"to_uid\": friend_uid,\n          conversation_id,\n          group_id,\n          \"from_uid\": uniIm.currentUser._id,\n          \"state\": 0,\n          \"client_create_time\": Date.now(),\n          \"is_read\": false,\n          // 接收消息的appId，默认为当前应用的appId。如果你是2个不同appId的应用相互发，请修改此值为相对的appId\n          appId: uniIm.systemInfo.appId,\n        }\n\n        if (this.merge) {\n          let msg = Object.assign(baseMsgInfo, {\n            \"type\": \"history\",\n            \"body\": {\n              \"title\": this.msgList[0].group_id ? \"群聊天记录\" : \"\", // 是否转带真实群名称待定\n              \"msgList\": JSON.parse(JSON.stringify(this.msgList))\n            }\n          });\n          console.info('msg', msg);\n          await sendMsgToConversation(conversation, msg);\n          if (this.merge && this.inputText.length != 0) {\n            await sendMsgToConversation(conversation, {\n              ...baseMsgInfo,\n              \"body\": this.inputText,\n              \"type\": \"text\"\n            });\n          }\n        } else {\n          for (let msgIndex = 0; msgIndex < this.msgList.length; msgIndex++) {\n            let msg = JSON.parse(JSON.stringify(this.msgList[msgIndex]));\n            msg = Object.assign(msg, baseMsgInfo);\n            // console.info('msg',msg);\n            await sendMsgToConversation(conversation, msg);\n          }\n        }\n      }\n      this.close();\n      async function sendMsgToConversation(conversation, msg) {\n        // 插到消息列表\n        msg = conversation.msg.add(msg);\n        // 保存到本地数据库\n        // await conversation.msgManager.localMsg.add(msg);\n        const uniImCo = uniCloud.importObject(\"uni-im-co\");\n        await uniImCo.sendMsg(msg)\n          .then(async e => {\n            console.log('uniImCo.sendMsg',e);\n            msg.state = e.errCode === 0 ? 100 : -100;\n            msg.create_time = e.data.create_time;\n            msg._id = e.data._id;\n          })\n          .catch(async e => {\n            uni.showModal({\n              content: e.message,\n              showCancel: false,\n              confirmText: '关闭',\n            });\n            console.error('uniImCo.sendMsg error:', e.errCode, e.message);\n            // 必须要有create_time的值，否则indexDB通过创建时间索引找不到数据\n            msg.create_time = Date.now();\n            msg.state = -200;\n          });\n      }\n    }\n  }\n}\n</script>\n\n<style lang=\"scss\">\n  @import \"@/uni_modules/uni-im/common/baseStyle.scss\";\n  /* #ifdef H5*/\n  .share-msg-root,\n  .share-msg-root * {\n    max-width: none !important;\n    max-height: none !important;\n  }\n\n  /* #endif */\n\n  .share-msg-root {\n    width: 750rpx;\n    /* #ifndef APP */\n    position: fixed;\n    top: 0;\n    left: 0;\n    z-index: 999;\n    /* #endif */\n    /* #ifdef H5 */\n    width: 100vw;\n    height: 100vh;\n    /* #endif */\n    flex: 1;\n    justify-content: center;\n    align-items: center;\n    background-color: rgb(0, 0, 0, 0.3);\n    .share-msg-content {\n      .navbar {\n        flex-direction: row;\n        justify-content: space-between;\n        align-items: center;\n        padding: 10px;\n        border-bottom: 1px solid #eee;\n        .title {\n          font-size: 14px;\n          color: #333;\n        }\n        .btn {\n          font-size: 12px;\n          color: #FFF;\n          background-color: #149d42;\n          padding: 4px 8px;\n          border-radius: 6px;\n          &.disabled {\n            background-color: #EEE;\n            color: #CCC;\n          }\n          &.cancel {\n            border: none;\n            background-color: #FFF;\n            color: #666;\n          }\n        }\n      }\n      background-color: #fff;\n      width: 750rpx;\n      height: 100%;\n      /* #ifdef H5 */\n      @media screen and (min-device-width:960px){\n        width: 750px;\n        height: 70vh;\n        border-radius: 15px;\n        flex-direction: row;\n      }\n      /* #endif */\n      position: relative;\n    }\n    \n    .conversation-list-box {\n      /* #ifdef H5 */\n      @media screen and (min-device-width:960px){\n        width: 300px;\n      }\n      /* #endif */\n      height: 100%;\n      border-right: 1px solid #eee;\n    }\n    \n    .conversation-list-box ::v-deep .conversation-list .refresh-box {\n      background-color: #fff;\n    }\n    \n    .conversation-detail-box {\n      flex: 1;\n    }\n    \n    .conversation-detail-box .title {\n      font-size: 18px;\n      color: #333;\n      margin: 15px;\n    }\n    \n    .selected-conversation-list {\n      height: 0;\n      flex: 1;\n    }\n    \n    .scroll-content {\n      flex-direction: row;\n      flex-wrap: wrap;\n      margin: 0 5px 35px 5px;\n    }\n    \n    .selected-conversation-item {\n      flex-direction: row;\n      padding: 3px;\n      justify-content: center;\n      align-items: center;\n      border-radius: 5px;\n      background-color: rgba(250, 250, 250, 1);\n      margin: 3px;\n    }\n    \n    .selected-conversation-item .avatar {\n      width: 35px;\n      height: 35px;\n      border-radius: 50%;\n    }\n    \n    .selected-conversation-item .title {\n      font-size: 12px;\n      color: #333;\n      text-align: center;\n      margin: 0 5px;\n    }\n    \n    .close-icon {\n      cursor: pointer;\n    }\n    \n    .msg {}\n    \n    .input-box {\n      padding: 15px 10px;\n      border: 1px solid #EEE;\n      border-width: 1px 0;\n    }\n    \n    .textarea {\n      width: 100%;\n      border-radius: 5px;\n      font-size: 14px;\n      outline: none;\n    }\n    \n    .action-btns {\n      flex-direction: row;\n      justify-content: flex-end;\n      padding: 10px;\n    }\n    \n    .action-btns .btn {\n      margin: 0 10px;\n      width: 100px;\n    }\n    \n    .action-btns .btn.cancel {\n      color: #999;\n      border-color: #999;\n    }\n  }\n</style>","import MiniProgramPage from '/Users/orange/aicode/langbot/web_client/langbot-im-uniapp/uni_modules/uni-im/pages/share-msg/share-msg.vue'\nwx.createPage(MiniProgramPage)"],"names":["uniIm","uni","uniCloud"],"mappings":"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"}