{"version":3,"file":"uni-im-editor.js","sources":["uni_modules/uni-im/components/uni-im-editor/uni-im-editor.vue","/Users/orange/aicode/langbot/web_client/langbot-im-uniapp/uni_modules/uni-im/components/uni-im-editor/uni-im-editor.vue?type=component"],"sourcesContent":["<template>\r\n  <view class=\"uni-im-editor-box\" @click=\"clickhandler\">\n    \n    <!-- #ifdef MP -->\n      <textarea class=\"uni-im-editor-mp\" v-model=\"textareaValue\" @input=\"oninput\" auto-height :maxlength=\"maxlength\"\n        :show-confirm-bar=\"false\" :adjust-position=\"false\" @blur=\"lastCursor = $event.detail.cursor;isFocus = false\"\n\t\t\t\t:cursor=\"lastCursor\" @focus=\"isFocus = true\" :focus=\"isFocus\"\n      ></textarea>\n    <!-- #endif -->\n    \n    <!-- #ifndef MP -->\n      <div class=\"uni-im-editor\" ref=\"uni-im-editor\" contenteditable=\"true\" :inputmode=\"(hideKeyboard && systemInfo.platform != 'ios') ? 'none' : 'text'\"></div>\n      <!-- 与rmd通讯专用 -->\n      <view :change:prop=\"rdm.$callMethod\" :prop=\"callRmdParam\"></view>\n    <!-- #endif -->\n    \r\n  </view>\r\n</template>\r\n\r\n<script>\r\n  import uniIm from '@/uni_modules/uni-im/sdk/index.js';\n\timport parseHtml from './parseHtml.js'\n\timport uploadHtmlArrayImgs from './uploadHtmlArrayImgs.js'\r\n  export default {\r\n    emits: [\"input\", \"confirm\", \"change\", \"click\"],\n\t\tcomputed: {\n\t\t\t...uniIm.mapState(['systemInfo'])\n\t\t},\r\n    data() {\n      return {\n        callRmdParam: [],\n        // #ifdef MP\n        \"textareaValue\":this.modelValue,\n        lastCursor:this.modelValue.length,\n\t\t\t\tisFocus:false\n        // #endif\n      }\r\n    },\r\n    props: {\n\t\t\thideKeyboard: {\n\t\t\t\ttype: Boolean,\n\t\t\t\tdefault: false,\n\t\t\t},\r\n      modelValue: {\r\n        type: [String, Object],\r\n        default: \"\"\r\n      },\r\n      placeholder: {\r\n        type: String,\r\n        default: \"\"\r\n      },\r\n      maxlength: {\r\n        type: Number,\r\n        default: 140\r\n      },\n\t\t\t// 回车直接发送\n\t\t\tenterSend: {\n\t\t\t\ttype: Boolean,\n\t\t\t\tdefault: true\n\t\t\t}\r\n    },\n    // #ifdef MP\n    watch: {\n      textareaValue(val){\n        this.$emit(\"change\",{\n          value:val\n        })\n      }\n    },\n    // #endif\r\n    mounted() {\n      // 与rmd通讯专用\r\n      this.callRmd = async (funcName, ...params) => {\n        // #ifdef MP\n        switch (funcName){\n          case '$setContent':\n            this.textareaValue = params[0]\n            break;\n          case '$addHtmlToCursor':\n            // 在第lastCursor位置添加内容\n            setTimeout(()=>{\n              this.textareaValue = this.textareaValue.slice(0,this.lastCursor) + params[0] + this.textareaValue.slice(this.lastCursor)\n            },300)\n            break;\n          default:\n            console.error('小程序暂不支持与rmd通讯',funcName,params)\n            break;\n        }\n        return\n        // #endif\r\n        this.callRmdParam = []\r\n        this.$nextTick(() => {\n          return new Promise((resolve, reject) => {\n            this.callRmdParam = [funcName, ...params,param=>{\n              resolve(param)\n            }]\n          })\r\n        })\r\n      }\n      \n      // #ifndef H5\n      // uni.onKeyboardHeightChange((res) => {\n      //   console.log('键盘高度变化22222', res.height);\n      //   if(res.height === 0){\n      //     // console.error('@##键盘被收起，可以失去焦点')\n      //     // this.callRmd('$blur')\n      //   }\n      // });\n      // #endif\n      \r\n      // #ifdef H5\n\t\t\tconst uniImEditors = document.querySelectorAll('.uni-im-editor');\n      const uniImEditor = uniImEditors[uniImEditors.length - 1];\n      uniIm.utils.appEvent.onAppActivate(() => {\r\n        // 主窗口激活时设置输入焦点到这里的文本编辑框\r\n        uniImEditor.focus()\r\n      })\r\n      let shiftIsDown = false;\r\n      window.addEventListener('keydown', (e) => {\r\n        if (e.key == 'Shift') {\r\n          shiftIsDown = true\r\n        }\r\n      })\r\n      window.addEventListener('keyup', (e) => {\r\n        if (e.key == 'Shift') {\r\n          shiftIsDown = false\r\n        }\r\n      })\r\n\r\n      let isComposing = false;\r\n      // 输入法开始输入\r\n      uniImEditor.addEventListener('compositionstart', () => {\r\n        isComposing = true\r\n        uniImEditor.isComposing = isComposing;\r\n      });\r\n      // 输入法结束输入\r\n      uniImEditor.addEventListener('compositionend', () => {\r\n        isComposing = false\r\n        uniImEditor.isComposing = isComposing;\r\n      });\r\n\r\n      uniImEditor.addEventListener('keydown', (event) => {\r\n        if (event.key === 'Enter') {\n\t\t\t\t\tif (this.enterSend === true) {\n\t\t\t\t\t\tif (isComposing) {\n\t\t\t\t\t\t  console.log('输入法正在输入中，此时回车不发送消息')\n\t\t\t\t\t\t  event.preventDefault();\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t  if (shiftIsDown) {\n\t\t\t\t\t\t    console.log('shift键处于按下状态，为换行不是confirm发送')\n\t\t\t\t\t\t  } else {\n\t\t\t\t\t\t    this.$emit('confirm');\n\t\t\t\t\t\t    // 防止，回车执行发送的同时执行换行\n\t\t\t\t\t\t    event.preventDefault();\n\t\t\t\t\t\t  }\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// 默认的回车会导致多包一层div，不方便解析。这里阻止默认行为，自定义换行\n\t\t\t\t\t\tevent.preventDefault();\n\t\t\t\t\t\t// 判断光标是否在当前富文本的末尾，注意：此编辑框不仅仅支持文本，还支持图片等，因此不能直接判断innerText的长度\n\t\t\t\t\t\tlet cursorInLast = false\n\t\t\t\t\t\tconst selection = window.getSelection();\n\t\t\t\t\t\tconst range = selection.getRangeAt(0);\n\t\t\t\t\t\tconst endContainer = range.endContainer;\n\t\t\t\t\t\t// 如果光标在最后一个子节点上\n\t\t\t\t\t\tif (endContainer === uniImEditor.lastChild) {\n\t\t\t\t\t\t\tconst endOffset = range.endOffset;\n\t\t\t\t\t\t\t// console.log('光标偏移量',endOffset)\n\t\t\t\t\t\t\tif (endContainer.nodeType === 3) { // 文本节点\n\t\t\t\t\t\t\t// console.log('光标所在的是文本节点',endOffset,endContainer.textContent.length)\n\t\t\t\t\t\t\t\tcursorInLast = endOffset === endContainer.textContent.length;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t// console.log('光标所在的不是文本节点',endOffset)\n\t\t\t\t\t\t\t\tcursorInLast = endOffset === 0;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// console.log('光标不在最后一个“子节点“上')\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// console.log('光标是否在末尾',cursorInLast)\n\t\t\t\t\t\t// 光标在末尾时，多补一个换行\n\t\t\t\t\t\tthis.$addHtmlToCursor( \"\\n\" + (cursorInLast ? \"\\n\" : \"\") )\n\t\t\t\t\t}\r\n        }\r\n      });\r\n\r\n      uniImEditor.addEventListener('paste', async event => {\n        // 阻止默认行为\n        event.preventDefault();\n\t\t\t\t\n        // 删除选中的文本\n        const selection = window.getSelection();\n        if (!selection.isCollapsed) {  // console.log('选中文本', selection.toString());\n          const range = selection.getRangeAt(0);\n          range.deleteContents();\n          selection.removeAllRanges();\n        }\n        \n        //某些chrome版本使用的是event.originalEvent\n        const clipboardData = event.clipboardData || event.originalEvent?.clipboardData;\n        let htmlString = clipboardData.getData('text/html');\n        console.log('paste',{htmlString});\n        if (htmlString) {\n          // 获取html字符串\n          htmlString = await filterHTML(htmlString);\n          console.log('htmlString222', htmlString);\n          const tmpDom = document.createElement('div');\n          tmpDom.innerHTML = htmlString;\n          if (tmpDom.innerText.length > 50000) {\n            uni.showModal({\n              content: '你粘贴的文本长度超过50000，将被截断。',\n              complete: e => {\n                if (e.confirm) {\n                  this.$addHtmlToCursor(htmlString.substring(0, 50000))\n                }\n              }\n            });\n          } else {\n            this.$addHtmlToCursor(htmlString)\n          }\n          // 检查图片加载失败，删除图片\n          const imgs = uniImEditor.querySelectorAll('img');\n          for (const img of imgs) {\n            img.onerror = () => {\n              img.remove();\n            }\n          }\n        } else {\n          // 获取文本\n          let clipboardDataText = clipboardData.getData('text/plain')\n          if (clipboardDataText) {\n\t\t\t\t\t\tclipboardDataText = clipboardDataText.replace(/&/g, '&amp;')\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t.replace(/</g, '&lt;')\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t.replace(/>/g, '&gt;')\n            this.$addHtmlToCursor(clipboardDataText)\n          } else {\n\t\t\t\t\t\t// 获取剪切板中的文件\n\t\t\t\t\t\tconst items = clipboardData.items;\n\t\t\t\t\t\tfor (const item of items) {\n\t\t\t\t\t\t\tif (item.type.indexOf(\"image\") !== -1) {\n\t\t\t\t\t\t\t\tconst file = item.getAsFile();\n\t\t\t\t\t\t\t\tconst blobUrl = URL.createObjectURL(file)\n\t\t\t\t\t\t\t\tconsole.log('blobUrl',blobUrl)\n\t\t\t\t\t\t\t\tthis.$addHtmlToCursor(`<img src=\"${blobUrl}\" />`)\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n        }\n      })\r\n\r\n      async function filterHTML(htmlString) {\r\n        // 过滤html字符串，只保留：文字，图片，链接\r\n        // html字符串转dom对象，并深度遍历\r\n        let tmpDiv = document.createElement('div');\r\n        tmpDiv.innerHTML = htmlString;\r\n        let arr = [];\r\n        await deepTr(tmpDiv);\n        // 销毁tmpDiv\n        tmpDiv = null;\n        return arr.join('');\n        async function deepTr(node) {\n          // console.log('node', node);\n          if (node.nodeType === 1) {\n            const action = {\n              async IMG(){\n                // 只保留src属性\n                // 处理图片跨域问题\n                if (node.src.indexOf('blob:http') != 0 && !node.src.includes('https://im-res.dcloud.net.cn')) {\n                  const uniImCo = uniCloud.importObject(\"uni-im-co\", {\n                    loadingOptions: { // loading相关配置\n                      title: '处理跨域图片...',\n                      mask: true\n                    }\n                  })\n                  let res = await uniImCo.getImgBase64(node.src)\n                  function base64ToBlob(base64) {\n                    // 将Base64字符串分割为数据和应用信息\n                    const byteChars = atob(base64.split(',')[1]);\n                    // 创建一个长度为byteChars长度的数组\n                    const byteArrays = new Array(byteChars.length);\n                    // 将二进制字符串转换为Uint8Array\n                    for (let i = 0; i < byteChars.length; i++) {\n                      byteArrays[i] = byteChars.charCodeAt(i);\n                    }\n                    // 返回一个Blob对象\n                    return new Blob([new Uint8Array(byteArrays)], {type: 'image/png'});\n                  }\n                  node.src = URL.createObjectURL( base64ToBlob(res.data) )\n                }\n                arr.push(`<img src=\"${node.src}\" />`);\n              },\n              A(){\n                // 只保留href属性\n                arr.push(`<a href=\"${node.href}\">${node.innerText}</a>`);\n              }\n            }\n            await action[node.tagName]?.();\n            for (let i = 0; i < node.childNodes.length; i++) {\n              await deepTr(node.childNodes[i]);\n            }\n          } else if (node.nodeType === 3) {\n            // 排除非内容的文本节点\n            const tagNameList = ['A','IMG','STYLE','SCRIPT'];\n            if (!tagNameList.includes(node.parentNode.tagName)) {\n              // 把node中的<、>、&转义\n              node.nodeValue = node.nodeValue.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');\n              arr.push(node.nodeValue.trim());\n              // 如果父节点是需要换行的标签，且当前节点是最后一个节点，则添加换行\n              const tagNameList2 = ['P','DIV','FONT','H1','H2','H3','H4','H5','H6','LI','UL','OL','BR'];\n              if (tagNameList2.includes(node.parentNode.tagName) && node.parentNode.lastChild === node) {\n                arr.push('\\n');\n              }\n            }else{\n              // console.log('非内容文本节点', node.parentNode.tagName,node);\n            }\n          }else{\n            // console.log('其他节点', node);\n          }\n        }\r\n      }\r\n      // #endif\r\n    },\r\n    methods: {\n      oninput(e) {\n        // #ifdef MP\n        let oldValue = this.oninput.oldValue || '';\n        // 当前输入框的值\n        const value = e.detail.value \n        // 本次输入的数据\n        const data = value.replace(oldValue, '') \n        this.oninput.oldValue = value\n        e = {\n          data,\n          value\n        }\n        // #endif\n        \n\t\t\t\t// #ifndef MP\n\t\t\t\tif ( typeof e.value === 'object' ){\n\t\t\t\t\te.value.getHtmlArray = ()=>{\n\t\t\t\t\t\tconst data = parseHtml(e.value.html)\n\t\t\t\t\t\t\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tdata,\n\t\t\t\t\t\t\tuploadImg: async htmlArray => await uploadHtmlArrayImgs(htmlArray || data)\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t// #endif\n\t\t\t\t\n        this.$emit('input', e)\r\n      },\n\t\t\tfocus(){\n\t\t\t\tthis.isFocus = false\n\t\t\t\tsetTimeout(()=>{\n\t\t\t\t\tthis.isFocus = true\n\t\t\t\t},0)\n\t\t\t},\n\t\t\tclickhandler(e){\n\t\t\t\tthis.$emit('click',e)\n\t\t\t}\n    }\r\n  }\r\n</script>\r\n<!-- #ifndef MP -->\n<script module=\"rdm\" lang=\"renderjs\">\r\n  let lastFocusNode,lastCursor;\r\n  // #ifdef APP\n  function setSoftinputTemporary() {\n      // console.log('setSoftinputTemporary')\n      // 设置当前窗口键盘弹出后不做变化\n      const currentWebview = plus.webview.currentWebview();\n      currentWebview.setSoftinputTemporary({\n        mode:'nothing',\n        position:{top: 0,height: 0}\n      });\n  }\n  // #endif\n  export default {\r\n    name: 'uni-im-editor',\r\n    data() {\r\n      return {\n        uniImEditor: null,\n      }\r\n    },\n    mounted() {\n\t\t\t// 拿到最后一个uni-im-editor的dom对象\n\t\t\tconst uniImEditors = document.querySelectorAll('.uni-im-editor');\n\t\t\tthis.uniImEditor = uniImEditors[uniImEditors.length - 1];\n      this.uniImEditor.addEventListener('input', e => {\n        setTimeout(()=>this.$oninput(e.data),0);\n      });\n      this.uniImEditor.addEventListener('click', e => {\n        // console.log('click', e);\n        // #ifdef APP\n        setSoftinputTemporary()\n        // #endif\n        setTimeout(this.$refreshLastCursor, 0);\n      });\n      this.uniImEditor.addEventListener('blur', e => {\n        // console.error('###blur', e);\n      });\n      // 键盘敲左右\n      this.uniImEditor.addEventListener('keydown', e => {\n        setTimeout(this.$refreshLastCursor, 0);\n      });\n\t  \n\t\t\t// 自定义撤回操作\n\t\t\tclass CustomHistory {\n\t\t\t\tconstructor(that) {\n\t\t\t\t\tthis.uniImEditor = that.uniImEditor\n\t\t\t\t\tthis.maxHistory = 10;\n\t\t\t\t\tthis.history = [];\n\t\t\t\t\tthis.lock = false;\n\t\t\t\t\tthis.uniImEditor.addEventListener('keydown', (event) => {\n\t\t\t\t\t\tif ( (event.ctrlKey || event.metaKey) && event.key === 'z') {\n\t\t\t\t\t\t\t// 拦截撤销操作\n\t\t\t\t\t\t\t// console.log('拦截撤销操作');\n\t\t\t\t\t\t\tevent.preventDefault();\n\t\t\t\t\t\t\t// 撤销操作\n\t\t\t\t\t\t\tif (this.history.length > 0) {\n\t\t\t\t\t\t\t\tlet last = this.history.pop();\n\t\t\t\t\t\t\t\tif (last === this.uniImEditor.innerHTML){\n\t\t\t\t\t\t\t\t\tlast = this.history.pop();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t// console.log('撤销操作',last);\n\t\t\t\t\t\t\t\tthis.lock = true;\n\t\t\t\t\t\t\t\tthat.$setContent(last ? {html: last} : '')\n\t\t\t\t\t\t\t\tthis.lock = false;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t// console.log('无历史记录');\n\t\t\t\t\t\t\t\tthat.$setContent('')\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t// 设置光标在末尾\n\t\t\t\t\t\t\tthat.$focus({toLast: true})\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tadd(){\n\t\t\t\t\tif ( this.lock ){\n\t\t\t\t\t\t// return console.log('正在使用历史记录');\n\t\t\t\t\t}\n\t\t\t\t\tif (this.history.length >= this.maxHistory){\n\t\t\t\t\t\tthis.history.shift();\n\t\t\t\t\t}\n\t\t\t\t\tthis.history.push(this.uniImEditor.innerHTML);\n\t\t\t\t\t// console.log('this.history',this.history);\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis.customHistory = new CustomHistory(this);\n      \n      // 监听nickname后面的空格被删除（提醒此空格在margin-right: -3px;内，用于解决办法浏览器非文本节点后的光标定位不正确的问题）\n      const observer = new MutationObserver(function(mutations) {\n        mutations.forEach(mutation=> {\n          // 判断是否为删除节点的操作\n          const [removedNode] = mutation.removedNodes\n          if(removedNode){\n            if(removedNode && mutation?.previousSibling?.className === \"nickname\"){\n              mutation.previousSibling.remove()\n            }\n          }\n        });\n      })\n      .observe(this.uniImEditor, {\n        childList: true, // 监听子节点的变化\n      });\n    },\r\n    watch: {\r\n      modelValue(modelValue, oldModelValue) {\r\n        this.$nextTick(() => {\r\n          // console.log('modelValue', modelValue);\r\n          if (modelValue.length === 0) {\r\n            this.uniImEditor.innerHTML = ''\r\n          } else if (typeof modelValue === 'string' && modelValue != this.$inputText()) {\r\n            this.uniImEditor.innerHTML = modelValue\r\n          } else if (typeof modelValue === 'object' && modelValue.html != this.uniImEditor.innerHTML) {\r\n            this.uniImEditor.innerHTML = modelValue.html\r\n          }\r\n        });\r\n      },\r\n    },\n    methods: {\n      // 刷新光标信息\n      $refreshLastCursor() {\n        lastCursor = this.$getCursor();\n        lastFocusNode = window.getSelection().focusNode;\n        // console.log('刷新光标信息',{\n        //   lastCursor,\n        //   lastFocusNode\n        // });\n      },\n      $oninput(data){\n        this.$refreshLastCursor()\n        // 耗时计算\n        let start = new Date().getTime();\n        \n        let param = '';\n        let val = this.uniImEditor.innerHTML;\n        \n        const hasImg = this.uniImEditor.querySelector('img');\n        const hasNickname = this.uniImEditor.querySelector('.nickname');\n        const hasA = this.uniImEditor.querySelector('a');\n        if (hasImg || hasNickname || hasA) {\n          param = {\n            \"html\": val,\n            \"text\": this.uniImEditor.innerText,\n            \"aboutUserIds\": Array.from(this.uniImEditor.querySelectorAll('.nickname')).map(i=>i.getAttribute('user_id'))\n          }\n        } else {\n          param = this.$inputText()\n        }\n        \n        // 打印耗时\n        const spendTime = new Date().getTime() - start\n        if(spendTime > 10){\n          console.log('耗时', );\n        }\n        \n        this.$ownerInstance.callMethod('oninput',{\n          data,// 本次输入的数据\n          value: param // 当前输入框的值\n        })\n      },\n      $callMethod([funcName, ...params]) {\n        // console.log('$callMethod funcName', funcName)\n        // console.log('$callMethod funcName', funcName === null)\n        // console.log('$callMethod params', params)\n        // console.log('$callMethod typeof funcName', typeof funcName)\n        try {\n          if(typeof funcName == 'string'){\n            const res = this[funcName](...params)\n            // console.log('res', res)\n          }\n        } catch (e) {\n          console.error(\"调用renderjs模块的方法失败\", e,funcName,params)\n        }\n      },\n      $getCursor() {\n        const selection = window.getSelection();\n        return selection.focusOffset;\n      },\r\n      // 恢复光标位置\n      $restoreCursor(focus = true) {\n        this.$focus();\n        // 获取焦点时所在的子元素\n        try{\n          const range = document.createRange();\n          const sel = window.getSelection(); \n          range.setStart(lastFocusNode || this.uniImEditor, lastCursor);\n          range.collapse(true); \n          sel.removeAllRanges(); \n          sel.addRange(range);\n        }catch(e){\n          console.error('恢复光标位置失败',e)\n          //TODO handle the exception\n        }\n      },\n      $deleteLeftChar(n = 1) {\n        this.$restoreCursor(true);\r\n        const selection = window.getSelection();\r\n        if (!selection.isCollapsed){\n          console.error('不要删除已选中的内容')\n          return;\n        }\r\n        const range = selection.getRangeAt(0).cloneRange();\r\n        if (range.startOffset > 0) {\r\n          range.setStart(range.startContainer, range.startOffset - n);\r\n          range.deleteContents();\r\n          selection.removeAllRanges();\r\n          selection.addRange(range);\r\n        } else if (range.startContainer.previousSibling) {\r\n          const container = range.startContainer;\r\n          const sibling = container.previousSibling;\r\n          range.setStart(sibling, sibling.length - n);\r\n          range.setEnd(sibling, sibling.length);\r\n          range.deleteContents();\r\n          selection.removeAllRanges();\r\n          selection.addRange(range);\r\n        }\n        lastCursor = this.$getCursor();\r\n        this.$oninput();\r\n      },\r\n      $addHtmlToCursor(html,focus = true) {\n\t\t\t\tthis.customHistory.add();\n        this.$restoreCursor(focus);\n        const selection = window.getSelection();\r\n        if (selection.getRangeAt && selection.rangeCount) {\r\n          let range = selection.getRangeAt(0);\r\n          range.deleteContents();\r\n          var ele = document.createElement(\"div\");\r\n          ele.innerHTML = html;\r\n          var frag = document.createDocumentFragment(),\r\n            node, lastNode;\r\n          while ((node = ele.firstChild)) {\r\n            lastNode = frag.appendChild(node);\r\n          }\r\n          range.insertNode(frag);\r\n          // 设置光标到插入内容之后的位置\r\n          if (lastNode) {\r\n            range = range.cloneRange();\r\n            range.setStartAfter(lastNode);\r\n            range.collapse(true);\r\n            selection.removeAllRanges(); // 清除现有的选择区域\r\n            selection.addRange(range); // 将更新后的范围添加回选择区域\r\n          }\r\n        }else{\n          this.uniImEditor.innerHTML += html;\n        }\n        this.$oninput(html);\n\t\t\t\t// 记录历史\n\t\t\t\tthis.customHistory.add();\n      },\r\n      $inputText() {\n        return this.uniImEditor.innerText.trim();\r\n      },\n      $focus({toLast = false} = {}) {\n        if(document.activeElement.className === 'uni-im-editor'){\n          document.activeElement.blur();\n        }\n        // #ifdef APP\n        setSoftinputTemporary()\n        // #endif\n        // console.error('获取焦点',document.activeElement.className);\n        this.uniImEditor.focus();\n        // console.error('获取焦点',document.activeElement.className);\n\t\t\t\tif(toLast){\n\t\t\t\t\t// 焦点定位到末尾\n\t\t\t\t\tconst range = document.createRange();\n\t\t\t\t\trange.selectNodeContents(this.uniImEditor);\n\t\t\t\t\trange.collapse(false);\n\t\t\t\t\tconst selection = window.getSelection();\n\t\t\t\t\tselection.removeAllRanges();\n\t\t\t\t\tselection.addRange(range);\n\t\t\t\t}\n      },\n      $blur(){\n        // console.error('失去焦点1',document.activeElement.className);\n        this.uniImEditor.blur();\n        // console.error('失去焦点2',document.activeElement.className);\n        setTimeout(()=>{\n          // console.error('失去焦点3',document.activeElement.className);\n        },1000)\n      },\r\n      $onBlur() {\r\n        // this.$emit('update:focus', false);\r\n        // console.log('blur');\r\n        this.$emit('blur');\r\n      },\r\n      $onFocus() {\r\n        // console.log('$onFocus');\r\n        this.$emit('focus');\r\n        // this.$emit('update:focus', true);\r\n      },\r\n      $setContent(data) {\r\n        if (typeof data === 'string') {\n          // 为兼容旧版- s &gt; 转换为 > $lt; 转换为 < &amp; 转换为 &\n          data = data.replace(/&gt;/g, '>').replace(/&lt;/g, '<').replace(/&amp;/g, '&');\n          // 为兼容旧版- e\r\n          this.uniImEditor.innerText = data;\n          this.$oninput(data);\r\n        } else if (typeof data === 'object') {\n          this.uniImEditor.innerHTML = data.html || this.$arrDomJsonToHtml(data);\r\n          this.$oninput(this.uniImEditor.innerHTML);\r\n        }\n      },\r\n      $arrDomJsonToHtml(arr) {\r\n        function parseItem(item) {\r\n          if (item.type === \"text\") {\r\n            return item.text;\r\n          }\r\n          let html = `<${item.name}`;\r\n          if (item.attrs) {\r\n            for (const key in item.attrs) {\r\n              html += ` ${key}=\"${item.attrs[key]}\"`;\r\n            }\r\n          }\r\n          if (item.children) {\r\n            html += \">\";\r\n            for (const child of item.children) {\r\n              html += parseItem(child);\r\n            }\r\n            html += `</${item.name}>`;\r\n          } else {\r\n            html += \" />\";\r\n          }\r\n          return html;\r\n        }\r\n\r\n        let result = \"\";\r\n        for (const item of arr) {\r\n          result += parseItem(item);\r\n        }\r\n        return result;\r\n      }\n    }\r\n  }\r\n</script>\n<!-- #endif -->\r\n\r\n<style lang=\"scss\">\n.uni-im-editor-box {\n  /* #ifdef MP */\n  .uni-im-editor-mp {\n    width: 100%;\n    height: 26px;\n    max-height: 110px;\n  }\n  /* #endif */\n  \n  /* #ifndef MP */\n  .uni-im-editor {\n    min-height: 26px;\n    max-height: 110px;\n    overflow: auto;\n\t\twhite-space: pre-wrap;\n    // 解决ios下不能编辑的问题\n    user-select: text;\n    -webkit-user-select:text;\n    -webkit-user-modify: read-write-plaintext-only;\n    /* #ifdef APP */\n    &,* {\n      user-select: text;\n      -webkit-user-select:text;\n      -webkit-user-modify: read-write-plaintext-only;\n    }\n    /* #endif */\n    &:focus {\n      outline: none;\n    }\n    & ::v-deep {\n      img {\n        max-width: 50%;\n\t\t\t\theight: auto;\n        display: block;\n      }\n      .nickname {\n         color: #0b65ff !important;\n         user-select: text;\n         margin-right: -3px;\n         /* #ifdef H5 */\n         cursor: pointer;\n         /* #endif */\n       }\n    }\n  }\n  /* #endif */\n}\r\n</style>","import Component from '/Users/orange/aicode/langbot/web_client/langbot-im-uniapp/uni_modules/uni-im/components/uni-im-editor/uni-im-editor.vue'\nwx.createComponent(Component)"],"names":["uniIm","uni"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAuBE,MAAK,YAAU;AAAA,EACb,OAAO,CAAC,SAAS,WAAW,UAAU,OAAO;AAAA,EAC/C,UAAU,mBACNA,kCAAM,SAAS,CAAC,YAAY,CAAC;AAAA,EAE/B,OAAO;AACL,WAAO;AAAA,MACL,cAAc,CAAE;AAAA,MAEhB,iBAAgB,KAAK;AAAA,MACrB,YAAW,KAAK,WAAW;AAAA,MAC/B,SAAQ;AAAA,IAEN;AAAA,EACD;AAAA,EACD,OAAO;AAAA,IACR,cAAc;AAAA,MACb,MAAM;AAAA,MACN,SAAS;AAAA,IACT;AAAA,IACE,YAAY;AAAA,MACV,MAAM,CAAC,QAAQ,MAAM;AAAA,MACrB,SAAS;AAAA,IACV;AAAA,IACD,aAAa;AAAA,MACX,MAAM;AAAA,MACN,SAAS;AAAA,IACV;AAAA,IACD,WAAW;AAAA,MACT,MAAM;AAAA,MACN,SAAS;AAAA,IACV;AAAA;AAAA,IAEJ,WAAW;AAAA,MACV,MAAM;AAAA,MACN,SAAS;AAAA,IACV;AAAA,EACE;AAAA,EAED,OAAO;AAAA,IACL,cAAc,KAAI;AAChB,WAAK,MAAM,UAAS;AAAA,QAClB,OAAM;AAAA,OACP;AAAA,IACH;AAAA,EACD;AAAA,EAED,UAAU;AAER,SAAK,UAAU,CAAO,aAAa,WAAW;AAE5C,cAAQ,UAAQ;AAAA,QACd,KAAK;AACH,eAAK,gBAAgB,OAAO,CAAC;AAC7B;AAAA,QACF,KAAK;AAEH,qBAAW,MAAI;AACb,iBAAK,gBAAgB,KAAK,cAAc,MAAM,GAAE,KAAK,UAAU,IAAI,OAAO,CAAC,IAAI,KAAK,cAAc,MAAM,KAAK,UAAU;AAAA,UACxH,GAAC,GAAG;AACL;AAAA,QACF;AACEC,wBAAA,MAAA,MAAA,SAAA,uEAAc,iBAAgB,UAAS,MAAM;AAC7C;AAAA,MACJ;AACA;AAAA,IAUF;AAAA,EA8ND;AAAA,EACD,SAAS;AAAA,IACP,QAAQ,GAAG;AAET,UAAI,WAAW,KAAK,QAAQ,YAAY;AAExC,YAAM,QAAQ,EAAE,OAAO;AAEvB,YAAM,OAAO,MAAM,QAAQ,UAAU,EAAE;AACvC,WAAK,QAAQ,WAAW;AACxB,UAAI;AAAA,QACF;AAAA,QACA;AAAA,MACF;AAgBA,WAAK,MAAM,SAAS,CAAC;AAAA,IACtB;AAAA,IACJ,QAAO;AACN,WAAK,UAAU;AACf,iBAAW,MAAI;AACd,aAAK,UAAU;AAAA,MACf,GAAC,CAAC;AAAA,IACH;AAAA,IACD,aAAa,GAAE;AACd,WAAK,MAAM,SAAQ,CAAC;AAAA,IACrB;AAAA,EACC;AACF;;;;;;;;;;;;;;;;;ACxWF,GAAG,gBAAgB,SAAS;"}