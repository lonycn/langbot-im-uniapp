{"version":3,"file":"code.js","sources":["uni_modules/uni-im/components/uni-im-msg/types/code.vue","/Users/orange/aicode/langbot/web_client/langbot-im-uniapp/uni_modules/uni-im/components/uni-im-msg/types/code.vue?type=component"],"sourcesContent":["<template>\n  <view class=\"code-view-root\" >\n    <view class=\"copy-btn-box\" @click.stop>\n      <text class=\"language\">{{language}}</text>\n      <text class=\"copy-btn\" @click=\"copyCode\">复制代码</text>\n    </view>\n    <scroll-view :scroll-y=\"overflow\" :enable-flex=\"true\" class=\"code-view-box\" :style=\"{height:showFullBtn ? boxHeight: 'auto'}\">\n      <!-- #ifdef APP-NVUE -->\n      <web-view ref=\"web\" @onPostMessage=\"onWebViewMsg\" src=\"/static/app-plus/mp-html/uni-im-code-view-local.html\" :style='{\"height\":webViewHeight}' class=\"web-view\"></web-view>\n      <!-- #endif -->\n\n      <!-- #ifndef APP-NVUE -->\n      <rich-text v-if=\"nodes.length\" space=\"nbsp\" :nodes=\"nodes\" @itemclick=\"trOnclick\" :style='{\"height\":webViewHeight}' class=\"code-view-rich-text\"></rich-text>\n      <!-- #endif -->\n    </scroll-view>\n    <view class=\"show-full-btn\" v-if=\"!isWidescreen && showFullBtn && overflow\" @click=\"toCodePage\">\n      <text class=\"show-full-text\">全屏查看</text>\n    </view>\n  </view>\n</template>\n\n<script>\n  // hljs是由 Highlight.js 经兼容性修改后的文件，请勿直接升级。否则会造成uni-app-vue3-Android下有兼容问题\n  import hljs from \"@/uni_modules/uni-im/sdk/utils/highlight/highlight-uni.min.js\";\n  \n  import uniIm from '@/uni_modules/uni-im/sdk/index.js';\n  \n  // 初始化 MarkdownIt库\n  const MarkdownIt = uniIm.utils.markdownIt;\n  const markdownIt = MarkdownIt({\n    // 在源码中启用 HTML 标签\n    html: true,\n    // 如果结果以 <pre ... 开头，内部包装器则会跳过。\n    highlight: function (str, language) {\n      // 把tab换成两个空格\n      str = str.replace(/\\t/g, '  ')\n      // 经过highlight.js处理后的html\n      let preCode = \"\"\n      try {\n        preCode = hljs.highlightAuto(str).value\n      } catch (err) {\n        // console.log('err',err);\n        preCode = markdownIt.utils.escapeHtml(str);\n      }\n      // console.log('preCode',preCode);\n      // 以换行进行分割\n      const lines = preCode.split(/\\n/).slice(0, -1)\n      // 添加自定义行号\n      let html = lines.map((item, index) => {\n        // 去掉空行\n        if (item == '') {\n          return ''\n        }\n        const style = `transform: translateX(${lines.length > 99?10:0}px);height:20px;line-height: 20px;`\n        return `<li style=\"${style}\"><span class=\"line-num\" data-line=\"${index + 1}\"></span>${item}</li>`\n      }).join('')\n      html = '<ol>' + html + '</ol>'\n\n      let htmlCode = `<div>`\n      htmlCode += `<pre class=\"hljs\" style=\"padding-bottom:${uniIm.isWidescreen?15:0}px;overflow: auto;display: block;\"><code>${html}</code></pre>`;\n      htmlCode += '</div>'\n      return htmlCode\n    }\n  })\n  \n  export default {\n    computed: {\n      ...uniIm.mapState(['isWidescreen']),\n      code(){\n        return this.msg.body || ''\n      }\n    },\n    data() {\n      return {\n        nodes: [],\n        language: '',\n        // #ifdef APP-NVUE\n        webViewHeight: \"100px\",\n        // #endif\n        htmlString: '',\n        overflow: false,\n        boxHeight: '20px'\n      }\n    },\n    props: {\n      msg: {\n        type: Object,\n        default () {\n          return {}\n        }\n      },\n      showFullBtn: {\n        type: Boolean,\n        default: true\n      }\n    },\n    watch: {\n      code: {\n        handler(code, oldValue) {\n          // console.log('code',code);\n          // 判断markdown中代码块标识符的数量是否为偶数\n          this.htmlString = markdownIt.render(\"``` \\n\\n\" + code + \" \\n\\n ```\")\n          // console.log('this.htmlString',this.htmlString);\n          // #ifdef APP-NVUE\n          this.setWebViewConetnt(this.htmlString)\n          // #endif\n\n          // #ifndef APP-NVUE\n          this.nodes = this.htmlString\n          // #endif\n          \n          const codeLine = this.code.split(/\\n/).slice(0, -1).filter(item=>item).length + 1\n          let height = codeLine * 20\n          this.webViewHeight = height + 'px'\n          const maxHeight = 200\n          if (height > maxHeight) {\n            this.overflow = true\n            this.boxHeight = maxHeight + 'px'\n          }else{\n            this.boxHeight = height + 'px'\n          }\n        },\n        immediate: true\n      }\n    },\n    mounted() {},\n    methods: {\n      // #ifdef APP-NVUE\n      setWebViewConetnt() {\n        if (this.$refs.web) {\n          // console.log('this.htmlString',this.htmlString);\n          this.$refs.web.evalJs(`setHtml(${JSON.stringify(this.htmlString)})`)\n        }\n      },\n      onWebViewMsg(e) {\n        let [data] = e.detail.data\n        if (data.action == 'onJSBridgeReady') {\n          this.setWebViewConetnt()\n        }\n      },\n      // #endif\n      copyCode(e) {\n        uni.setClipboardData({\n          data: this.code,\n          showToast: false,\n          success() {\n            uni.showToast({\n              title: '复制成功',\n              icon: 'none'\n            });\n          }\n        })\n      },\n      toCodePage() {\n        uni.navigateTo({\n          url: '/uni_modules/uni-im/pages/common/view-code-page/view-code-page?msgId=' + this.msg._id + '&conversationId=' + this.msg.conversation_id\n        })\n      },\n      trOnclick(e) {\n        console.log('e', e);\n      }\n    }\n  }\n\n</script>\n\n<style lang=\"scss\">\n  /* #ifndef APP-NVUE */\n  @import '@/uni_modules/uni-im/sdk/utils/highlight/github-dark.min.scss';\n  /* #endif */\n  \n  .code-view-root {\n    flex: 1;\n    border-radius: 3px;\n    background-color: #0d1117;\n    /* #ifndef APP-NVUE */\n    width: 100%;\n    /* #endif */\n  }\n  \n  .copy-btn-box {\n    font-size: 12px;\n    top: 0px;\n    flex-direction: row;\n    justify-content: space-between;\n    align-items: flex-end;\n    padding:5px;\n  }\n  .language {\n    color: #888;\n  }\n  .copy-btn {\n    font-size: 12px;\n    padding: 0 5px;\n    color: #888;\n    /* #ifdef H5 */\n    cursor: pointer;\n    /* #endif */\n  }\n  /* #ifdef H5 */\n  .copy-btn:hover {\n    color: #259939;\n  }\n  /* #endif */\n\n  .code-view-box {\n    position: relative;\n    padding: 0;\n    margin-bottom: 10px;\n    // 设置与背景一样的黑色，防止滚动条样式变化太大\n    background-color: #0d1117;\n    /* #ifndef APP-NVUE */\n    padding: 0 5px;\n    overflow: auto;\n    width: 100%;\n    /* #endif */\n    box-sizing: border-box;\n  }\n\n  /* #ifdef H5 */\n  .code-view-box * {\n    user-select: text;\n    cursor: text;\n  }\n  /* #endif */\n\n  .code-view-rich-text {\n    // flex: 1;\n    font-size: 14px;\n    border-radius: 10px;\n  }\n\n  .msg-code {\n    /* #ifdef MP */\n    width: 600rpx;\n    /* #endif */\n  }\n  \n  .show-full-btn {\n    justify-content: center;\n    align-items: center;\n    height: 30px;\n    border-top: 1px solid #30363d;\n  }\n  \n  .show-full-text {\n    margin:0 auto;\n    font-size: 12px;\n    color: #888;\n  }\n</style>","import Component from '/Users/orange/aicode/langbot/web_client/langbot-im-uniapp/uni_modules/uni-im/components/uni-im-msg/types/code.vue'\nwx.createComponent(Component)"],"names":["uniIm","hljs","uni"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;AA4BE,MAAM,aAAaA,4BAAAA,MAAM,MAAM;AAC/B,MAAM,aAAa,WAAW;AAAA;AAAA,EAE5B,MAAM;AAAA;AAAA,EAEN,WAAW,SAAU,KAAK,UAAU;AAElC,UAAM,IAAI,QAAQ,OAAO,IAAI;AAE7B,QAAI,UAAU;AACd,QAAI;AACF,gBAAUC,uDAAI,GAAC,cAAc,GAAG,EAAE;AAAA,IAClC,SAAO,KAAK;AAEZ,gBAAU,WAAW,MAAM,WAAW,GAAG;AAAA,IAC3C;AAGA,UAAM,QAAQ,QAAQ,MAAM,IAAI,EAAE,MAAM,GAAG,EAAE;AAE7C,QAAI,OAAO,MAAM,IAAI,CAAC,MAAM,UAAU;AAEpC,UAAI,QAAQ,IAAI;AACd,eAAO;AAAA,MACT;AACA,YAAM,QAAQ,yBAAyB,MAAM,SAAS,KAAG,KAAG,CAAC;AAC7D,aAAO,cAAc,KAAK,uCAAuC,QAAQ,CAAC,YAAY,IAAI;AAAA,KAC3F,EAAE,KAAK,EAAE;AACV,WAAO,SAAS,OAAO;AAEvB,QAAI,WAAW;AACf,gBAAY,2CAA2CD,4BAAAA,MAAM,eAAa,KAAG,CAAC,4CAA4C,IAAI;AAC9H,gBAAY;AACZ,WAAO;AAAA,EACT;CACD;AAED,MAAK,YAAU;AAAA,EACb,UAAU,iCACLA,kCAAM,SAAS,CAAC,cAAc,CAAC,IAD1B;AAAA,IAER,OAAM;AACJ,aAAO,KAAK,IAAI,QAAQ;AAAA,IAC1B;AAAA,EACD;AAAA,EACD,OAAO;AACL,WAAO;AAAA,MACL,OAAO,CAAE;AAAA,MACT,UAAU;AAAA,MAIV,YAAY;AAAA,MACZ,UAAU;AAAA,MACV,WAAW;AAAA,IACb;AAAA,EACD;AAAA,EACD,OAAO;AAAA,IACL,KAAK;AAAA,MACH,MAAM;AAAA,MACN,UAAW;AACT,eAAO,CAAC;AAAA,MACV;AAAA,IACD;AAAA,IACD,aAAa;AAAA,MACX,MAAM;AAAA,MACN,SAAS;AAAA,IACX;AAAA,EACD;AAAA,EACD,OAAO;AAAA,IACL,MAAM;AAAA,MACJ,QAAQ,MAAM,UAAU;AAGtB,aAAK,aAAa,WAAW,OAAO,aAAa,OAAO,WAAW;AAOnE,aAAK,QAAQ,KAAK;AAGlB,cAAM,WAAW,KAAK,KAAK,MAAM,IAAI,EAAE,MAAM,GAAG,EAAE,EAAE,OAAO,UAAM,IAAI,EAAE,SAAS;AAChF,YAAI,SAAS,WAAW;AACxB,aAAK,gBAAgB,SAAS;AAC9B,cAAM,YAAY;AAClB,YAAI,SAAS,WAAW;AACtB,eAAK,WAAW;AAChB,eAAK,YAAY,YAAY;AAAA,eAC1B;AACH,eAAK,YAAY,SAAS;AAAA,QAC5B;AAAA,MACD;AAAA,MACD,WAAW;AAAA,IACb;AAAA,EACD;AAAA,EACD,UAAU;AAAA,EAAE;AAAA,EACZ,SAAS;AAAA,IAeP,SAAS,GAAG;AACVE,oBAAAA,MAAI,iBAAiB;AAAA,QACnB,MAAM,KAAK;AAAA,QACX,WAAW;AAAA,QACX,UAAU;AACRA,wBAAAA,MAAI,UAAU;AAAA,YACZ,OAAO;AAAA,YACP,MAAM;AAAA,UACR,CAAC;AAAA,QACH;AAAA,OACD;AAAA,IACF;AAAA,IACD,aAAa;AACXA,oBAAAA,MAAI,WAAW;AAAA,QACb,KAAK,0EAA0E,KAAK,IAAI,MAAM,qBAAqB,KAAK,IAAI;AAAA,OAC7H;AAAA,IACF;AAAA,IACD,UAAU,GAAG;AACXA,oBAAY,MAAA,MAAA,OAAA,kEAAA,KAAK,CAAC;AAAA,IACpB;AAAA,EACF;AACF;;;;;;;;;;;;;;;;;;;;;ACjKF,GAAG,gBAAgB,SAAS;"}