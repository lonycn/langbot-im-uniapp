{"version":3,"file":"uni-im-conversation-list.js","sources":["uni_modules/uni-im/components/uni-im-conversation-list/uni-im-conversation-list.vue","/Users/orange/aicode/langbot/web_client/langbot-im-uniapp/uni_modules/uni-im/components/uni-im-conversation-list/uni-im-conversation-list.vue?type=component"],"sourcesContent":["<template>\n<view class=\"uni-im-conversation-list\">\n  <view class=\"conversation-type\">\n    <view class=\"item\" v-for=\"(item,index) in conversation.typeList\" :key=\"index\" @click=\"changeType(item.value)\" :class=\"{'active':activeTypeId === item.value}\">\n      {{item.title}}\n    </view>\n  </view>\n  <scroll-view\n    ref=\"conversation-list\"\n    class=\"conversation-list\"\n    :class=\"{canCheck}\"\n    :scroll-top=\"listScrollTop\"\n    scroll-y=\"true\"\n    @scrolltolower=\"conversation.loading ? '' : loadMore()\"\n    @scroll=\"onScroll\"\n  >\n    <view v-for=\"(item,index) in conversationList\" :key=\"item.id\"\n      class=\"conversation-list-item\" :class=\"{'activeConversation':activeConversationId == item.id,'focus':focusConversationId === item.id}\"\n    >\n      <uni-im-conversation\n        :conversation=\"item\" :id=\"item.id\"\n        @click=\"clickItem(item)\" @contextmenu.prevent=\"openConversationMenu($event,index)\"\n        @longpress=\"onScroll.isScrolling?'':openConversationMenu($event,index)\"\n      >\n        <template v-if=\"canCheck\" #left>\n          <view style=\"justify-content: center;\">\n            <view class=\"check-box\" :class=\"{checked:isCheck(item)}\">\n              <uni-icons\n                v-if=\"isCheck(item)\"\n                color=\"#FFF\"\n                type=\"checkmarkempty\"\n              />\n            </view>\n          </view>\n        </template>\n      </uni-im-conversation>\n    </view>\n    <view style=\"margin-top: 5px;backgroundColor:'#f5f5f5'\">\n      <template v-if=\"!keyword\">\n        <uni-im-load-state\n          :content-text=\"loadMoreContentText\"\n          :status=\"conversation.hasMore?'loading':'noMore'\"\n        />\n      </template>\n      <text v-else-if=\"conversationList.length === 0\"\n        style=\"text-align: center;flex: 1;margin: 8px;color: #aaa;\"\n      >没有相关数据</text>\n    </view>\n\n  </scroll-view>\n\n  <uni-im-contextmenu ref=\"uni-im-contextmenu\" />\n\t<view v-if=\"isWidescreen && activeTypeId === 'has_remind_msg'\" class=\"foot-box\" @click=\"showCallMeConversationList\">\n\t\t<uni-icons class=\"left-icon\" type=\"calendar\" color=\"#888\" size=\"20\"></uni-icons>\n\t\t<text>查看历史@消息</text>\n\t\t<uni-icons class=\"right-icon\" type=\"right\"></uni-icons>\n\t</view>\n</view>\n</template>\n\n<script>\nimport uniIm from '@/uni_modules/uni-im/sdk/index.js';\nconst db = uniCloud.database();\nlet currentScrollTop = 0;\nexport default {\n  emits: ['change', 'clickItem', 'onScroll', 'update:checkedList'],\n  props: {\n    keyword: {\n      type: String,\n      default: ''\n    },\n    activeConversationId: {\n      type: [String, Boolean],\n      default: ''\n    },\n    canCheck: {\n      type: Boolean,\n      default: false\n    },\n    checkedList: {\n      type: Array,\n      default: () => []\n    }\n  },\n  data() {\n    return {\n      listScrollTop: 0,\n      focusConversationId: '',\n      activeTypeId: 'all'\n    }\n  },\n  computed: {\n\t\t...uniIm.mapState(['isWidescreen','conversation']),\n    loadMoreContentText() {\n      return {\n        contentrefresh: \"正在加载...\",\n        contentnomore: (this.conversationList.length ? \"没有更多数据了\" : \"没有会话数据\")\n      }\n    },\n    conversationList() {\n\t\t\tconst action = uniIm.conversation.typeList.reduce((acc, item)=>{\n\t\t\t\tacc[item.value] = item.filter\n\t\t\t\treturn acc\n\t\t\t},{})\n\t\t\tconst needKeepType = uniIm.conversation.typeList.filter(i=>i.needKeep).map(i=>i.value)\n\t\t\t// console.log('action',action)\n      const conversationList = uniIm.conversation.dataList\n        // #ifdef H5\n        .filter(i => i.title?.toLowerCase().includes(this.keyword.toLowerCase()))\n        // #endif\n        .filter(i => !i.hidden)\n        .filter(conversation=>{\n          if(typeof this.activeTypeId === 'object' && Object.keys(this.activeTypeId)[0] === 'group_type'){\n            return conversation.group?.type === this.activeTypeId.group_type\n          }else{\n            return action[this.activeTypeId]?.(conversation) || this.needKeepCid?.includes(conversation.id)\n          }\n        })\n        if (needKeepType.includes(this.activeTypeId)) {\n          this.needKeepCid = conversationList?.map(i=>i.id)\n        }\n        return conversationList\n    }\n  },\n  watch: {\n\t\t// 如果切换了会话类型，需要清空needKeepCid\n\t\tactiveTypeId(){\n\t\t\tthis.needKeepCid = []\n\t\t},\n    conversationList: {\n      handler() {\n        // console.log('更新会话列表',this.conversationList)\n        this.$emit('change', this.conversationList)\n      },\n      deep: true\n    },\n    activeConversationId(activeConversationId) {\n      // #ifdef H5\n      // 重试次数\n      let tryIndex = 0\n      const scrollToCurrentConversation = () => {\n        if (!activeConversationId || tryIndex > 5) {\n          return\n        }\n        const query = uni.createSelectorQuery().in(this);\n        query.select('#' + activeConversationId).boundingClientRect(data => {\n          if (!data) {\n            // console.log('找不到 showMsgByIndex #'+activeConversationId,'tryIndex:'+tryIndex);\n            tryIndex++\n            setTimeout(() => scrollToCurrentConversation(), 300)\n            return\n          } else {\n            // console.log(data);\n          }\n          let listHeight = document.querySelector('.conversation-list')?.clientHeight\n          if (data.top - 70 < listHeight) {\n            return\n          }\n          this.listScrollTop = ''\n          this.$nextTick(() => {\n            this.listScrollTop = currentScrollTop - listHeight + data.top + data.height\n            // console.log('this.listScrollTop',this.listScrollTop);\n          })\n        }).exec()\n      }\n      setTimeout(() => {\n        scrollToCurrentConversation()\n      },300)\n      // #endif\n    }\n  },\n  async mounted() {\n    // 监听鼠标移入conversation-type 后滚动事件，并设置滚动条位置\n    // #ifdef H5\n    const tagBox = this.$el.querySelector('.conversation-type')\n    function scrollFunc(e) {\n      tagBox.scrollLeft += e.deltaY/5\n    }\n    tagBox.addEventListener('mouseover', (e) => {\n      tagBox.addEventListener('wheel', scrollFunc)\n    })\n    tagBox.addEventListener('mouseout', (e) => {\n      tagBox.removeEventListener('wheel', scrollFunc)\n    })\n    // #endif\n  },\n  methods: {\n\t\tshowCallMeConversationList(){\n\t\t\tuniIm.ext.showCallMeConversationList = true\n\t\t},\n    changeType(tagId){\n      this.activeTypeId = tagId\n      uniIm.conversation.hasMore = true\n      uniIm.conversation.loadMore.type = tagId\n      this.listScrollTop = ''\n      this.$nextTick(()=>{\n        this.listScrollTop = 0\n      })\n      this.loadMore()\n    },\n    onScroll(e) {\n      currentScrollTop = e.detail.scrollTop\n      this.$emit('onScroll', e)\n      // 设置 this.onScroll.isScrolling 为 true\n      this.onScroll.isScrolling = true\n      clearTimeout(this.onScroll.timer)\n      this.onScroll.timer = setTimeout(() => {\n        // 设置 this.onScroll.isScrolling 为 false\n        this.onScroll.isScrolling = false\n      }, 500)\n    },\n    isCheck(item) {\n      return this.checkedList.some(i => i.id === item.id)\n    },\n    clickItem(item) {\n      if (this.canCheck) {\n        // 判断是否选中\n        let checkedList = this.checkedList;\n        if (this.isCheck(item)) {\n          checkedList.splice(checkedList.findIndex(i => i.id === item.id), 1)\n        } else {\n          checkedList.push(item)\n        }\n        this.$emit('update:checkedList', checkedList)\n      }\n      this.$emit('clickItem', item)\n    },\n    openConversationMenu(e, index) {\n      let conversation = this.conversationList[index]\n      this.focusConversationId = conversation.id\n      const myContextmenu = this.$refs['uni-im-contextmenu']\n      \n      const clientY = e.clientY || e.changedTouches[0].clientY\n      const clientX = e.clientX || e.changedTouches[0].clientX\n      \n      const position = {\n        \"top\": clientY + 35,\n        \"left\": clientX\n      }\n      let menuList = [{\n                        \"title\": conversation.pinned ? \"取消置顶\" : \"置顶\",\n                        \"action\": () => {\n                          conversation.pinned = !conversation.pinned\n                          db.collection('uni-im-conversation')\n                            .doc(conversation._id)\n                            .update({\n                              \"pinned\": conversation.pinned\n                            })\n                            .then((e) => {\n                              console.log('updated 置顶', e.result.updated, conversation._id)\n                            })\n                            .catch(() => {\n                              uni.showToast({\n                                title: '服务端错误，置顶失败，请稍后重试',\n                                icon: 'none'\n                              });\n                              conversation.pinned = !conversation.pinned\n                            })\n                        }\n                      },\n                      {\n                        \"title\": \"标为\" + (conversation.unread_count ? \"已读\" : \"未读\"),\n                        \"action\": () => {\n                          conversation.setUnreadCount(conversation.unread_count ? 0 : 1)\n                        }\n                      },\n                      {\n                        \"title\": (conversation.is_star ? \"取消\" : \"设为\") + \"星标\",\n                        \"action\": () => {\n                          conversation.changeIsStar()\n                        }\n                      },\n                      {\n                        \"title\": conversation.mute ? \"允许消息通知\" : \"消息免打扰\",\n                        \"action\": () => {\n                          console.log('mute 允许消息通知 / 消息免打扰')\n                          conversation.changeMute()\n                        }\n                      },\n                      // {\n                      //   \"title\":\"复制会话id\",\n                      //   \"action\":()=>{\n                      //      uni.setClipboardData({\n                      //        data:conversation.id,\n                      //        showToast:false\n                      //      })\n                      //   }\n                      // },\n                      {\n                        \"title\": \"移除会话\",\n                        \"action\": () => conversation.hide()\n                      }\n      ]\n      myContextmenu.show(position, menuList)\n      myContextmenu.onClose(() => {\n        this.focusConversationId = ''\n      })\n    },\n    closeConversationMenu(){\n      const myContextmenu = this.$refs['uni-im-contextmenu']\n      myContextmenu.closeMe()\n    },\n    async loadMore() {\n      let data = await uniIm.conversation.loadMore()\n      // console.log('加载到新的会话数据',data);\n      return data\n    }\n  }\n}\n</script>\n\n<style lang=\"scss\">\n  .uni-im-conversation-list{\n    height: 0;\n    flex: 1;\n    overflow: hidden;\n    /* #ifdef MP-WEIXIN */\n    height: 100%;\n    /* #endif */\n    .conversation-type {\n      margin: 0 10px;\n      flex-direction: row;\n      overflow: scroll;\n      // 滚动条样式，高度设置\n      &::-webkit-scrollbar {\n        width: 0;\n        height: 0;\n      }\n      .item {\n\t\t\t\tfont-size: 16px;\n        color: #333;\n        text-align: center;\n        padding: 5px 0;\n        margin:0 15px;\n        cursor: pointer;\n        &.active {\n          color: #1ab94e;\n          border-bottom: 2px solid #1ab94e;\n        }\n      }\n    }\n    .conversation-list{\n      height:0;\n      flex: 1;\n    }\n    .tip {\n      flex: 1;\n    }\n    \n    .canCheck  {\n      .note-box,\n      .time,\n      .state {\n        display: none;\n      }\n      .title {\n        font-size: 16px !important;\n      }\n    }\n    \n    .conversation-list {\n      .conversation-list-item {\n        border-radius: 5px;\n        overflow: hidden;\n        &.focus \n        {\n          border: 2px solid #1ab94e;\n        }\n        &.activeConversation {\n          background-color: #f1f1f1;\n        }\n      }\n    }\n    \n    .check-box {\n      border: 1px solid #ccc;\n      width: 20px;\n      height: 20px;\n      border-radius: 2px;\n      margin-right: 10px;\n    }\n    \n    .check-box.checked {\n      background-color: #00a953;\n      border-color: #00a953;\n    }\n\t\t\n\t\t.foot-box {\n\t\t\tpadding: 0 15px;\n\t\t\tflex-direction: row;\n\t\t\theight: 40px;\n\t\t\tjustify-content: center;\n\t\t\talign-items: center;\n\t\t\tbackground-color: rgba(0, 0, 0, 0.03);\n\t\t\tborder-radius: 10px;\n\t\t\tmargin: 10px;\n\t\t\tcolor: #555;\n\t\t\t/* #ifdef H5 */\n\t\t\t&:hover {\n\t\t\t\tbackground-color: #EEE;\n\t\t\t\tcursor: pointer;\n\t\t\t}\n\t\t\t/* #endif */\n\t\t\t.right-icon {\n\t\t\t\tmargin-left: auto;\n\t\t\t}\n\t\t\t.left-icon {\n\t\t\t\tmargin-left: auto;\n\t\t\t\tmargin-right: 5px;\n\t\t\t}\n\t\t}\n  }\n</style>","import Component from '/Users/orange/aicode/langbot/web_client/langbot-im-uniapp/uni_modules/uni-im/components/uni-im-conversation-list/uni-im-conversation-list.vue'\nwx.createComponent(Component)"],"names":["uniCloud","uniIm","e","uni"],"mappings":"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"}