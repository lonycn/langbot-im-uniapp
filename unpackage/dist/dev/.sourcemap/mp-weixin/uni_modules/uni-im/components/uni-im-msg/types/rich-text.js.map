{"version":3,"file":"rich-text.js","sources":["uni_modules/uni-im/components/uni-im-msg/types/rich-text.vue","/Users/orange/aicode/langbot/web_client/langbot-im-uniapp/uni_modules/uni-im/components/uni-im-msg/types/rich-text.vue?type=component"],"sourcesContent":["<template>\n  <view class=\"uni-im-rich-text\"\n    :class=\"{'isFromSelf':isFromSelf, 'only1u': trBody.length === 0 &&webInfoList.length === 1 , isSingeImg}\">\n\t\t<template v-for=\"(item,index) in trBody\" :key=\"index\">\n      <template v-if=\"item.name == 'span'\">\n        <text v-if=\"item.attrs && item.attrs.class == 'nickname'\" class=\"text nickname\"\n          :class=\"{'pointer':canPrivateChat,'isCallMe':item.attrs.user_id == currentUid}\"\n          @click=\"privateChat(item.attrs.user_id)\"\n        >\n          {{item.children[0].text}}\n        </text>\n        <text v-else class=\"text\">\n          {{item.children[0].text}}\n        </text>\n        <uni-im-icons class=\"text read-state\" v-if=\"isFromSelf && 'isRead' in item\" \n          :class=\"{isRead:item.isRead}\" :code=\"item.isRead?'e609':'e741'\"\n          :size=\"item.isRead?'12px':'10px'\" :color=\"item.isRead?'#25882a':'#bbb'\"></uni-im-icons>\n      </template>\n      <text class=\"text\" v-else-if=\"item.type == 'text'\" :decode=\"true\" space=\"ensp\">{{trText(item.text)}}</text>\n      <uni-im-img v-else-if=\"item.name == 'img'\" :max-width=\"imgMaxWidth\" @click=\"previewImage(item.attrs.src)\"\n        :src=\"item.attrs.src\" :width=\"item.attrs.width\" :height=\"item.attrs.height\" mode=\"widthFix\" class=\"img\" />\n\t\t\t<template  v-else-if=\"item.name == 'a' && item.children && typeof(item.children[0]) === 'object'\">\n\t\t\t\t<!-- 判断是否为应用内链接 -->\n\t\t\t\t<text class=\"app-link\" @click=\"toAppLink(item.attrs.href)\" v-if=\"isAppLink(item)\">{{item.children[0].text}}</text>\n\t\t\t\t<uni-link v-else class=\"link\" :href=\"item.attrs.href\" color=\"#007fff\" :text=\"item.children[0].text\"></uni-link>\n\t\t\t</template>\n     \n    </template>\n\n\n    <!-- <view class=\"web-info\" v-for=\"(item,index) in webInfoList\" :key=\"index\">\n        <view class=\"title-box\">\n          <image v-if=\"item.icon\" :src=\"item.icon\" mode=\"widthFix\" class=\"web-icon\" @error=\"item.icon = false\" />\n          <view v-if=\"item.title\" class=\"title\">{{item.title}}</view>\n        </view>\n        <view class=\"content\">\n          <view v-if=\"item.description\" class=\"description\">{{item.description}}</view>\n          <image v-if=\"item.thumbnail\" class=\"web-thumbnail\" :src=\"item.thumbnail\" mode=\"widthFix\"\n            @error=\"item.thumbnail = false\" />\n        </view>\n        <view class=\"link-box\" v-if=\"item.url\">\n          <uni-link class=\"link\" :href=\"item.url\" color=\"#007fff\" :text=\"item.url\"></uni-link>\n          <uni-im-icons @click=\"copy(item.url)\" class=\"copy\" code=\"e67e\"></uni-im-icons>\n        </view>\n      </view> -->\n  </view>\n</template>\n\n<script>\n  import uniIm from '@/uni_modules/uni-im/sdk/index.js';\n\timport config from '@/uni_modules/uni-im/common/config.js';\n  export default {\n    props: {\n      msg: {\n        type: Object,\n        default: () => {\n          return {\n            reader_list: [],\n            body: []\n          }\n        }\n      },\n\t\t\timgMaxWidth: {\n        type: [String, Number],\n        default: '200px'\n      }\n    },\n    data() {\n      return {\n        webInfoList: []\n      }\n    },\n    async mounted() {\n      // let aList = this.msg.body.filter(item => item.name == 'a')\n      //                           // .filter(item => {\n      //                           //   return item.attrs && item.attrs.href &&\n      //                           //    item.attrs.href.includes('dcloud.net.cn') ||\n      //                           //    item.attrs.href.includes('dcloud.io')\n      //                           // })\n      // // console.log('aList',aList)\n      // for(let i = 0; i < aList.length; i++){\n      //   const uniImCo = uniCloud.importObject(\"uni-im-co\",{customUI:true})\n      //   let res = await uniImCo.getWebInfo(aList[i].attrs.href)\n      //   // console.log('getWebInfo',res.data)\n      //   res.data.url = aList[i].attrs.href\n      //   if(res.data.title){\n      //     res.data.title = getStr(res.data.title, 60)\n      //     res.data.description = getStr(res.data.description, 60)\n      //   // // 取字符串的前20个字符，如果超出加...\n      //    function getStr(str='', len) {\n      //      if (str.length > len) {\n      //        return str.substring(0, len) + \"...\";\n      //      } else {\n      //        return str;\n      //      }\n      //    }\n      //     this.webInfoList.push(res.data)\n      //   }\n      // }\n    },\n    computed: {\n      currentUid() {\n        return uniIm.currentUser._id\n      },\n      isSingeImg() {\n        return this.msg.body.filter(item => item.name != 'img' && item.text || item?.attrs?.class === \"nickname\" ).length === 0\n      },\n      imgList() {\n        return this.msg.body.filter(item => item.name == 'img').map(item => item.attrs.src)\n      },\n      isFromSelf() {\n        return this.msg.from_uid === this.currentUid\n      },\n      trBody() {\n        if (\n          this.webInfoList.length === 1 &&\n          this.msg.body.filter(i => !(i.type === 'text' && i.text === ' ')).length === 1 &&\n          this.webInfoList[0].url === this.msg.body[0].attrs.href\n        ) {\n          // 只有一个链接，且链接的地址和消息体的地址一样，则不显示消息体\n          return []\n        } else {\n          return this.msg.body.map(node => {\n            if (node.name == 'span' && node.attrs && node.attrs.class == 'nickname' && node.attrs.user_id) {\n              // 改写/设置 nickname\n              node.children = [{\n                type: 'text',\n                text: '@' + this.getNicknameByUid(node.attrs.user_id)\n              }]\n              if(node.attrs.user_id == '__ALL'){\n                delete node.isRead\n              }else{\n                // 设置是否已读\n                node.isRead = this.msg.reader_list ? this.msg.reader_list.find(item => item.user_id == node.attrs.user_id) : false\n              }\n            }\n            return node\n          })\n        }\n      },\n      canPrivateChat() {\n        if(this.uniIDHasRole('staff')){\n          return true\n        }\n        const {conversation_id,from_uid} = this.msg\n        const {group_member} = uniIm.conversation.find(conversation_id)\n        return group_member ? group_member.find(from_uid)?.role.includes('admin') : false\n      }\n    },\n    methods: {\n      trText(str) {\n        // TODO：临时方案，解决 \\n 被转义的问题\n        return str.replace(/\\\\n/g, \"\\\\\\\\n\")\n      },\n      getNicknameByUid(uid) {\n        if(uid === \"__ALL\"){\n          return \"所有人\"\n        }\n        return uniIm.users.getNickname(uid);\n      },\n      async previewImage(src) {\n        const urls = []\n        for (let i = 0; i < this.imgList.length; i++) {\n          const url = await uniIm.utils.getTempFileURL(this.imgList[i])\n          urls.push(url)\n        }\n        src = await uniIm.utils.getTempFileURL(src)\n        uni.previewImage({\n          urls,\n          current: src\n        })\n      },\n      copy(text) {\n        uni.setClipboardData({\n          data: text,\n          success: () => {\n            uni.showToast({\n              title: '复制成功',\n              icon: 'none'\n            })\n          }\n        })\n      },\n      privateChat(user_id) {\n        if (this.canPrivateChat &&  user_id != '__ALL') {\n          uniIm.toChat({\n            user_id,\n            source:{\n              group_id: this.msg.group_id\n            }\n          })\n        }\n      },\n\t\t\tisAppLink(item){\n\t\t\t\t// console.log('config.domain',config.domain)\n\t\t\t\t// console.error(item.attrs.href.split('?'))\n\t\t\t\t// 判断是否为应用内链接\n\t\t\t\treturn item.attrs.href.indexOf(config.domain) === 0\n\t\t\t},\n\t\t\ttoAppLink(url){\n\t\t\t\t// 拿到链接的参数\n\t\t\t\tconst params = url.split('?')[1]\n\t\t\t\t// 拿到链接的路径\n\t\t\t\tlet path = url.split('?')[0].split(config.domain + '/#/')[1]\n\t\t\t\tconsole.log('path',path)\n\t\t\t\tif (path === ''){\n\t\t\t\t\tpath = '/uni_modules/uni-im/pages/index/index'\n\t\t\t\t}\n\t\t\t\t// 跳转到对应的页面\n\t\t\t\tuni.redirectTo({\n\t\t\t\t\turl: path + '?' + params,\n\t\t\t\t\tfail: (err) => {\n\t\t\t\t\t\tconsole.log('跳转失败',err)\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t\n\t\t\t}\n    }\n  }\n</script>\n\n<style lang=\"scss\">\n.uni-im-rich-text {\n  // todo: 由于web端首页引入的sass热更新不能影响组件样式，导致baseStyle.scss的样式使用了 deep，导致这里需要加 !important\n  display: inline-block!important;\n  background-color: #fff;\n  padding:5px 10px;\n  border-radius: 10px;\n  max-width: 100%;\n  &.isFromSelf {\n    background-color: #c9e7ff;\n  }\n  /* #ifdef H5 */\n  @media screen and (min-device-width:960px) {\n    .img {\n      max-width: 480px !important;\n    }\n  }\n  .pointer {\n    cursor: pointer !important;\n  }\n  /* #endif */\n  \n  .text {\n    word-break: break-all;\n    cursor: text;\n    /* #ifdef H5 */\n    @media screen and (min-device-width:960px){\n      user-select: text;\n    }\n    /* #endif */\n  }\n  \n  .app-link,.link {\n    display: inline;\n    user-select: all;\n    margin: 0 2px;\n    word-break: break-all;\n  }\n\t.app-link {\n\t\tcolor: #0080ff;\n\t\t// 加下划线\n\t\ttext-decoration: underline;\n\t}\n  \n  .only1u {\n    padding: 0;\n    .web-info {\n      margin-top: 0;\n    }\n  }\n  \n  .img {\n    margin: 5px 0 !important;\n    /* #ifdef H5 */\n    display: block !important;\n    box-shadow: #eee 0 0 5px;\n    cursor: pointer;\n    /* #endif */\n  }\n  \n   .nickname {\n    color: #0b65ff;\n    padding: 1px 4px;\n    font-size: 14px;\n  }\n  .isCallMe {\n    color: #FFF;\n    background-color: #0080ff;\n    border-radius: 5px;\n    margin-right: 4px;\n  }\n  \n   .read-state {\n    position: relative;\n    top: -5px;\n    \n  }\n  \n  .isSingeImg {\n    background-color: transparent !important;\n    padding: 0;\n  }\n  \n  .web-info {\n    background-color: #FFF;\n    padding: 10px;\n    border-radius: 10px;\n    margin-top: 10px;\n    border: 1px solid #eee;\n    .title-box {\n      flex-direction: row;\n      .web-icon {\n        width: 16px;\n        height: 16px;\n        margin: 4px 5px 0 0;\n      }\n    }\n    .title {\n      font-size: 16px;\n      flex: 1;\n      font-weight: bold;\n    }\n    .content {\n      flex-direction: row;\n      .description {\n        font-size: 14px;\n        color: #666;\n        margin-top: 5px;\n        flex: 1;\n        beak-word: break-all;\n      }\n      .web-thumbnail {\n        height: 100px;\n        width: 100px;\n        margin: 5px;\n      }\n    }\n    .link-box {\n      flex-direction: row;\n      border-top: 1px solid #eee;\n      padding-top: 5px;\n      justify-content: space-between;\n      align-items: flex-end;\n      .link {\n        font-size: 12px;\n        // 不会换行\n        white-space: nowrap;\n        flex: 1;\n        overflow: hidden;\n      }\n      .copy {\n        opacity: 0.5;\n        margin-left: 20px;\n        &:hover {\n          opacity: 0.8;\n        }\n      }\n    }\n  }\n}\n</style>","import Component from '/Users/orange/aicode/langbot/web_client/langbot-im-uniapp/uni_modules/uni-im/components/uni-im-msg/types/rich-text.vue'\nwx.createComponent(Component)"],"names":["uniIm","uni","config"],"mappings":"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"}