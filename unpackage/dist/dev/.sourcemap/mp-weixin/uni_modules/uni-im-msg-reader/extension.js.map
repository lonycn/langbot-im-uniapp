{"version":3,"file":"extension.js","sources":["uni_modules/uni-im-msg-reader/components/uni-im-msg-reader/uni-im-msg-reader.vue","uni_modules/uni-im-msg-reader/extension.js"],"sourcesContent":["<template>\n  <view v-if=\"!msg.is_revoke && !msg.revoke_ing\" :class=\"{'self':currentUid == msg.from_uid}\" class=\"uni-im-msg-reader\">\n    <text\n      v-if=\"readerList && !hiddenState\"\n      class=\"read-state\"\n      :class=\"{'active-color':unreadUserList.length || readerList.length,isGroupMsg}\"\n      @click=\"clickHandler\"\n    >\n      {{ isGroupMsg ? (isReady ? unreadUserCountTip : '') : (readerList.length?'已读':'未读') }}\n    </text>\n    \n    <!-- #ifdef H5 -->\n    <teleport to=\"body\" :disabled=\"!isWidescreen\">\n    <!-- #endif -->\n      <view\n        v-if=\"showPopup && isGroupMsg\"\n        class=\"uni-im-msg-reader-popup\"\n        @click=\"closePopup\"\n      >\n        <view\n          class=\"reader-list-box\"\n          :class=\"{'show':showTransition}\"\n          @click.stop\n        >\n          <text class=\"title\">消息接收人列表</text>\n          <uni-segmented-control class=\"segmented-control\"\n            v-if=\"!isWidescreen\"\n            :current=\"currentIndex\"\n            :values=\"[`未读(${unreadUserList.length})`, `已读(${readerList.length})`]\"\n            style-type=\"text\"\n            active-color=\"black\"\n            @clickItem=\"e => currentIndex = e.currentIndex\"\n          />\n          <view class=\"content\">\n            <view v-if=\"isWidescreen || currentIndex == 0\" class=\"reader-list\">\n              <text v-if=\"isWidescreen\" class=\"title\">\n                {{ unreadUserList.length }}人未读\n              </text>\n              <scroll-view class=\"user-list\" scroll-y>\n                <view\n                  v-for=\"(item,index) in unreadUserList\"\n                  :key=\"index\"\n                  class=\"users\"\n                >\n                  <cloud-image\n                    :src=\" item.avatar_file&&item.avatar_file.url||'/uni_modules/uni-im/static/avatarUrl.png'\"\n                    mode=\"widthFix\"\n                    width=\"36px\"\n                    height=\"36px\"\n                    border-radius=\"15px\"\n                  />\n                  <text class=\"nickname\">\n                    {{ item.nickname }}\n                  </text>\n                </view>\n              </scroll-view>\n            </view>\n            <view v-if=\"isWidescreen || currentIndex == 1\" class=\"reader-list\">\n              <text v-if=\"isWidescreen\" class=\"title\">\n                {{ readerList.length }}人已读\n              </text>\n              <scroll-view class=\"user-list\" scroll-y>\n                <view\n                  v-for=\"(item,index) in readerUserlist\"\n                  :key=\"index\"\n                  class=\"users\"\n                >\n                  <cloud-image\n                    :src=\" item.avatar_file&&item.avatar_file.url||'/uni_modules/uni-im/static/avatarUrl.png'\"\n                    mode=\"widthFix\"\n                    width=\"36px\"\n                    height=\"36px\"\n                    border-radius=\"15px\"\n                  />\n                  <text class=\"nickname\">\n                    {{ item.nickname }}\n                  </text>\n                </view>\n              </scroll-view>\n            </view>\n          </view>\n        </view>\n      </view>\n    <!-- #ifdef H5 -->\n    </teleport>\n    <!-- #endif -->\n  </view>\n</template>\n\n<script>\nimport uniIm from '@/uni_modules/uni-im/sdk/index.js';\n/**\n * uni-im-msg-reader 组件，实现“已读反馈”功能，可在消息列表中每条消息的下方显示已读信息。\n */\nexport default {\n  name: 'UniImMsgReader',\n  props: {\n    msg: {\n      type: Object,\n      default: () => {}\n    },\n    hiddenState: {\n      type: Boolean,\n      default: false\n    }\n  },\n  data() {\n    return {\n      showPopup: false,\n      showTransition: false,\n      conversation: {},\n      currentIndex: 0\n    }\n  },\n  // 计算属性\n  computed: {\n    ...uniIm.mapState(['isWidescreen','systemInfo']),\n    currentUid() {\n      return uniIm.currentUser._id\n    },\n    isReady() {\n      // 群会话需要等待群成员数据，全部加载完毕\n      return !this.conversation.group?.member?.hasMore\n    },\n    memberUids() {\n      const groupMember = this.conversation.group?.member\n      if(groupMember){\n        // 成员uid不包含消息发送者\n        return groupMember.dataList.filter(item => item.users._id != this.msg.from_uid).map(item => item.users._id)\n      }else{\n        return []\n      }\n    },\n    unreadUserList() {\n      const unreadUserList = this.memberUids.filter(item => !this.readerList.find(reader => reader.user_id == item))\n      return unreadUserList.map(item => uniIm.users[item])\n    },\n    unreadUserCountTip() {\n      let unreadUserCount = this.unreadUserList.length\n      // 大于99人显示99+\n      unreadUserCount = unreadUserCount > 99 ? '99+' : unreadUserCount\n      return unreadUserCount > 0 ? `${unreadUserCount}人未读` : '全部已读'\n    },\n    isGroupMsg() {\n      return !!this.msg.group_id\n    },\n    readerList() {\n      return this.msg.reader_list || []\n    },\n    readerUserlist() {\n      return this.readerList.map(item => uniIm.users[item.user_id])\n    }\n  },\n  watch: {\n    showPopup(state) {\n      setTimeout(()=>{\n        this.showTransition = state\n      },0)\n    }\n  },\n  mounted() {\n    this.conversation = uniIm.conversation.find(this.msg.conversation_id)\n  },\n  methods: {\n    clickHandler() {\n      if(this.isGroupMsg){\n        if(uniIm.isWidescreen){\n          this.showReaderList()\n        }else {\n          \n          uni.navigateTo({\n            url: `/uni_modules/uni-im-msg-reader/pages/reader-list/reader-list?msgId=${this.msg._id}&conversationId=${this.msg.conversation_id}`,\n            // animationType: 'slide-in-bottom'\n          })\n        }\n      }\n    },\n    showReaderList() {\n      this.showPopup = true\n      // this.$refs.popup.open()\n    },\n    closePopup() {\n      this.showPopup = false\n    }\n  }\n}\n</script>\n\n<style lang=\"scss\">\n  .uni-im-msg-reader {\n    display: flex;\n    width: 100%;\n    flex: 1;\n\t\tmargin-top: 5px;\n    overflow: hidden;\n    .read-state {\n      font-size: 12px;\n      flex-direction: row;\n      color: #555;\n      width: 65px;\n      height: 16px;\n    }\n    .active-color {\n      color: #aaa;\n      &.isGroupMsg {\n        /* #ifdef H5 */\n          cursor: pointer;\n        /* #endif */\n        color: #0b65ff;\n      }\n    }\n    &.self {\n      align-items: flex-end;\n      .read-state {\n        text-align: right;\n      }\n    }\n  }\n  \n  .uni-im-msg-reader-popup {\n    height: 100%;\n    .reader-list-box {\n      width: 750rpx;\n      height: 100%;\n      .segmented-control {\n        flex-shrink: 0;\n      }\n      &>.title {\n        display: none;\n      }\n      .content {\n        height: 100%;\n        overflow: hidden;\n        .reader-list {\n          flex-direction: column;\n          overflow: hidden;\n          .title {\n            padding: 15px;\n            background-color: #FFF;\n            font-size: 20px;\n          }\n          .user-list {\n            flex: 1;\n            overflow: hidden;\n            .users {\n              flex-direction: row;\n              align-items: center;\n              padding: 10px;\n              .nickname {\n                font-size: 16px;\n                color: #333;\n                margin-left: 6px;\n                flex: 1;\n                overflow: hidden;\n                text-overflow: ellipsis;\n                /* #ifndef APP-NVUE */\n                white-space: nowrap;\n                /* #endif */\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n  /* #ifdef H5 */\n  @media screen and (min-device-width:960px) {\n    .uni-im-msg-reader-popup {\n      position: fixed !important;\n      top: 0;\n      left: 0;\n      z-index: 9999;\n      width: 100%;\n      height: 100%;\n      background-color: rgba(0, 0, 0, 0.3);\n      display: flex;\n      justify-content: center;\n      align-items: center !important;\n      .reader-list-box {\n        background-color: #fff;\n        border-radius: 10px;\n        overflow: hidden;\n        /* 显示隐藏的过度动画 */\n        transition: transform 0.1s,opacity 0.1s;\n        transform: scale(0.7);\n        opacity: 0;\n        width: 600px;\n        margin-top: 44px;\n        height: 50%;\n        flex-direction: column;\n        &.show {\n          transform: scale(1);\n          opacity: 1;\n        }\n        &>.title {\n          display: flex;\n          font-size: 18px;\n          font-weight: bold;\n          color: #333;\n          padding: 15px;\n          background-color: #f5f5f5;\n        }\n        .content {\n          flex-direction: row;\n          padding: 5px 15px;\n          .reader-list {\n            flex: 1;\n          }\n        }\n      }\n    }\n  }\n  /* #endif */\n</style>","import uniIm from '@/uni_modules/uni-im/sdk/index.js'\nimport UniImMsgReader from '@/uni_modules/uni-im-msg-reader/components/uni-im-msg-reader/uni-im-msg-reader.vue'\nfunction install() {\n  \n  // 配置在什么情况下启用已读功能\n  uniIm.extensions.installExt('msg-extra', (msg, currentUser) => {\n    // 仅限“我”发送的消息\n    if (msg.from_uid !== uniIm.currentUser._id) return\n    // 仅限内部用户\n    if (!uniIm.currentUser.role.includes('staff')) return \n    // 排除特殊消息\n    if (msg.type == 'system' || msg.is_revoke) return\n    // 仅限私聊会话\n    let conversation = uniIm.conversation.find(msg.conversation_id)\n    if (!conversation?.friend_uid) return\n    return {\n      component: UniImMsgReader,\n      props: {\n        msg\n      }\n    }\n  })\n  \n  \n  // 注册 read_msg 消息类型\n  uniIm.extensions.installExt('msg-type-register', () => {\n    return {\n      type: 'read_msg',\n\n      isReadable(msg) {\n        return false\n      },\n\n      beforeLocalAdd(msgData, conversation) {\n        let {\n          body: {\n            msgId\n          },\n          from_uid,\n          create_time,\n        } = msgData\n        // debugger\n        const msg = conversation.msg.find(msgId)\n        if (msg) {\n          let reader = {\n            user_id: from_uid,\n            create_time\n          }\n          msg.reader_list ? msg.reader_list.push(reader) : msg.reader_list = [reader]\n        }\n      },\n    }\n  })\n\n  // 监听每条消息的显示状态，报送 read_msg 消息\n  uniIm.extensions.installExt('msg-appear', msg => {\n    const currentUid = uniIm.currentUser._id\n    // 特殊消息不用处理\n    if (msg.type === 'system' || msg.is_revoke) return\n\n    // 如果是我发送的消息则不处理\n    if (msg.from_uid == currentUid) return\n\n    // 如果我已经在已读列表里则不再处理\n    if (msg.reader_list?.some(u => u.user_id == currentUid)) return\n\n    // 如果是群聊消息且没有 @我，则不用处理\n    let conversation = uniIm.conversation.find(msg.conversation_id)\n    if (conversation.group_id && !msg.call_uid?.includes(currentUid)) return\n\n    // 把自己记入已读列表\n    msg.reader_list = msg.reader_list || []\n    msg.reader_list.push({\n      user_id: currentUid,\n      create_time: Date.now()\n    })\n\n    // 向云端提交 read_msg 消息\n    const uniImCo = uniCloud.importObject('uni-im-co', {\n      customUI: true\n    })\n    uniImCo.sendMsg({\n      type: 'read_msg',\n      body: {\n        msgId: msg._id\n      }\n    }).catch(e => {\n      // 提交失败，把自己从已读列表里去掉\n      msg.reader_list = msg.reader_list.filter(u => u.user_id !== currentUid)\n    })\n  })\n}\n\nexport default {\n  install\n}"],"names":["uniIm","uni","UniImMsgReader","uniCloud"],"mappings":"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"}